<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Integrating with other tools :: Red Planet Labs Documentation</title>
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
<!-- Google tag (gtag.js) -->
<script async="" src="//cse.google.com/adsense/search/async-ads.js"></script><script type="text/javascript" async="" src="https://www.googletagmanager.com/gtag/js?id=G-6FCG0W0TYJ&amp;l=dataLayer&amp;cx=c&amp;gtm=457e53h1za200&amp;tag_exp=102482433~102587591~102717422~102788824~102813109~102814060~102825837~102879719"></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-137231341-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6FCG0W0TYJ');
</script>
  <script src="https://www.google.com/cse/static/element/75c56d121cde450a/cse_element__en.js?usqp=CAM%3D" type="text/javascript"></script><link type="text/css" href="https://www.google.com/cse/static/element/75c56d121cde450a/default+en.css" rel="stylesheet"><link type="text/css" href="https://www.google.com/cse/static/style/look/v4/default.css" rel="stylesheet"><style type="text/css">.gsc-control-cse{font-family:arial, sans-serif}.gsc-control-cse .gsc-table-result{font-family:arial, sans-serif}.gsc-refinementsGradient{background:linear-gradient(to left,rgba(255,255,255,1),rgba(255,255,255,0))}.gsc-control-cse{border-color:#1a1a1a;background-color:#1a1a1a}input.gsc-input,.gsc-input-box,.gsc-input-box-hover,.gsc-input-box-focus{border-color:#DFE1E5}.gsc-search-button-v2,.gsc-search-button-v2:hover,.gsc-search-button-v2:focus{border-color:#3079ED;background-color:#4D90FE;background-image:none;filter:none}.gsc-search-button-v2 svg{fill:#FFFFFF}.gsc-tabHeader.gsc-tabhActive,.gsc-refinementHeader.gsc-refinementhActive{color:#1A73E8;border-color:#1A73E8;background-color:#FFFFFF}.gsc-tabHeader.gsc-tabhInactive,.gsc-refinementHeader.gsc-refinementhInactive{color:#666666;border-color:#666666;background-color:#FFFFFF}.gsc-webResult.gsc-result,.gsc-results .gsc-imageResult{border-color:#FFFFFF;background-color:#FFFFFF}.gsc-webResult.gsc-result:hover{border-color:#FFFFFF;background-color:#FFFFFF}.gs-webResult.gs-result a.gs-title:link,.gs-webResult.gs-result a.gs-title:link b,.gs-imageResult a.gs-title:link,.gs-imageResult a.gs-title:link b{color:#1155CC}.gs-webResult.gs-result a.gs-title:visited,.gs-webResult.gs-result a.gs-title:visited b,.gs-imageResult a.gs-title:visited,.gs-imageResult a.gs-title:visited b{color:#1155CC}.gs-webResult.gs-result a.gs-title:hover,.gs-webResult.gs-result a.gs-title:hover b,.gs-imageResult a.gs-title:hover,.gs-imageResult a.gs-title:hover b{color:#1155CC}.gs-webResult.gs-result a.gs-title:active,.gs-webResult.gs-result a.gs-title:active b,.gs-imageResult a.gs-title:active,.gs-imageResult a.gs-title:active b{color:#1155CC}.gsc-cursor-page{color:#1155CC}a.gsc-trailing-more-results:link{color:#1155CC}.gs-webResult:not(.gs-no-results-result):not(.gs-error-result) .gs-snippet,.gs-fileFormatType{color:#333333}.gs-webResult div.gs-visibleUrl{color:#009933}.gs-webResult div.gs-visibleUrl-short{color:#009933}.gs-webResult div.gs-visibleUrl-short{display:none}.gs-webResult div.gs-visibleUrl-long{display:none}.gs-webResult div.gs-visibleUrl-breadcrumb{display:block}.gs-promotion div.gs-visibleUrl-short{display:none}.gs-promotion div.gs-visibleUrl-long{display:block}.gs-promotion div.gs-visibleUrl-breadcrumb{display:none}.gsc-cursor-box{border-color:#FFFFFF}.gsc-results .gsc-cursor-box .gsc-cursor-page{border-color:#666666;background-color:#FFFFFF;color:#666666}.gsc-results .gsc-cursor-box .gsc-cursor-current-page{border-color:#1A73E8;background-color:#FFFFFF;color:#1A73E8}.gsc-webResult.gsc-result.gsc-promotion{border-color:#FFFFFF;background-color:#F6F6F6}.gsc-completion-title{color:#1155CC}.gsc-completion-snippet{color:#333333}.gs-promotion a.gs-title:link,.gs-promotion a.gs-title:link *,.gs-promotion .gs-snippet a:link{color:#1155CC}.gs-promotion a.gs-title:visited,.gs-promotion a.gs-title:visited *,.gs-promotion .gs-snippet a:visited{color:#1155CC}.gs-promotion a.gs-title:hover,.gs-promotion a.gs-title:hover *,.gs-promotion .gs-snippet a:hover{color:#1155CC}.gs-promotion a.gs-title:active,.gs-promotion a.gs-title:active *,.gs-promotion .gs-snippet a:active{color:#1155CC}.gs-promotion .gs-snippet,.gs-promotion .gs-title .gs-promotion-title-right,.gs-promotion .gs-title .gs-promotion-title-right *{color:#333333}.gs-promotion .gs-visibleUrl,.gs-promotion .gs-visibleUrl-short{color:#009933}.gcsc-find-more-on-google{color:#1155CC}.gcsc-find-more-on-google-magnifier{fill:#1155CC}</style><style type="text/css">.gscb_a{display:inline-block;font:27px/13px arial,sans-serif}.gsst_a .gscb_a{color:#a1b9ed;cursor:pointer}.gsst_a:hover .gscb_a,.gsst_a:focus .gscb_a{color:#36c}.gsst_a{display:inline-block}.gsst_a{cursor:pointer;padding:0 4px}.gsst_a:hover{text-decoration:none!important}.gsst_b{font-size:16px;padding:0 2px;position:relative;user-select:none;-webkit-user-select:none;white-space:nowrap}.gsst_e{vertical-align:middle;opacity:0.55;}.gsst_a:hover .gsst_e,.gsst_a:focus .gsst_e{opacity:0.72;}.gsst_a:active .gsst_e{opacity:1;}.gsst_f{background:white;text-align:left}.gsst_g{background-color:white;border:1px solid #ccc;border-top-color:#d9d9d9;box-shadow:0 2px 4px rgba(0,0,0,0.2);-webkit-box-shadow:0 2px 4px rgba(0,0,0,0.2);margin:-1px -3px;padding:0 6px}.gsst_h{background-color:white;height:1px;margin-bottom:-1px;position:relative;top:-1px}.gsib_a{width:100%;padding:4px 6px 0}.gsib_a,.gsib_b{vertical-align:top}.gssb_c{border:0;position:absolute;z-index:989}.gssb_e{border:1px solid #ccc;border-top-color:#d9d9d9;box-shadow:0 2px 4px rgba(0,0,0,0.2);-webkit-box-shadow:0 2px 4px rgba(0,0,0,0.2);cursor:default}.gssb_f{visibility:hidden;white-space:nowrap}.gssb_k{border:0;display:block;position:absolute;top:0;z-index:988}.gsdd_a{border:none!important}.gsq_a{padding:0}.gssb_a{padding:0 7px}.gssb_a,.gssb_a td{white-space:nowrap;overflow:hidden;line-height:22px}#gssb_b{font-size:11px;color:#36c;text-decoration:none}#gssb_b:hover{font-size:11px;color:#36c;text-decoration:underline}.gssb_g{text-align:center;padding:8px 0 7px;position:relative}.gssb_h{font-size:15px;height:28px;margin:0.2em;-webkit-appearance:button}.gssb_i{background:#eee}.gss_ifl{visibility:hidden;padding-left:5px}.gssb_i .gss_ifl{visibility:visible}a.gssb_j{font-size:13px;color:#36c;text-decoration:none;line-height:100%}a.gssb_j:hover{text-decoration:underline}.gssb_l{height:1px;background-color:#e5e5e5}.gssb_m{color:#000;background:#fff}.gssb_a{padding:0 9px}.gsib_a{padding:5px 9px 4px 9px}.gscb_a{line-height:27px}.gssb_e{border:0}.gssb_l{margin:5px 0}input.gsc-input::-webkit-input-placeholder{font-size:14px}input.gsc-input:-moz-placeholder{font-size:14px}input.gsc-input::-moz-placeholder{font-size:14px}input.gsc-input:-ms-input-placeholder{font-size:14px}input.gsc-input:focus::-webkit-input-placeholder{color:transparent}input.gsc-input:focus:-moz-placeholder{color:transparent}input.gsc-input:focus::-moz-placeholder{color:transparent}input.gsc-input:focus:-ms-input-placeholder{color:transparent}.gssb_c .gsc-completion-container{position:static}.gssb_c{z-index:5000}.gsc-completion-container table{background:transparent;font-size:inherit;font-family:inherit}.gssb_c > tbody > tr,.gssb_c > tbody > tr > td,.gssb_d,.gssb_d > tbody > tr,.gssb_d > tbody > tr > td,.gssb_e,.gssb_e > tbody > tr,.gssb_e > tbody > tr > td{padding:0;margin:0;border:0}.gssb_a table,.gssb_a table tr,.gssb_a table tr td{padding:0;margin:0;border:0}</style></head>
  <body class="article">
<style>
  p {
    hyphens: none;
  }
  td {
    hyphens: none;
  }

  p code {
    background: #eeeeee !important
  }

  .gsc-clear-button {
    display: none;
  }

  .gsc-control-cse {
    font-size: 10px !important
  }
</style>
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="/docs/~/index.html">Red Planet Labs Documentation</a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <script async="" src="https://cse.google.com/cse.js?cx=a198d0f9938004cd4">
          </script>
          <div id="___gcse_0"><div class="gsc-control-cse gsc-control-cse-en"><div class="gsc-control-wrapper-cse" dir="ltr"><form class="gsc-search-box gsc-search-box-tools" accept-charset="utf-8"><table cellspacing="0" cellpadding="0" role="presentation" class="gsc-search-box"><tbody><tr><td class="gsc-input"><div class="gsc-input-box" id="gsc-iw-id1"><table cellspacing="0" cellpadding="0" role="presentation" id="gs_id50" class="gstl_50 gsc-input" style="width: 100%; padding: 0px;"><tbody><tr><td id="gs_tti50" class="gsib_a"><input autocomplete="off" type="text" size="10" class="gsc-input" name="search" title="search" aria-label="search" id="gsc-i-id1" dir="ltr" spellcheck="false" style="width: 100%; padding: 0px; border: none; margin: 0px; height: auto; outline: none;"></td><td class="gsib_b"><div class="gsst_b" id="gs_st50" dir="ltr"><a class="gsst_a" href="javascript:void(0)" title="Clear search box" role="button" style="display: none;"><span class="gscb_a" id="gs_cb50" aria-hidden="true">Ã—</span></a></div></td></tr></tbody></table></div></td><td class="gsc-search-button"><button class="gsc-search-button gsc-search-button-v2"><svg width="13" height="13" viewBox="0 0 13 13"><title>search</title><path d="m4.8495 7.8226c0.82666 0 1.5262-0.29146 2.0985-0.87438 0.57232-0.58292 0.86378-1.2877 0.87438-2.1144 0.010599-0.82666-0.28086-1.5262-0.87438-2.0985-0.59352-0.57232-1.293-0.86378-2.0985-0.87438-0.8055-0.010599-1.5103 0.28086-2.1144 0.87438-0.60414 0.59352-0.8956 1.293-0.87438 2.0985 0.021197 0.8055 0.31266 1.5103 0.87438 2.1144 0.56172 0.60414 1.2665 0.8956 2.1144 0.87438zm4.4695 0.2115 3.681 3.6819-1.259 1.284-3.6817-3.7 0.0019784-0.69479-0.090043-0.098846c-0.87973 0.76087-1.92 1.1413-3.1207 1.1413-1.3553 0-2.5025-0.46363-3.4417-1.3909s-1.4088-2.0686-1.4088-3.4239c0-1.3553 0.4696-2.4966 1.4088-3.4239 0.9392-0.92727 2.0864-1.3969 3.4417-1.4088 1.3553-0.011889 2.4906 0.45771 3.406 1.4088 0.9154 0.95107 1.379 2.0924 1.3909 3.4239 0 1.2126-0.38043 2.2588-1.1413 3.1385l0.098834 0.090049z"></path></svg></button></td><td class="gsc-clear-button"><div class="gsc-clear-button" title="clear results">&nbsp;</div></td></tr></tbody></table></form><div class="gsc-results-wrapper-overlay"><div class="gsc-results-close-btn" tabindex="0"></div><div class="gsc-positioningWrapper"><div class="gsc-tabsAreaInvisible"><div aria-label="refinement" role="tab" class="gsc-tabHeader gsc-inline-block gsc-tabhActive">Custom Search</div><span class="gs-spacer"> </span></div></div><div class="gsc-positioningWrapper"><div class="gsc-refinementsAreaInvisible"></div></div><div class="gsc-above-wrapper-area-invisible"><div class="gsc-above-wrapper-area-backfill-container"></div><table cellspacing="0" cellpadding="0" role="presentation" class="gsc-above-wrapper-area-container"><tbody><tr><td class="gsc-result-info-container"><div class="gsc-result-info-invisible"></div></td><td class="gsc-orderby-container"><div class="gsc-orderby-invisible"><div class="gsc-orderby-label gsc-inline-block">Sort by:</div><div class="gsc-option-menu-container gsc-inline-block"><div class="gsc-selected-option-container gsc-inline-block"><div class="gsc-selected-option">Relevance</div><div class="gsc-option-selector"></div></div><div class="gsc-option-menu-invisible"><div class="gsc-option-menu-item gsc-option-menu-item-highlighted"><div class="gsc-option">Relevance</div></div><div class="gsc-option-menu-item"><div class="gsc-option">Date</div></div></div></div></div></td></tr></tbody></table></div><div class="gsc-adBlockInvisible"></div><div class="gsc-wrapper"><div class="gsc-adBlockInvisible"></div><div class="gsc-resultsbox-invisible"><div class="gsc-resultsRoot gsc-tabData gsc-tabdActive"><div><div class="gsc-expansionArea"></div></div></div></div></div></div><div class="gsc-modal-background-image" tabindex="0"></div></div></div></div>
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="docs" data-version="~">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style=""></button>
    <h3 class="title"><a href="index.html">Documentation</a></h3>
<ul class="nav-list">
  <li class="nav-item is-active is-current-path" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="why-use-rama.html">Why use Rama?</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="tutorial1.html">Tutorial</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tutorial1.html">First module</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tutorial2.html">Depots, ETLs, and PStates</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tutorial3.html">Distributed programming</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tutorial4.html">Dataflow programming</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tutorial5.html">Types of ETLs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tutorial6.html">Tying it all together</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="downloads-maven-local-dev.html">Downloads, Maven, and local development</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="terminology.html">Terminology</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="paths.html">Paths</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="intermediate-dataflow.html">Intermediate dataflow programming</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="aggregators.html">Aggregators</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="stream.html">Stream topologies</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="microbatch.html">Microbatch topologies</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="query.html">Query topologies</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="depots.html">Depots</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="pstates.html">PStates</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="partitioners.html">Partitioners</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="serialization.html">Custom serialization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="module-dependencies.html">Dependencies between modules</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="operating-rama.html">Operating Rama clusters</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="heterogenous-clusters.html">Heterogenous clusters</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="replication.html">Replication</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="backups.html">Backups</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="acid.html">ACID semantics</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="rest.html">REST API</a>
  </li>
  <li class="nav-item is-current-page is-active" data-depth="1">
    <a class="nav-link" href="integrating.html">Integrating with other tools</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="all-configs.html">All configs</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing.html">Testing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="clj-defining-modules.html">Clojure API</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="clj-defining-modules.html">Defining and using modules</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="clj-dataflow-lang.html">Dataflow language</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="clj-serialization.html">Custom serialization</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="clj-testing.html">Testing</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Documentation</span>
    <span class="version">~</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <div class="title"><a href="index.html">Documentation</a></div>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">~</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Documentation</a></li>
    <li><a href="integrating.html">Integrating with other tools</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"><h3>Contents</h3><ul><li data-level="1"><a href="#_task_globals" class="">Task globals</a></li><li data-level="2"><a href="#_ticks_on_task_global_objects" class="">Ticks on task global objects</a></li><li data-level="2"><a href="#_sharing_resources_between_task_global_instances" class="">Sharing resources between task global instances</a></li><li data-level="1"><a href="#_issuing_remote_calls_within_a_topology_with_eachasync" class="is-active">Issuing remote calls within a topology with eachAsync</a></li><li data-level="1"><a href="#_external_depots">External depots</a></li><li data-level="1"><a href="#_achieving_exactly_once_update_semantics_on_external_systems">Achieving exactly-once update semantics on external systems</a></li><li data-level="1"><a href="#_summary">Summary</a></li></ul></div>
</aside>
<article class="doc">
<h1 class="page">Integrating with other tools</h1>
<aside class="toc embedded"><div class="toc-menu"><h3>Contents</h3><ul><li data-level="1"><a href="#_task_globals">Task globals</a></li><li data-level="2"><a href="#_ticks_on_task_global_objects">Ticks on task global objects</a></li><li data-level="2"><a href="#_sharing_resources_between_task_global_instances">Sharing resources between task global instances</a></li><li data-level="1"><a href="#_issuing_remote_calls_within_a_topology_with_eachasync">Issuing remote calls within a topology with eachAsync</a></li><li data-level="1"><a href="#_external_depots">External depots</a></li><li data-level="1"><a href="#_achieving_exactly_once_update_semantics_on_external_systems">Achieving exactly-once update semantics on external systems</a></li><li data-level="1"><a href="#_summary">Summary</a></li></ul></div></aside><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Rama makes it easy to efficiently integrate with other tools, whether queues, databases, or other systems. If the system has a Java API, youâ€™ll be able to interact with it from Rama modules with very little code.</p>
</div>
<div class="paragraph">
<p>The open-source library <a href="https://github.com/redplanetlabs/rama-kafka">rama-kafka</a> integrates Rama with external <a href="https://kafka.apache.org/">Apache Kafka</a> clusters and is a good example of an integration implemented using the information on this page.</p>
</div>
<div class="paragraph">
<p>On this page you will learn:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using Ramaâ€™s "task global" API to manage the lifecycle of creating and closing connections to external systems</p>
</li>
<li>
<p>Using "ticks" to execute code periodically for an integration</p>
</li>
<li>
<p>Using <code>eachAsync</code> to efficiently issue remote calls within a topology</p>
</li>
<li>
<p>Making an "external depot" to use an external system as a source of data for a topology</p>
</li>
<li>
<p>How Rama implements backpressure for external depots</p>
</li>
<li>
<p>Using <code>Ops.CURRENT_MICROBATCH_ID</code> to achieve exactly-once semantics for updates to external systems</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_task_globals"><a class="anchor" href="#_task_globals"></a>Task globals</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first step to integrating with an external system is creating a client to those systems thatâ€™s accessible to Rama topology code. If the client for an external system is thread-safe, then you may only need one client for each worker process. If itâ€™s not thread-safe, then youâ€™ll need a client for every task thread. Additionally, because youâ€™ll need to unit test your modules against these external systems, you need lifecycle hooks to shut those clients down when your modules running on <a href="testing.html" class="page">InProcessCluster</a> are shut down.</p>
</div>
<div class="paragraph">
<p>Ramaâ€™s "task global" API satisfies all these requirements in a simple way. A task global is an object associated with a var thatâ€™s accessible on every task of a module. Additionally, they can optionally specialize their contents for each task. Task globals are created using the <code>declareObject</code> method when declaring a module. Letâ€™s take a look at an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BasicTaskGlobalModule</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RamaModule</span> </span>{
  <span class="hljs-meta">@Override</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">define</span><span class="hljs-params">(Setup setup, Topologies topologies)</span> </span>{
    setup.declareObject(<span class="hljs-string">"*globalValue"</span>, <span class="hljs-number">7</span>);
    setup.declareDepot(<span class="hljs-string">"*depot"</span>, Depot.random());

    StreamTopology s = topologies.stream(<span class="hljs-string">"s"</span>);
    s.source(<span class="hljs-string">"*depot"</span>)
     .each(Ops.PRINTLN, <span class="hljs-string">"Task"</span>, <span class="hljs-keyword">new</span> Expr(Ops.CURRENT_TASK_ID), <span class="hljs-string">"-&gt;"</span>, <span class="hljs-string">"*globalValue"</span>)
     .shufflePartition()
     .each(Ops.PRINTLN, <span class="hljs-string">"Task"</span>, <span class="hljs-keyword">new</span> Expr(Ops.CURRENT_TASK_ID), <span class="hljs-string">"-&gt;"</span>, <span class="hljs-string">"*globalValue"</span>);
  }

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{
    <span class="hljs-keyword">try</span>(InProcessCluster cluster = InProcessCluster.create()) {
      RamaModule <span class="hljs-keyword">module</span> = <span class="hljs-keyword">new</span> BasicTaskGlobalModule();
      cluster.launchModule(<span class="hljs-keyword">module</span>, <span class="hljs-keyword">new</span> LaunchConfig(<span class="hljs-number">4</span>, <span class="hljs-number">4</span>));
      String moduleName = <span class="hljs-keyword">module</span>.getClass().getName();

      Depot depot = cluster.clusterDepot(moduleName, <span class="hljs-string">"*depot"</span>);
      depot.append(<span class="hljs-keyword">null</span>);
    }
  }
}</code></pre>
<div class="source-toolbox"><span class="source-lang">java</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>This module declares the var <code>"*globalValue"</code> with the value <code>7</code>. The topology prints the value of that object on the initial task, partitions to a random task using <code>shufflePartition()</code>, and then prints the value on the new task. Running the main method performs one depot append and prints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">Task 0 -&gt; 7
Task 2 -&gt; 7</code></pre>
<div class="source-toolbox"><span class="source-lang">text</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>The critical aspect of task globals, such as <code>"*globalValue"</code> in this example, is a copy exists on every task. It is a value accessible to each task without having to transfer it from any other task or node.</p>
</div>
<div class="paragraph">
<p>Rama allows you to take things a step further by specializing the value of a task global for each task. For integrating with external systems, like databases, this is necessary since tasks can live across multiple worker processes and each process, thread, or task would need its own connection.</p>
</div>
<div class="paragraph">
<p>You can specialize a task globalâ€™s value by implementing the <a href="https://redplanetlabs.com/javadoc/com/rpl/rama/integration/TaskGlobalObject.html">TaskGlobalObject</a> interface. Letâ€™s take a look at an example to see how this interface works:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpecializedTaskGlobalModule</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RamaModule</span> </span>{
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyTaskGlobal</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">TaskGlobalObject</span> </span>{
    <span class="hljs-keyword">int</span> _v;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> special;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyTaskGlobal</span><span class="hljs-params">(<span class="hljs-keyword">int</span> v)</span> </span>{
      _v = v;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">prepareForTask</span><span class="hljs-params">(<span class="hljs-keyword">int</span> taskId, TaskGlobalContext context)</span> </span>{
      <span class="hljs-keyword">this</span>.special = taskId * _v;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">close</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{

    }
  }

  <span class="hljs-meta">@Override</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">define</span><span class="hljs-params">(Setup setup, Topologies topologies)</span> </span>{
    setup.declareObject(<span class="hljs-string">"*tg"</span>, <span class="hljs-keyword">new</span> MyTaskGlobal(<span class="hljs-number">10</span>));
    setup.declareDepot(<span class="hljs-string">"*depot"</span>, Depot.random());

    StreamTopology s = topologies.stream(<span class="hljs-string">"s"</span>);
    s.source(<span class="hljs-string">"*depot"</span>)
     .each(Ops.CURRENT_TASK_ID).out(<span class="hljs-string">"*taskId1"</span>)
     .each((MyTaskGlobal mtg) -&gt; mtg.special, <span class="hljs-string">"*tg"</span>).out(<span class="hljs-string">"*special1"</span>)
     .shufflePartition()
     .each(Ops.CURRENT_TASK_ID).out(<span class="hljs-string">"*taskId2"</span>)
     .each((MyTaskGlobal mtg) -&gt; mtg.special, <span class="hljs-string">"*tg"</span>).out(<span class="hljs-string">"*special2"</span>)
     .each(Ops.PRINTLN, <span class="hljs-string">"Results:"</span>, <span class="hljs-string">"*taskId1"</span>, <span class="hljs-string">"-&gt;"</span>, <span class="hljs-string">"*special1"</span>, <span class="hljs-string">","</span>, <span class="hljs-string">"*taskId2"</span>, <span class="hljs-string">"-&gt;"</span>, <span class="hljs-string">"*special2"</span>);
  }

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{
    <span class="hljs-keyword">try</span>(InProcessCluster cluster = InProcessCluster.create()) {
      RamaModule <span class="hljs-keyword">module</span> = <span class="hljs-keyword">new</span> SpecializedTaskGlobalModule();
      cluster.launchModule(<span class="hljs-keyword">module</span>, <span class="hljs-keyword">new</span> LaunchConfig(<span class="hljs-number">8</span>, <span class="hljs-number">4</span>));
      String moduleName = <span class="hljs-keyword">module</span>.getClass().getName();

      Depot depot = cluster.clusterDepot(moduleName, <span class="hljs-string">"*depot"</span>);
      depot.append(<span class="hljs-keyword">null</span>);
    }
  }
}</code></pre>
<div class="source-toolbox"><span class="source-lang">java</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>When <code>declareObject</code> is called with an object implementing <code>TaskGlobalObject</code>, Rama doesnâ€™t just send a copy of that object to each task. It additionally calls the <code>prepareForTask</code> method on each instance of that object on each task during worker startup. <code>prepareForTask</code> acts like a second constructor for the object.</p>
</div>
<div class="paragraph">
<p>In this example, <code>MyTaskGlobal</code> has two fields: <code>_v</code> and <code>special</code>. <code>_v</code> is set in the constructor when the object is initially constructed during declaration of the module. When the module is deployed, Rama uses Java serialization to send that object to every task on every worker. The object is deserialized for every task so that each task has a unique instance of the object. After deserialization the field <code>_v</code> is set and the field <code>special</code> is <code>null</code>.</p>
</div>
<div class="paragraph">
<p>Rama then calls <code>prepareForTask</code> on the object to allow it to specialize its value. <code>prepareForTask</code> receives as arguments information about the context for which the object is being prepared: the task ID and a <a href="https://redplanetlabs.com/javadoc/com/rpl/rama/integration/TaskGlobalContext.html">TaskGlobalContext</a> object containing information about the <a href="terminology.html#_task_group_task_thread" class="page">task thread</a> and module. In this example the field <code>special</code> is set to be a combination of the parameterized value <code>_v</code> and the task ID.</p>
</div>
<div class="paragraph">
<p>The module collects the value of <code>special</code> on two different tasks and prints them for each depot append. Running the <code>main</code> method prints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">Results: 4 -&gt; 40 , 2 -&gt; 20</code></pre>
<div class="source-toolbox"><span class="source-lang">text</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>You can also see from the definition of <code>MyTaskGlobal</code> that the <code>close</code> method is required. This is used to clean up any resources opened by the task global when the worker is being shut down, such as database connections. This is most important in unit test scenarios where youâ€™ll be launching and tearing down many <code>InProcessCluster</code> instances and donâ€™t want resources leaking between tests.</p>
</div>
<div class="sect2">
<h3 id="_ticks_on_task_global_objects"><a class="anchor" href="#_ticks_on_task_global_objects"></a>Ticks on task global objects</h3>
<div class="paragraph">
<p>In some cases, you may want your task global object to execute code on a regular basis. For example, you may have a task global that collects monitoring data for an external system and you want to flush accumulated monitoring data every 60 seconds. You can accomplish this with task globals by implementing the <code>TaskGlobalObjectWithTick</code> interface. This interface extends <code>TaskGlobalObject</code> with two additional methods. Hereâ€™s an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TickedTaskGlobalExample</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">TaskGlobalObjectWithTick</span> </span>{
  Integer _taskId;
  <span class="hljs-keyword">int</span> _tick = <span class="hljs-number">0</span>;

  <span class="hljs-meta">@Override</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">prepareForTask</span><span class="hljs-params">(<span class="hljs-keyword">int</span> taskId, TaskGlobalContext context)</span> </span>{
    _taskId = taskId;
  }

  <span class="hljs-meta">@Override</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getFrequencyMillis</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-number">30000</span>;
  }

  <span class="hljs-meta">@Override</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tick</span><span class="hljs-params">()</span> </span>{
    _tick++;
    System.out.println(<span class="hljs-string">"Tick "</span> + _tick + <span class="hljs-string">" on "</span> + _taskId);
  }

  <span class="hljs-meta">@Override</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">close</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{

  }
}</code></pre>
<div class="source-toolbox"><span class="source-lang">java</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p><code>getFrequencyMillis()</code> returns the tick frequency and <code>tick()</code> implements the code to run on each tick. Every 30 seconds this task global will print out how many times it ticked and on which task it lives.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sharing_resources_between_task_global_instances"><a class="anchor" href="#_sharing_resources_between_task_global_instances"></a>Sharing resources between task global instances</h3>
<div class="paragraph">
<p>You may want to share resources between multiple instances of a task global across multiple tasks. For example, you may be integrating with a database that provides a thread-safe client and only want one client created per process. Or the client is not thread-safe but you only want one client for each <a href="terminology.html#_task_group_task_thread" class="page">task thread</a>. The <code>TaskGlobalContext</code> argument to <code>prepareForTask</code> provides the information needed to accomplish this.</p>
</div>
<div class="paragraph">
<p>The basic technique to share resources is to store those shared resources in a static map on the task global class. During <code>prepareForTask</code>, the task global checks to see if the desired resource already exists and creates it if not. Whatever task creates the resource remembers that so it can be responsible for closing the resource and removing it from the static map in the <code>close()</code> method. Letâ€™s look at an example of this technique in action to share a resource on a per-thread basis:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TaskThreadSharedResourceTaskGlobal</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">TaskGlobalObject</span> </span>{
  <span class="hljs-keyword">static</span> ConcurrentHashMap&lt;List, Closeable&gt; sharedResources = <span class="hljs-keyword">new</span> ConcurrentHashMap&lt;&gt;();

  String _connectionString;
  List _resourceId;
  Closeable _resource;
  <span class="hljs-keyword">boolean</span> _owner = <span class="hljs-keyword">false</span>;

  <span class="hljs-function"><span class="hljs-keyword">private</span> Closeable <span class="hljs-title">makeResource</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// stubbed out for illustration purposes</span>
    <span class="hljs-keyword">return</span> () -&gt; { };
  }


  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TaskThreadSharedResourceTaskGlobal</span><span class="hljs-params">(String connectionString)</span> </span>{
    _connectionString = connectionString;
  }

  <span class="hljs-meta">@Override</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">prepareForTask</span><span class="hljs-params">(<span class="hljs-keyword">int</span> taskId, TaskGlobalContext context)</span> </span>{
    <span class="hljs-keyword">int</span> taskThreadId = Collections.min(context.getTaskGroup());
    _resourceId = Arrays.asList(context.getModuleInstanceInfo().getModuleInstanceId(),
                                taskThreadId,
                                _connectionString);
    <span class="hljs-keyword">if</span>(sharedResources.containsKey(_resourceId)) {
      _resource = sharedResources.get(_resourceId);
    } <span class="hljs-keyword">else</span> {
      _resource = makeResource();
      sharedResources.put(_resourceId, _resource);
      _owner = <span class="hljs-keyword">true</span>;
    }
  }

  <span class="hljs-meta">@Override</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">close</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{
    <span class="hljs-keyword">if</span>(_owner) {
      _resource.close();
      sharedResources.remove(_resourceId);
    }
  }
}</code></pre>
<div class="source-toolbox"><span class="source-lang">java</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>The <code>List</code> keys in the static map uniquely identify each resource. In this case the list contains: the <a href="terminology.html#_module_instance" class="page">module instance ID</a>, the lowest task ID on the task thread, and the connection string. Module instance IDs are unique across all modules, and the reason theyâ€™re needed here are so this code can be run in a test environment using <code>InProcessCluster</code> where you may be running many modules all in the same process. Using the lowest task ID identifies each task as being on the same task thread, and the connection string identifies this particular resource. So if you wanted a task global representing a SQL database, the connection string can serve as the identifier so you can have multiple task globals of the same type targeting different SQL databases.</p>
</div>
<div class="paragraph">
<p>The code keeps track of which task creates the resource and makes it responsible for closing it in the <code>close()</code> method. Because all the tasks in a task thread share the thread, any code they run is serial to one another. So no synchronization is needed between them. If you wanted to have one shared resource for all tasks in the process, those different task threads would be intializing concurrently and you would need additional synchronization to make sure the resource is only created by a single task (e.g. with a lock).</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/redplanetlabs/rama-kafka">rama-kafka</a> is an example of an integration that has a per-thread shared resource as well as a per-process shared resource (because <a href="https://javadoc.io/static/org.apache.kafka/kafka-clients/3.2.3/org/apache/kafka/clients/consumer/KafkaConsumer.html">KafkaConsumer</a> is not thread-safe and <a href="https://javadoc.io/static/org.apache.kafka/kafka-clients/3.2.3/org/apache/kafka/clients/producer/KafkaProducer.html">KafkaProducer</a> is thread-safe).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_issuing_remote_calls_within_a_topology_with_eachasync"><a class="anchor" href="#_issuing_remote_calls_within_a_topology_with_eachasync"></a>Issuing remote calls within a topology with eachAsync</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When writing a topology, itâ€™s critical you never block a task thread by waiting on another thread or process. A task thread is used for depot appends, other topologies, PState queries, and internal system tasks. Blocking the task thread would block all those other functions from being carried out. So when you need to interact with a system running somewhere else, Rama provides the method <a href="https://redplanetlabs.com/javadoc/com/rpl/rama/Block.html#eachAsync-com.rpl.rama.ops.RamaFunction0-">eachAsync</a> to do so in an efficient, non-blocking way.</p>
</div>
<div class="paragraph">
<p><code>eachAsync</code> works just like <a href="https://redplanetlabs.com/javadoc/com/rpl/rama/Block.html#each-com.rpl.rama.ops.RamaFunction0-">each</a> except the provided function returns a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html">CompletableFuture</a> instead of a value. When the <code>CompletableFuture</code> is delivered, it will emit the delivered value asynchronusly to <code>out</code> on the <code>eachAsync</code> call within the topology context. Hereâ€™s an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EachAsyncModule</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RamaModule</span> </span>{
  <span class="hljs-meta">@Override</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">define</span><span class="hljs-params">(Setup setup, Topologies topologies)</span> </span>{
    setup.declareDepot(<span class="hljs-string">"*depot"</span>, Depot.random());

    StreamTopology s = topologies.stream(<span class="hljs-string">"s"</span>);
    s.source(<span class="hljs-string">"*depot"</span>)
     .eachAsync(() -&gt; {
       CompletableFuture ret = <span class="hljs-keyword">new</span> CompletableFuture();
       ExecutorService es = Executors.newSingleThreadExecutor();
       es.submit(() -&gt; {
         ret.complete(<span class="hljs-string">"ABCDE"</span>);
         es.shutdown();
       });
       <span class="hljs-keyword">return</span> ret;
     }).out(<span class="hljs-string">"*v"</span>)
     .each(Ops.PRINTLN, <span class="hljs-string">"Result:"</span>, <span class="hljs-string">"*v"</span>);
  }

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{
    <span class="hljs-keyword">try</span>(InProcessCluster cluster = InProcessCluster.create()) {
      RamaModule <span class="hljs-keyword">module</span> = <span class="hljs-keyword">new</span> EachAsyncModule();
      cluster.launchModule(<span class="hljs-keyword">module</span>, <span class="hljs-keyword">new</span> LaunchConfig(<span class="hljs-number">4</span>, <span class="hljs-number">4</span>));
      String moduleName = <span class="hljs-keyword">module</span>.getClass().getName();

      Depot depot = cluster.clusterDepot(moduleName, <span class="hljs-string">"*depot"</span>);
      depot.append(<span class="hljs-keyword">null</span>);
    }
  }
}</code></pre>
<div class="source-toolbox"><span class="source-lang">java</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Running this prints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">Result: ABCDE</code></pre>
<div class="source-toolbox"><span class="source-lang">text</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>In this code the <code>eachAsync</code> call returns a <code>CompletableFuture</code> that is delivered on another thread. As you can see the output var <code>"*v"</code> is bound to the value delivered to the <code>CompletableFuture</code> and not to the <code>CompletableFuture</code> itself. <code>eachAsync</code> efficiently ties the success/failure of the topology to the success/failure of the asynchronous call (which may be doing a remote call to an external system). If the call succeeds, the value is delivered and the topology proceeds with whatever is after the <code>eachAsync</code> call. If the call fails by delivering an exception to the <code>CompletableFuture</code>, the topology will detect that failure and retry if appropriate.</p>
</div>
<div class="paragraph">
<p><code>eachAsync</code> isnâ€™t specifically tied to task globals. Itâ€™s a general facility for performing async computation in a topology. When used with a task global, like one representing a database, you would pass that task global in as an argument and your <code>eachAsync</code> function can grab whatever client interface it needs from the task global.</p>
</div>
<div class="paragraph">
<p>Ideally, the client library for the external system you are integrating with already has a non-blocking interface. In this case itâ€™s easy to call that non-blocking API within an <code>eachAsync</code> call and return the result as a <code>CompletableFuture</code>. If the system only has a blocking API, then you have to set up a thread to perform those calls in the background. That thread can be set up and managed as part of a task global. <a href="https://github.com/redplanetlabs/rama-kafka">rama-kafka</a> utilizes this technique for calls to <a href="https://javadoc.io/static/org.apache.kafka/kafka-clients/3.2.3/org/apache/kafka/clients/consumer/KafkaConsumer.html">KafkaConsumer</a> since that only has a blocking API.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_external_depots"><a class="anchor" href="#_external_depots"></a>External depots</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Rama provides the interface <a href="https://redplanetlabs.com/javadoc/com/rpl/rama/integration/ExternalDepot.html">ExternalDepot</a> for making task globals which can be used as sources for topologies. External depots work exactly like regular depots. All depot options are available and retries in case of downstream processing failure work the same. Additionally, for stream topologies Rama implements backpressure and will stop polling for new data if consuming topologies arenâ€™t keeping up.</p>
</div>
<div class="paragraph">
<p>Letâ€™s take a look at the <code>ExternalDepot</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ExternalDepot</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TaskGlobalObject</span> </span>{
  <span class="hljs-function">CompletableFuture&lt;Integer&gt; <span class="hljs-title">getNumPartitions</span><span class="hljs-params">()</span></span>;
  <span class="hljs-function">CompletableFuture&lt;Long&gt; <span class="hljs-title">startOffset</span><span class="hljs-params">(<span class="hljs-keyword">int</span> partitionIndex)</span></span>;
  <span class="hljs-function">CompletableFuture&lt;Long&gt; <span class="hljs-title">endOffset</span><span class="hljs-params">(<span class="hljs-keyword">int</span> partitionIndex)</span></span>;
  <span class="hljs-function">CompletableFuture&lt;Long&gt; <span class="hljs-title">offsetAfterTimestampMillis</span><span class="hljs-params">(<span class="hljs-keyword">int</span> partitionIndex, <span class="hljs-keyword">long</span> millis)</span></span>;
  <span class="hljs-function">CompletableFuture&lt;List&gt; <span class="hljs-title">fetchFrom</span><span class="hljs-params">(<span class="hljs-keyword">int</span> partitionIndex, <span class="hljs-keyword">long</span> startOffset, <span class="hljs-keyword">long</span> endOffset)</span></span>;
  <span class="hljs-function">CompletableFuture&lt;List&gt; <span class="hljs-title">fetchFrom</span><span class="hljs-params">(<span class="hljs-keyword">int</span> partitionIndex, <span class="hljs-keyword">long</span> startOffset)</span></span>;
}</code></pre>
<div class="source-toolbox"><span class="source-lang">java</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Before diving into the interface, letâ€™s take a look at an example of usage. This example makes use of the <code>rama-kafka</code> library which implements <code>ExternalDepot</code> for <a href="https://kafka.apache.org/">Apache Kafka</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaExternalDepotExampleModule</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RamaModule</span> </span>{
  <span class="hljs-meta">@Override</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">define</span><span class="hljs-params">(Setup setup, Topologies topologies)</span> </span>{
    Map&lt;String, Object&gt; kafkaConfig = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
    kafkaConfig.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="hljs-string">"kafka1.mycompany.com:9092,kafka2.mycompany.com:9092"</span>);
    setup.declareObject(<span class="hljs-string">"*kafka"</span>, <span class="hljs-keyword">new</span> KafkaExternalDepot(kafkaConfig, <span class="hljs-string">"myTopic"</span>));

    StreamTopology s = topologies.stream(<span class="hljs-string">"s"</span>);
    s.source(<span class="hljs-string">"*kafka"</span>).out(<span class="hljs-string">"*record"</span>)
     .each(Ops.PRINTLN, <span class="hljs-string">"Kafka record:"</span>, <span class="hljs-string">"*record"</span>);
  }
}</code></pre>
<div class="source-toolbox"><span class="source-lang">java</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Just like every other task global, external depots are declared with <code>declareObject</code>. They can then be used as sources for topologies by referencing that var in a <code>.source</code> declaration. Just like regular depots, any number of topologies can consume from the same external depot.</p>
</div>
<div class="paragraph">
<p>The core concepts for external depots are "partition indexes" and "offsets". Just like how regular depots can be distributed across many partitions across many nodes, external depots can be distributed as well. Rama refers to an individual partition it wants to query by "partition index". An external depot that has five partitions would have partition indexes <code>0</code>, <code>1</code>, <code>2</code>, <code>3</code>, and <code>4</code>. An external depot that isnâ€™t distributed would have a single partition thatâ€™s always referred to as partition index <code>0</code>.</p>
</div>
<div class="paragraph">
<p>An "offset" identifies a specific record on a specific partition. Offsets monotonically increase by one with each record on a partition. Rama always requests data from an external depot by offset.</p>
</div>
<div class="paragraph">
<p>All the <code>ExternalDepot</code> methods execute on task threads so they must be non-blocking. So just like <code>eachAsync</code>, each of these methods returns a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html">CompletableFuture</a>. If the client library for the external system you wish to implement does not have a non-blocking interface, youâ€™ll need to set up and manage a background thread in the <code>ExternalDepot</code> implementation for issuing those blocking calls.</p>
</div>
<div class="paragraph">
<p>Letâ€™s now take a look at the requirements for each of the <code>ExternalDepot</code> interface methods. The first, <code>getNumPartitions()</code>, returns the number of partitions for the external depot. Rama assigns partitions of the external depot to tasks in the module. For example, if an external depot has ten partitions and the module has eight tasks, then six tasks will be assigned to one partition and two tasks will be assigned to two partitions. Rama calls <code>getNumPartitions()</code> regularly (every 30 seconds by default) to detect any upscaling or downscaling of the external depot. Rama internally stores progress state for consuming topologies by partition index, so itâ€™s critical that the external depot implementation ensures the same partition index always refers to the same partition of data. This progress state is used by Rama to determine what to process next or what data to retry in case of a failure.</p>
</div>
<div class="paragraph">
<p>The <code>startOffset(int partitionIndex)</code> and <code>offsetAfterTimestampMillis(int partitionIndex, long millis)</code> methods exist solely to support "start from" options for <a href="stream.html#_start_from_options" class="page">stream</a> and <a href="microbatch.html#_start_from_options" class="page">microbatch</a> topologies. If you donâ€™t ever plan to use those options, itâ€™s ok for these methods to throw an <a href="https://docs.oracle.com/javase/7/docs/api/java/lang/UnsupportedOperationException.html">UnsupportedOperationException</a>.</p>
</div>
<div class="paragraph">
<p><code>startOffset(int partitionIndex)</code> should return the first available offset on that partition. <code>offsetAfterTimestampMillis(int partitionIndex, long millis)</code> should return the first offset appended to that partition after that timestamp. If there is no offset after that timestamp, it should deliver <code>null</code> to the returned <code>CompletableFuture</code>. This method requires the external depot source to maintain a time index for appended records.</p>
</div>
<div class="paragraph">
<p>The <code>endOffset(int partitionIndex)</code> method returns the next offset that will be appended to on the partition. Itâ€™s one more than the last available offset on the partition. This must be implemented.</p>
</div>
<div class="paragraph">
<p>The <code>fetchFrom(int partitionIndex, long startOffset, long endOffset)</code> method must return a list of all records between that range of offsets on that partition. <code>startOffset</code> is inclusive and <code>endOffset</code> is exclusive. This method is primarily used for fetching microbatches. This method must return exactly that range, no more and no less.</p>
</div>
<div class="paragraph">
<p>The <code>fetchFrom(int partitionIndex, long startOffset)</code> method must return a "reasonable" amount of data starting from <code>startOffset</code>. This method is used for streaming to get new data to push to stream topologies. Rama only calls this method if consuming stream topologies have available capacity to process new records. This provides backpressure to gracefully lower the load on external depot sources if stream topologies are behind (e.g. due to bursts in traffic or underallocation of resources). The implementation of <code>ExternalDepot</code> is free to determine what is a "reasonable" amount of data to poll at a time. As a rule of thumb, you should return no more than a few hundred records per call of this method.</p>
</div>
<div class="paragraph">
<p>For a complete example of an <code>ExternalDepot</code> implemention, you can reference the <a href="https://github.com/redplanetlabs/rama-kafka">rama-kafka</a> implementation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_achieving_exactly_once_update_semantics_on_external_systems"><a class="anchor" href="#_achieving_exactly_once_update_semantics_on_external_systems"></a>Achieving exactly-once update semantics on external systems</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the great benefits of using <a href="microbatch.html" class="page">microbatch topologies</a> are their strong exactly-once update semantics for PStates. No matter how many failures occur and how many times processing needs to be retried, the results into PStates will be as if processing was done exactly one time. The logic powering that happens completely behind the scenes and as a user you just need to worry about your computation.</p>
</div>
<div class="paragraph">
<p>You can get the same exactly-once update semantics when updating external systems, like external databases, with a microbatch topology. Itâ€™s not as elegant or efficient as how Rama implements PStates, but the necessary information is exposed so you can implement it yourself.</p>
</div>
<div class="paragraph">
<p>The core to how microbatch topologies achieve exactly-once semantics is by tracking a value called the "microbatch ID". The microbatch ID is a 64 bit value that increments by one with each successful microbatch. Critically, each microbatch ID is associated with a specific range of data on each depot partition (either built-in depots or external depots) being consumed by the microbatch topology. So if a microbatch attempt fails, the microbatch is retried with the same microbatch ID and the exact same data from each depot.</p>
</div>
<div class="paragraph">
<p>The microbatch ID is stored as part of each PState partition updated in a microbatch. PState partitions are versioned by microbatch ID. So when a microbatch retries, all PState partitions are reverted internally to the version for the previous microbatch ID. Because a microbatch must succeed before moving on to the next microbatch, this guarantees exactly-once update semantics.</p>
</div>
<div class="paragraph">
<p>You can achieve the same thing with external systems by versioning your data per-record. This isnâ€™t nearly as efficient as versioning per partition like Rama PStates, but it achieves the same purpose. Rama provides the function <a href="https://redplanetlabs.com/javadoc/com/rpl/rama/ops/Ops.html#CURRENT_MICROBATCH_ID">Ops.CURRENT_MICROBATCH_ID</a> to get the ID for the current microbatch attempt. This function can only be called from within a microbatch topology.</p>
</div>
<div class="paragraph">
<p>Hereâ€™s some pseudocode showing how you could use <code>Ops.CURRENT_MICROBATCH_ID</code> to achieve exactly-once update semantics to a key/value database system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">.eachAsync((MyExternalSystem s, String key) -&gt; s.getAsync(key), <span class="hljs-string">"*mySystem"</span>, <span class="hljs-string">"*key"</span>).out(<span class="hljs-string">"*record"</span>)
.each(Ops.CURRENT_MICROBATCH_ID).out(<span class="hljs-string">"*microbatchId"</span>)
.each((MyRecord record, Long microbatchId, Integer toAdd) -&gt; {
  <span class="hljs-keyword">int</span> curr;
  <span class="hljs-keyword">if</span>(microbatchId.equals(record.microbatchId)) {
    curr = record.prevVal;
  } <span class="hljs-keyword">else</span> {
    curr = record.currVal;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MyRecord(curr, curr + toAdd, microbatchId);
}, <span class="hljs-string">"*record"</span>, <span class="hljs-string">"*microbatchId"</span>, <span class="hljs-string">"*toAdd"</span>).out(<span class="hljs-string">"*newRecord"</span>)
.eachAsync((MyExternalSystem s, String key, MyRecord record) -&gt; s.putAsync(key, record), <span class="hljs-string">"*mySystem"</span>, <span class="hljs-string">"*key"</span>, <span class="hljs-string">"*newRecord"</span>);</code></pre>
<div class="source-toolbox"><span class="source-lang">java</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>In this example, each value for the K/V database stores the last microbatch ID to update it, the value associated with that microbatch ID, and the value associated for the previous microbatch ID. This example increments the stored value for the key <code>"*key"</code> by the value of <code>"*toAdd"</code>. Before updating the record, it checks if a previous attempt for this microbatch ID updated the value. If so, it uses the value associated with the previous microbatch ID to perform the increment. This ensures that no matter how many times the microbatch fails and retries, the values represented in the external K/V database reflect the processing of depot records exactly one time.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary"><a class="anchor" href="#_summary"></a>Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ramaâ€™s facilities for integrating with external systems are simple and general purpose. Task globals make it easy to manage any resources you need for integrations, <code>eachAsync</code> enables you to interact with external systems in efficient and arbitrary ways, and the external depot API lets you use external systems as data sources for topologies with support for Ramaâ€™s full feature set. Because everything is just Java code, and your integrations are just Java libraries, youâ€™re able to manage your integrations just like you would any dependency for any Java application. Additionally, youâ€™re able to test your integrations just like you would test any Java system.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
</footer>
<script type="text/javascript" src="../../_/js/main.js"></script>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async="" src="../../_/js/vendor/highlight.js"></script>
  

<table cellspacing="0" cellpadding="0" role="presentation" class="gstl_50 gssb_c" style="width: 217px; display: none; top: 50px; left: 1048px; position: absolute;"><tbody><tr><td class="gssb_f"></td><td class="gssb_e" style="width: 100%;"></td></tr></tbody></table></body></html>