<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Operating Rama clusters :: Red Planet Labs Documentation</title>
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
<!-- Google tag (gtag.js) -->
<script async="" src="//cse.google.com/adsense/search/async-ads.js"></script><script type="text/javascript" async="" src="https://www.googletagmanager.com/gtag/js?id=G-6FCG0W0TYJ&amp;l=dataLayer&amp;cx=c&amp;gtm=457e53h1za200&amp;tag_exp=102482433~102587591~102717422~102788824~102813109~102814060~102825837~102879719"></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-137231341-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6FCG0W0TYJ');
</script>
  <script src="https://www.google.com/cse/static/element/75c56d121cde450a/cse_element__en.js?usqp=CAM%3D" type="text/javascript"></script><link type="text/css" href="https://www.google.com/cse/static/element/75c56d121cde450a/default+en.css" rel="stylesheet"><link type="text/css" href="https://www.google.com/cse/static/style/look/v4/default.css" rel="stylesheet"><style type="text/css">.gsc-control-cse{font-family:arial, sans-serif}.gsc-control-cse .gsc-table-result{font-family:arial, sans-serif}.gsc-refinementsGradient{background:linear-gradient(to left,rgba(255,255,255,1),rgba(255,255,255,0))}.gsc-control-cse{border-color:#1a1a1a;background-color:#1a1a1a}input.gsc-input,.gsc-input-box,.gsc-input-box-hover,.gsc-input-box-focus{border-color:#DFE1E5}.gsc-search-button-v2,.gsc-search-button-v2:hover,.gsc-search-button-v2:focus{border-color:#3079ED;background-color:#4D90FE;background-image:none;filter:none}.gsc-search-button-v2 svg{fill:#FFFFFF}.gsc-tabHeader.gsc-tabhActive,.gsc-refinementHeader.gsc-refinementhActive{color:#1A73E8;border-color:#1A73E8;background-color:#FFFFFF}.gsc-tabHeader.gsc-tabhInactive,.gsc-refinementHeader.gsc-refinementhInactive{color:#666666;border-color:#666666;background-color:#FFFFFF}.gsc-webResult.gsc-result,.gsc-results .gsc-imageResult{border-color:#FFFFFF;background-color:#FFFFFF}.gsc-webResult.gsc-result:hover{border-color:#FFFFFF;background-color:#FFFFFF}.gs-webResult.gs-result a.gs-title:link,.gs-webResult.gs-result a.gs-title:link b,.gs-imageResult a.gs-title:link,.gs-imageResult a.gs-title:link b{color:#1155CC}.gs-webResult.gs-result a.gs-title:visited,.gs-webResult.gs-result a.gs-title:visited b,.gs-imageResult a.gs-title:visited,.gs-imageResult a.gs-title:visited b{color:#1155CC}.gs-webResult.gs-result a.gs-title:hover,.gs-webResult.gs-result a.gs-title:hover b,.gs-imageResult a.gs-title:hover,.gs-imageResult a.gs-title:hover b{color:#1155CC}.gs-webResult.gs-result a.gs-title:active,.gs-webResult.gs-result a.gs-title:active b,.gs-imageResult a.gs-title:active,.gs-imageResult a.gs-title:active b{color:#1155CC}.gsc-cursor-page{color:#1155CC}a.gsc-trailing-more-results:link{color:#1155CC}.gs-webResult:not(.gs-no-results-result):not(.gs-error-result) .gs-snippet,.gs-fileFormatType{color:#333333}.gs-webResult div.gs-visibleUrl{color:#009933}.gs-webResult div.gs-visibleUrl-short{color:#009933}.gs-webResult div.gs-visibleUrl-short{display:none}.gs-webResult div.gs-visibleUrl-long{display:none}.gs-webResult div.gs-visibleUrl-breadcrumb{display:block}.gs-promotion div.gs-visibleUrl-short{display:none}.gs-promotion div.gs-visibleUrl-long{display:block}.gs-promotion div.gs-visibleUrl-breadcrumb{display:none}.gsc-cursor-box{border-color:#FFFFFF}.gsc-results .gsc-cursor-box .gsc-cursor-page{border-color:#666666;background-color:#FFFFFF;color:#666666}.gsc-results .gsc-cursor-box .gsc-cursor-current-page{border-color:#1A73E8;background-color:#FFFFFF;color:#1A73E8}.gsc-webResult.gsc-result.gsc-promotion{border-color:#FFFFFF;background-color:#F6F6F6}.gsc-completion-title{color:#1155CC}.gsc-completion-snippet{color:#333333}.gs-promotion a.gs-title:link,.gs-promotion a.gs-title:link *,.gs-promotion .gs-snippet a:link{color:#1155CC}.gs-promotion a.gs-title:visited,.gs-promotion a.gs-title:visited *,.gs-promotion .gs-snippet a:visited{color:#1155CC}.gs-promotion a.gs-title:hover,.gs-promotion a.gs-title:hover *,.gs-promotion .gs-snippet a:hover{color:#1155CC}.gs-promotion a.gs-title:active,.gs-promotion a.gs-title:active *,.gs-promotion .gs-snippet a:active{color:#1155CC}.gs-promotion .gs-snippet,.gs-promotion .gs-title .gs-promotion-title-right,.gs-promotion .gs-title .gs-promotion-title-right *{color:#333333}.gs-promotion .gs-visibleUrl,.gs-promotion .gs-visibleUrl-short{color:#009933}.gcsc-find-more-on-google{color:#1155CC}.gcsc-find-more-on-google-magnifier{fill:#1155CC}</style><style type="text/css">.gscb_a{display:inline-block;font:27px/13px arial,sans-serif}.gsst_a .gscb_a{color:#a1b9ed;cursor:pointer}.gsst_a:hover .gscb_a,.gsst_a:focus .gscb_a{color:#36c}.gsst_a{display:inline-block}.gsst_a{cursor:pointer;padding:0 4px}.gsst_a:hover{text-decoration:none!important}.gsst_b{font-size:16px;padding:0 2px;position:relative;user-select:none;-webkit-user-select:none;white-space:nowrap}.gsst_e{vertical-align:middle;opacity:0.55;}.gsst_a:hover .gsst_e,.gsst_a:focus .gsst_e{opacity:0.72;}.gsst_a:active .gsst_e{opacity:1;}.gsst_f{background:white;text-align:left}.gsst_g{background-color:white;border:1px solid #ccc;border-top-color:#d9d9d9;box-shadow:0 2px 4px rgba(0,0,0,0.2);-webkit-box-shadow:0 2px 4px rgba(0,0,0,0.2);margin:-1px -3px;padding:0 6px}.gsst_h{background-color:white;height:1px;margin-bottom:-1px;position:relative;top:-1px}.gsib_a{width:100%;padding:4px 6px 0}.gsib_a,.gsib_b{vertical-align:top}.gssb_c{border:0;position:absolute;z-index:989}.gssb_e{border:1px solid #ccc;border-top-color:#d9d9d9;box-shadow:0 2px 4px rgba(0,0,0,0.2);-webkit-box-shadow:0 2px 4px rgba(0,0,0,0.2);cursor:default}.gssb_f{visibility:hidden;white-space:nowrap}.gssb_k{border:0;display:block;position:absolute;top:0;z-index:988}.gsdd_a{border:none!important}.gsq_a{padding:0}.gssb_a{padding:0 7px}.gssb_a,.gssb_a td{white-space:nowrap;overflow:hidden;line-height:22px}#gssb_b{font-size:11px;color:#36c;text-decoration:none}#gssb_b:hover{font-size:11px;color:#36c;text-decoration:underline}.gssb_g{text-align:center;padding:8px 0 7px;position:relative}.gssb_h{font-size:15px;height:28px;margin:0.2em;-webkit-appearance:button}.gssb_i{background:#eee}.gss_ifl{visibility:hidden;padding-left:5px}.gssb_i .gss_ifl{visibility:visible}a.gssb_j{font-size:13px;color:#36c;text-decoration:none;line-height:100%}a.gssb_j:hover{text-decoration:underline}.gssb_l{height:1px;background-color:#e5e5e5}.gssb_m{color:#000;background:#fff}.gssb_a{padding:0 9px}.gsib_a{padding:5px 9px 4px 9px}.gscb_a{line-height:27px}.gssb_e{border:0}.gssb_l{margin:5px 0}input.gsc-input::-webkit-input-placeholder{font-size:14px}input.gsc-input:-moz-placeholder{font-size:14px}input.gsc-input::-moz-placeholder{font-size:14px}input.gsc-input:-ms-input-placeholder{font-size:14px}input.gsc-input:focus::-webkit-input-placeholder{color:transparent}input.gsc-input:focus:-moz-placeholder{color:transparent}input.gsc-input:focus::-moz-placeholder{color:transparent}input.gsc-input:focus:-ms-input-placeholder{color:transparent}.gssb_c .gsc-completion-container{position:static}.gssb_c{z-index:5000}.gsc-completion-container table{background:transparent;font-size:inherit;font-family:inherit}.gssb_c > tbody > tr,.gssb_c > tbody > tr > td,.gssb_d,.gssb_d > tbody > tr,.gssb_d > tbody > tr > td,.gssb_e,.gssb_e > tbody > tr,.gssb_e > tbody > tr > td{padding:0;margin:0;border:0}.gssb_a table,.gssb_a table tr,.gssb_a table tr td{padding:0;margin:0;border:0}</style></head>
  <body class="article">
<style>
  p {
    hyphens: none;
  }
  td {
    hyphens: none;
  }

  p code {
    background: #eeeeee !important
  }

  .gsc-clear-button {
    display: none;
  }

  .gsc-control-cse {
    font-size: 10px !important
  }
</style>
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="/docs/~/index.html">Red Planet Labs Documentation</a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <script async="" src="https://cse.google.com/cse.js?cx=a198d0f9938004cd4">
          </script>
          <div id="___gcse_0"><div class="gsc-control-cse gsc-control-cse-en"><div class="gsc-control-wrapper-cse" dir="ltr"><form class="gsc-search-box gsc-search-box-tools" accept-charset="utf-8"><table cellspacing="0" cellpadding="0" role="presentation" class="gsc-search-box"><tbody><tr><td class="gsc-input"><div class="gsc-input-box" id="gsc-iw-id1"><table cellspacing="0" cellpadding="0" role="presentation" id="gs_id50" class="gstl_50 gsc-input" style="width: 100%; padding: 0px;"><tbody><tr><td id="gs_tti50" class="gsib_a"><input autocomplete="off" type="text" size="10" class="gsc-input" name="search" title="search" aria-label="search" id="gsc-i-id1" dir="ltr" spellcheck="false" style="width: 100%; padding: 0px; border: none; margin: 0px; height: auto; outline: none;"></td><td class="gsib_b"><div class="gsst_b" id="gs_st50" dir="ltr"><a class="gsst_a" href="javascript:void(0)" title="Clear search box" role="button" style="display: none;"><span class="gscb_a" id="gs_cb50" aria-hidden="true">×</span></a></div></td></tr></tbody></table></div></td><td class="gsc-search-button"><button class="gsc-search-button gsc-search-button-v2"><svg width="13" height="13" viewBox="0 0 13 13"><title>search</title><path d="m4.8495 7.8226c0.82666 0 1.5262-0.29146 2.0985-0.87438 0.57232-0.58292 0.86378-1.2877 0.87438-2.1144 0.010599-0.82666-0.28086-1.5262-0.87438-2.0985-0.59352-0.57232-1.293-0.86378-2.0985-0.87438-0.8055-0.010599-1.5103 0.28086-2.1144 0.87438-0.60414 0.59352-0.8956 1.293-0.87438 2.0985 0.021197 0.8055 0.31266 1.5103 0.87438 2.1144 0.56172 0.60414 1.2665 0.8956 2.1144 0.87438zm4.4695 0.2115 3.681 3.6819-1.259 1.284-3.6817-3.7 0.0019784-0.69479-0.090043-0.098846c-0.87973 0.76087-1.92 1.1413-3.1207 1.1413-1.3553 0-2.5025-0.46363-3.4417-1.3909s-1.4088-2.0686-1.4088-3.4239c0-1.3553 0.4696-2.4966 1.4088-3.4239 0.9392-0.92727 2.0864-1.3969 3.4417-1.4088 1.3553-0.011889 2.4906 0.45771 3.406 1.4088 0.9154 0.95107 1.379 2.0924 1.3909 3.4239 0 1.2126-0.38043 2.2588-1.1413 3.1385l0.098834 0.090049z"></path></svg></button></td><td class="gsc-clear-button"><div class="gsc-clear-button" title="clear results">&nbsp;</div></td></tr></tbody></table></form><div class="gsc-results-wrapper-overlay"><div class="gsc-results-close-btn" tabindex="0"></div><div class="gsc-positioningWrapper"><div class="gsc-tabsAreaInvisible"><div aria-label="refinement" role="tab" class="gsc-tabHeader gsc-inline-block gsc-tabhActive">Custom Search</div><span class="gs-spacer"> </span></div></div><div class="gsc-positioningWrapper"><div class="gsc-refinementsAreaInvisible"></div></div><div class="gsc-above-wrapper-area-invisible"><div class="gsc-above-wrapper-area-backfill-container"></div><table cellspacing="0" cellpadding="0" role="presentation" class="gsc-above-wrapper-area-container"><tbody><tr><td class="gsc-result-info-container"><div class="gsc-result-info-invisible"></div></td><td class="gsc-orderby-container"><div class="gsc-orderby-invisible"><div class="gsc-orderby-label gsc-inline-block">Sort by:</div><div class="gsc-option-menu-container gsc-inline-block"><div class="gsc-selected-option-container gsc-inline-block"><div class="gsc-selected-option">Relevance</div><div class="gsc-option-selector"></div></div><div class="gsc-option-menu-invisible"><div class="gsc-option-menu-item gsc-option-menu-item-highlighted"><div class="gsc-option">Relevance</div></div><div class="gsc-option-menu-item"><div class="gsc-option">Date</div></div></div></div></div></td></tr></tbody></table></div><div class="gsc-adBlockInvisible"></div><div class="gsc-wrapper"><div class="gsc-adBlockInvisible"></div><div class="gsc-resultsbox-invisible"><div class="gsc-resultsRoot gsc-tabData gsc-tabdActive"><div><div class="gsc-expansionArea"></div></div></div></div></div></div><div class="gsc-modal-background-image" tabindex="0"></div></div></div></div>
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="docs" data-version="~">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style=""></button>
    <h3 class="title"><a href="index.html">Documentation</a></h3>
<ul class="nav-list">
  <li class="nav-item is-active is-current-path" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="why-use-rama.html">Why use Rama?</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="tutorial1.html">Tutorial</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tutorial1.html">First module</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tutorial2.html">Depots, ETLs, and PStates</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tutorial3.html">Distributed programming</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tutorial4.html">Dataflow programming</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tutorial5.html">Types of ETLs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tutorial6.html">Tying it all together</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="downloads-maven-local-dev.html">Downloads, Maven, and local development</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="terminology.html">Terminology</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="paths.html">Paths</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="intermediate-dataflow.html">Intermediate dataflow programming</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="aggregators.html">Aggregators</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="stream.html">Stream topologies</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="microbatch.html">Microbatch topologies</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="query.html">Query topologies</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="depots.html">Depots</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="pstates.html">PStates</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="partitioners.html">Partitioners</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="serialization.html">Custom serialization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="module-dependencies.html">Dependencies between modules</a>
  </li>
  <li class="nav-item is-current-page is-active" data-depth="1">
    <a class="nav-link" href="operating-rama.html">Operating Rama clusters</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="heterogenous-clusters.html">Heterogenous clusters</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="replication.html">Replication</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="backups.html">Backups</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="acid.html">ACID semantics</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="rest.html">REST API</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="integrating.html">Integrating with other tools</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="all-configs.html">All configs</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing.html">Testing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="clj-defining-modules.html">Clojure API</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="clj-defining-modules.html">Defining and using modules</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="clj-dataflow-lang.html">Dataflow language</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="clj-serialization.html">Custom serialization</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="clj-testing.html">Testing</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Documentation</span>
    <span class="version">~</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <div class="title"><a href="index.html">Documentation</a></div>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">~</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Documentation</a></li>
    <li><a href="operating-rama.html">Operating Rama clusters</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"><h3>Contents</h3><ul><li data-level="1"><a href="#_setting_up_a_rama_cluster" class="">Setting up a Rama cluster</a></li><li data-level="2"><a href="#_adding_a_license" class="">Adding a license</a></li><li data-level="2"><a href="#_logs" class="">Logs</a></li><li data-level="2"><a href="#_internalexternal_hostname_configuration" class="">Internal/external hostname configuration</a></li><li data-level="2"><a href="#_running_single_node_cluster" class="">Running single-node cluster</a></li><li data-level="1"><a href="#_using_the_rama_cli" class="">Using the Rama CLI</a></li><li data-level="1"><a href="#_accessing_depots_pstates_and_query_topologies_from_remote_java_clients" class="">Accessing depots, PStates, and query topologies from remote Java clients</a></li><li data-level="1"><a href="#_launching_modules" class="">Launching modules</a></li><li data-level="2"><a href="#_building_an_uberjar" class="">Building an uberjar</a></li><li data-level="2"><a href="#_worker_configurations_and_dynamic_options" class="">Worker configurations and dynamic options</a></li><li data-level="2"><a href="#_isolation_scheduler" class="">Isolation scheduler</a></li><li data-level="1"><a href="#_updating_modules" class="">Updating modules</a></li><li data-level="1"><a href="#_scaling_modules" class="">Scaling modules</a></li><li data-level="2"><a href="#_scaling_tips" class="">Scaling tips</a></li><li data-level="2"><a href="#_task_scaling" class="is-active">Task scaling</a></li><li data-level="1"><a href="#_activating_self_monitoring">Activating self-monitoring</a></li><li data-level="2"><a href="#_configuring_telemetry_retention">Configuring telemetry retention</a></li><li data-level="1"><a href="#_cluster_ui">Cluster UI</a></li><li data-level="1"><a href="#_decommissioning_a_node">Decommissioning a node</a></li><li data-level="1"><a href="#_upgrading_a_rama_cluster_to_a_new_version">Upgrading a Rama cluster to a new version</a></li><li data-level="2"><a href="#_patch_version_upgrade">Patch version upgrade</a></li><li data-level="2"><a href="#_atomic_version_upgrade">Atomic version upgrade</a></li><li data-level="1"><a href="#_summary">Summary</a></li></ul></div>
</aside>
<article class="doc">
<h1 class="page">Operating Rama clusters</h1>
<aside class="toc embedded"><div class="toc-menu"><h3>Contents</h3><ul><li data-level="1"><a href="#_setting_up_a_rama_cluster">Setting up a Rama cluster</a></li><li data-level="2"><a href="#_adding_a_license">Adding a license</a></li><li data-level="2"><a href="#_logs">Logs</a></li><li data-level="2"><a href="#_internalexternal_hostname_configuration">Internal/external hostname configuration</a></li><li data-level="2"><a href="#_running_single_node_cluster">Running single-node cluster</a></li><li data-level="1"><a href="#_using_the_rama_cli">Using the Rama CLI</a></li><li data-level="1"><a href="#_accessing_depots_pstates_and_query_topologies_from_remote_java_clients">Accessing depots, PStates, and query topologies from remote Java clients</a></li><li data-level="1"><a href="#_launching_modules">Launching modules</a></li><li data-level="2"><a href="#_building_an_uberjar">Building an uberjar</a></li><li data-level="2"><a href="#_worker_configurations_and_dynamic_options">Worker configurations and dynamic options</a></li><li data-level="2"><a href="#_isolation_scheduler">Isolation scheduler</a></li><li data-level="1"><a href="#_updating_modules">Updating modules</a></li><li data-level="1"><a href="#_scaling_modules">Scaling modules</a></li><li data-level="2"><a href="#_scaling_tips">Scaling tips</a></li><li data-level="2"><a href="#_task_scaling">Task scaling</a></li><li data-level="1"><a href="#_activating_self_monitoring">Activating self-monitoring</a></li><li data-level="2"><a href="#_configuring_telemetry_retention">Configuring telemetry retention</a></li><li data-level="1"><a href="#_cluster_ui">Cluster UI</a></li><li data-level="1"><a href="#_decommissioning_a_node">Decommissioning a node</a></li><li data-level="1"><a href="#_upgrading_a_rama_cluster_to_a_new_version">Upgrading a Rama cluster to a new version</a></li><li data-level="2"><a href="#_patch_version_upgrade">Patch version upgrade</a></li><li data-level="2"><a href="#_atomic_version_upgrade">Atomic version upgrade</a></li><li data-level="1"><a href="#_summary">Summary</a></li></ul></div></aside><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This page covers everything you need to know to set up Rama clusters and manage module deployments. Modules aren’t static programs –&nbsp;their code evolves and their performance needs change over time. Rama provides first-class mechanisms to manage the evolution of modules in a robust and easy-to-use way.</p>
</div>
<div class="paragraph">
<p>Note that for development you don’t need any of the information on this page and can just use <a href="testing.html" class="page">InProcessCluster</a> by including Rama as a <a href="downloads-maven-local-dev.html" class="page">Maven dependency</a> in your project.</p>
</div>
<div class="paragraph">
<p>On this page you’ll learn:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to set up a Rama cluster</p>
</li>
<li>
<p>Using the Rama CLI</p>
</li>
<li>
<p>Accessing depots, PStates, and query topologies from remote Java clients</p>
</li>
<li>
<p>Launching modules</p>
</li>
<li>
<p>Isolation scheduler vs. dev scheduler</p>
</li>
<li>
<p>Configuring modules</p>
</li>
<li>
<p>Updating modules to a new code version</p>
</li>
<li>
<p>Scaling modules</p>
</li>
<li>
<p>Activating self-monitoring</p>
</li>
<li>
<p>Using the Cluster UI</p>
</li>
<li>
<p>Decommissioning a node that has gone bad</p>
</li>
<li>
<p>Upgrading a Rama cluster to a new version</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setting_up_a_rama_cluster"><a class="anchor" href="#_setting_up_a_rama_cluster"></a>Setting up a Rama cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first step to setting up a Rama cluster is creating a <a href="https://zookeeper.apache.org/">Zookeeper cluster</a>. Zookeeper is used by Rama to store cluster metadata such as which nodes should be running which module workers and <a href="replication.html" class="page">replication</a> coordination information (e.g. leadership election). Rama makes use of Zookeeper internally through an abstraction called the "Metastore". The deployment instructions for Zookeeper can be found <a href="https://zookeeper.apache.org/doc/current/zookeeperAdmin.html">here</a>.</p>
</div>
<div class="paragraph">
<p>Next, <a href="https://redplanetlabs.com/download">download</a> a Rama release. When unpacking a release you’ll see contents like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">lib/
log4j2.properties
logs/
rama
rama.jar
rama.yaml</code></pre>
<div class="source-toolbox"><span class="source-lang">text</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p><code>rama.jar</code> and <code>lib/</code> contain the Rama implementation and all dependency jars. If there are other libraries you wish to be on the classpath of every module, you can add those to <code>lib/</code>. <code>log4j2.properties</code> contains <a href="https://logging.apache.org/log4j/2.x/">Log4j</a> configuration for all Rama daemons and <a href="terminology.html#_worker" class="page">module workers</a>. <code>logs/</code> is where all log files will go. <code>rama</code> implements the Rama CLI, described <a href="#_using_the_rama_cli">below</a>. Lastly, <code>rama.yaml</code> is where you’ll configure Rama’s daemons.</p>
</div>
<div class="paragraph">
<p>A Rama release is used to launch the daemons comprising a Rama cluster as well as on clients issuing the Rama CLI to launch, update, or scale modules. It’s critical that clients use the same Rama release version as used by the cluster.</p>
</div>
<div class="paragraph">
<p>Rama daemons and clients can be run on UNIX-based machines, including Linux and macOS. Java 8, 11, 17, or 21 should be installed. You will also need Python 3 installed on the machines.</p>
</div>
<div class="paragraph">
<p>The next step is setting up the <a href="terminology.html#_conductor" class="page">Conductor node</a>. The Rama CLI communicates with the Conductor to launch, update, and scale modules. The Conductor also serves a web-based <a href="#_cluster_ui">Cluster UI</a> showing status and telemetry information for modules.</p>
</div>
<div class="paragraph">
<p>First, unpack the Rama release on the machine. Then edit the <code>rama.yaml</code> with the following configurations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>zookeeper.servers</code>: list of hostnames for all Zookeeper nodes (required)</p>
</li>
<li>
<p><code>local.dir</code>: path to directory for Conductor to store local state, primarily jars for modules. Defaults to <code>local-rama-data/</code> where the release is unpacked. (optional but recommended)</p>
</li>
<li>
<p><code>zookeeper.port</code>: configured port for Zookeeper nodes, defaults to <code>2000</code> (optional)</p>
</li>
<li>
<p><code>zookeeper.root</code>: root Zookeeper node for Rama to keep cluster metadata, defaults to <code>rama</code> (optional)</p>
</li>
<li>
<p><code>conductor.port</code>: port exposed by Conductor for cluster operation, defaults to 1973 (optional)</p>
</li>
<li>
<p><code>cluster.ui.port</code>: port serving the Cluster UI, defaults to 8888 (optional)</p>
</li>
<li>
<p><code>conductor.child.opts</code>: options string to JVM process for Conductor, defaults to <code>"-Xmx1024m"</code> (optional)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here’s an example Conductor configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"><span class="hljs-attr">zookeeper.servers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">"1.2.3.4"</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">"5.6.7.8"</span>
<span class="hljs-attr">local.dir:</span> <span class="hljs-string">"/data/rama"</span></code></pre>
<div class="source-toolbox"><span class="source-lang">yaml</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Other available Conductor configs can be found on <a href="all-configs.html" class="page">this page</a>.</p>
</div>
<div class="paragraph">
<p>Next, launch the Conductor by running <code>./rama conductor</code> from the unpacked release. For production you should run this command using a process supervision tool like <a href="https://en.wikipedia.org/wiki/Systemd">systemd</a> or <a href="https://mmonit.com/monit/">monit</a>.</p>
</div>
<div class="paragraph">
<p>The last step to setting up a Rama cluster is configuring Worker nodes. Each Worker node runs a daemon called the <a href="terminology.html#_supervisor" class="page">Supervisor</a> which watches for changes to cluster state and starts/stops <a href="terminology.html#_worker" class="page">Worker processes</a> as dictated by Conductor.</p>
</div>
<div class="paragraph">
<p>Launching Supervisors is similar to launching the Conductor. First, unpack the Rama release on the machine. Then edit the <code>rama.yaml</code> with the following configurations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>conductor.host</code>: hostname of conductor (required)</p>
</li>
<li>
<p><code>zookeeper.servers</code>: list of hostnames for all Zookeeper nodes (required)</p>
</li>
<li>
<p><code>local.dir</code>: path to directory for local state for Supervisor and module workers. Defaults to <code>local-rama-data/</code> where the release is unpacked. (optional but recommended)</p>
</li>
<li>
<p><code>zookeeper.port</code>: configured port for Zookeeper nodes, defaults to <code>2000</code> (optional)</p>
</li>
<li>
<p><code>zookeeper.root</code>: root Zookeeper node for Rama to keep cluster metadata, defaults to <code>rama</code> (optional)</p>
</li>
<li>
<p><code>conductor.port</code>: port exposed by Conductor for cluster operation, defaults to 1973 (optional)</p>
</li>
<li>
<p><code>supervisor.child.opts</code>: options string to JVM process for Supervisor, defaults to <code>"-Xmx256m"</code> (optional)</p>
</li>
<li>
<p><code>supervisor.host</code>: hostname reported by this Supervisor used by other nodes for network communication, defaults to result of calling <a href="https://docs.oracle.com/javase/7/docs/api/java/net/InetAddress.html#getLocalHost()">InetAddress.getLocalHost</a> (optional)</p>
</li>
<li>
<p><code>supervisor.port.range</code>: pair of numbers for range of ports to assign to launched workers, defaults to <code>3000, 4000</code>. Should be a large range to ensure Supervisor never runs out of ports to assign. (optional)</p>
</li>
<li>
<p><code>supervisor.labels</code>: a list of labels for the supervisor that can be targeted when deploying modules. See <a href="heterogenous-clusters.html" class="page">Heterogenous clusters</a> for more details. (optional)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here’s an example Supervisor configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"><span class="hljs-attr">zookeeper.servers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">"1.2.3.4"</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">"5.6.7.8"</span>
<span class="hljs-attr">conductor.host:</span> <span class="hljs-string">"9.10.11.12"</span>
<span class="hljs-attr">local.dir:</span> <span class="hljs-string">"/data/rama"</span>
<span class="hljs-attr">supervisor.port.range:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-number">2500</span>
  <span class="hljs-bullet">-</span> <span class="hljs-number">3500</span></code></pre>
<div class="source-toolbox"><span class="source-lang">yaml</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Other available Supervisor configs can be found on <a href="all-configs.html" class="page">this page</a>.</p>
</div>
<div class="paragraph">
<p>Next, launch the Supervisor by running <code>./rama supervisor</code> from the unpacked release. Like the Conductor, for production you should run this command using a process supervision tool like <a href="https://en.wikipedia.org/wiki/Systemd">systemd</a> or <a href="https://mmonit.com/monit/">monit</a>. For the Supervisor it’s best that you configure the supervision tool not to kill subprocesses if the Supervisor process dies. Although there’s no reason to expect the Supervisor to crash, if it does it’s been designed to have no affect on running workers and there’s no reason to bring down workers if their Supervisor crashes.</p>
</div>
<div class="paragraph">
<p>It’s also recommended to configure worker nodes with swap space. <a href="#_updating_modules">Module update</a> launches new workers colocated with the previous module instance’s workers as it hands off responsibility between the two module versions. So each worker node either needs enough memory to run workers for both module versions, or it needs swap space to handle the extra temporary memory needs.</p>
</div>
<div class="sect2">
<h3 id="_adding_a_license"><a class="anchor" href="#_adding_a_license"></a>Adding a license</h3>
<div class="paragraph">
<p>Rama has an embedded free license that allows clusters to be run up to two nodes. A paid license is required for larger clusters or for access to enterprise features. A license is valid between a start date and an end date and specifies the maximum number of nodes that can be utilized for running modules. A license does not restrict how many supervisors can be launched, but it does restrict how many supervisors will be assigned modules to run.</p>
</div>
<div class="paragraph">
<p>See <a href="https://redplanetlabs.com/pricing">the pricing page</a> for more info on purchasing a license.</p>
</div>
<div class="paragraph">
<p>Licenses can be viewed in the Cluster UI "Conductor" tab, like so:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/cluster-ui-conductor-license.png" alt="cluster ui conductor license">
</div>
</div>
<div class="paragraph">
<p>A license can either be "active", "expired", "superseded", or "future". The number of allowed nodes is always the maximum number of nodes specified across all valid licenses, and this is marked as the "active" license. A "superseded" license is a valid license for which there exists another valid license allowing more nodes or another valid license allowing the same number of nodes but expiring further in the future. An "expired" license has an end date in the past, and a "future" license has a start date in the future.</p>
</div>
<div class="paragraph">
<p>Licenses are installed on the Conductor and are managed with the Rama CLI commands <code>upsertLicense</code> and <code>cleanupLicenses</code>. These commands can only be run on the Conductor node.</p>
</div>
<div class="paragraph">
<p>To add a license, run <code>upsertLicense</code> with the full path to the license file like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">./rama upsertLicense --licensePath /home/mycompany/mycompany-rama-license.edn</code></pre>
<div class="source-toolbox"><span class="source-lang">text</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>To remove any expired licenses, run <code>cleanupLicenses</code> like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">./rama cleanupLicenses</code></pre>
<div class="source-toolbox"><span class="source-lang">text</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>If a license is expiring soon, you will see a banner on every Cluster UI page warning of that.</p>
</div>
<div class="paragraph">
<p>When a module is undergoing a transition, like a <a href="#_updating_modules">module update</a> or <a href="#_scaling_modules">scaling operation</a>, only nodes running worker processes corresponding to the new <a href="terminology.html#_module_instance" class="page">module instance</a> count towards the license limit.</p>
</div>
<div class="paragraph">
<p>When a cluster does not have a license permitting its current state, like if the only available license expires, the cluster will automatically shut down. All worker processes will stop, but no data will be lost. Once you add a valid license and restart the Conductor process, all the modules will restart and resume where they left off.</p>
</div>
</div>
<div class="sect2">
<h3 id="_logs"><a class="anchor" href="#_logs"></a>Logs</h3>
<div class="paragraph">
<p>Logs for the Conductor, Supervisors, and Workers are kept in the <code>logs/</code> directory in each unpacked release. The logging settings can be configured by editing <a href="https://logging.apache.org/log4j/2.x/">log4j2.properties</a> at the root of the unpacked release.</p>
</div>
<div class="paragraph">
<p>The logs should be one of the first places you look if you run into any issues. You can also add your own logging in your module code using the <a href="https://logging.apache.org/log4j/2.x/log4j-api/apidocs/org/apache/logging/log4j/Logger.html">Logger</a> class. These logs will go into the worker log files intermixed with the other logging Rama does.</p>
</div>
<div class="paragraph">
<p>You can also view all logs through the Cluster UI from the Conductor, Supervisor, or Worker pages.</p>
</div>
</div>
<div class="sect2">
<h3 id="_internalexternal_hostname_configuration"><a class="anchor" href="#_internalexternal_hostname_configuration"></a>Internal/external hostname configuration</h3>
<div class="paragraph">
<p>In some environments, like AWS, there’s a distinction between "internal" and "external" hostnames. Internal hostnames are used within the cluster environment, while external hostnames are used outside that environment (like from a laptop). So that you can use the exact same <code>rama.yaml</code> file for all daemons and clients, Rama lets you configure separate internal and external hostnames for the <code>"conductor.host"</code> and <code>"zookeeper.servers"</code> configs. Of course, if you don’t care about using the same <code>rama.yaml</code> file for all daemons and clients, you won’t need this feature.</p>
</div>
<div class="paragraph">
<p><code>conductor.host</code> and <code>zookeeper.servers</code> accept a map containing "internal" and "external" keys as an alternative to providing just a single hostname. Here’s an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">conductor.host:
  internal: "1.2.3.4"
  external: "5.6.7.8"
zookeeper.servers:
  - internal: "9.10.11.12"
    external: "13.14.15.16"
  - internal: "17.18.19.20"
    external: "21.22.23.24"</code></pre>
<div class="source-toolbox"><span class="source-lang">text</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Rama daemons use internal hostnames to communicate to each other and to Zookeeper. A Rama client can choose whether to use internal or external hostnames by how that client is created. <a href="https://redplanetlabs.com/javadoc/com/rpl/rama/RamaClusterManager.html#open--">RamaClusterManager.open</a> uses external hostnames, and <a href="https://redplanetlabs.com/javadoc/com/rpl/rama/RamaClusterManager.html#openInternal--">RamaClusterManager.openInternal</a> uses internal hostnames.</p>
</div>
</div>
<div class="sect2">
<h3 id="_running_single_node_cluster"><a class="anchor" href="#_running_single_node_cluster"></a>Running single-node cluster</h3>
<div class="paragraph">
<p>Rama is easy to set up on a single node by running Zookeeper, Conductor, and one Supervisor on the same node. This is a great way to start for low-scale applications, and it’s easy to scale up later by adding more nodes.</p>
</div>
<div class="paragraph">
<p>First, you should set up <a href="https://zookeeper.apache.org/doc/current/zookeeperAdmin.html">Zookeeper</a> on the node. If you just want to experiment with a Rama cluster and are not intending it for production use, you can run a development Zookeeper server from the unpacked Rama release directory using the command <code>./rama devZookeeper</code>. This is not suitable for production since it doesn’t set up some of the administration routines you need for long-term use. It’s purely a convenience for experimenting with a single-node cluster.</p>
</div>
<div class="paragraph">
<p>Next, you can run the Conductor and one Supervisor from the same unpacked release directory with <code>./rama conductor</code> and <code>./rama supervisor</code>. They can share the same <code>rama.yaml</code> file since they each use an independent sub-directory within <code>local.dir</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_the_rama_cli"><a class="anchor" href="#_using_the_rama_cli"></a>Using the Rama CLI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Rama CLI is used via the <code>rama</code> script at the root of an unpacked release. To use it outside a cluster, you simply configure <code>conductor.host</code> in the <code>rama.yaml</code> in the same directory. You must ensure the <code>rama</code> script you’re using is from the same release version as the cluster you configure with <code>conductor.host</code>.</p>
</div>
<div class="paragraph">
<p>The commands available in the CLI are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>rama cleanupLicenses</code>: Removes expired licenses from Conductor.</p>
</li>
<li>
<p><code>rama conductor</code>: Launches a Conductor.</p>
</li>
<li>
<p><code>rama confValue &lt;configuration name&gt;</code>: Prints value configured for given config in this unpacked release.</p>
</li>
<li>
<p><code>rama deploy …​</code>: Launches or updates a module. See the <a href="#_launching_modules">Launching modules</a> and <a href="#_updating_modules">Updating modules</a> sections below for required and optional arguments.</p>
</li>
<li>
<p><code>rama destroy &lt;moduleName&gt; [--useInternalHostnames]</code>: Destroys a module. Fails if there are any dependent modules.</p>
</li>
<li>
<p><code>rama devZookeeper</code>: Launches a Zookeeper server. Not for production use.</p>
</li>
<li>
<p><code>rama licenseInfo</code>: Prints out information about all installed licenses.</p>
</li>
<li>
<p><code>rama moduleStatus &lt;moduleName&gt; [--useInternalHostnames]</code>: Prints current status of a module.</p>
</li>
<li>
<p><code>rama pauseTopology &lt;moduleName&gt; &lt;topologyName&gt; [--useInternalHostnames]</code>: Pauses a microbatch topology in a module.</p>
</li>
<li>
<p><code>rama resumeTopology &lt;moduleName&gt; &lt;topologyName&gt; [--useInternalHostnames]</code>: Activates a microbatch topology in a module.</p>
</li>
<li>
<p><code>rama runClj &lt;namespace&gt; &lt;jarPath&gt;+</code>: Runs the given Clojure namespace with the Rama release and <code>rama.yaml</code> on the classpath. Accepts additional jars to include on classpath as additional arguments.</p>
</li>
<li>
<p><code>rama runJava &lt;class&gt; &lt;jarPath&gt;+</code>: Runs the given Java class with the Rama release and <code>rama.yaml</code> on the classpath. Accepts additional jars to include on classpath as additional arguments.</p>
</li>
<li>
<p><code>rama scaleExecutors …​</code>: Scales a module up or down. See <a href="#_scaling_modules">below</a> for required and optional arguments.</p>
</li>
<li>
<p><code>rama setOption &lt;module,topology,pstate,depot&gt; &lt;moduleName&gt; [&lt;objectName&gt;] &lt;optionName&gt; &lt;valueJSON&gt; [--useInternalHostnames]</code>: Sets a module, topology, PState, or depot dynamic option to a new value. <code>&lt;objectName&gt;</code> parameter must be given for PState and depot options.</p>
</li>
<li>
<p><code>rama shutdownCluster</code>: Gracefully shuts down a Rama cluster by letting all in-flight processing complete and then terminating every worker process. Used as part of <a href="#_upgrading_a_rama_cluster_to_a_new_version">upgrading a Rama cluster</a> to a new version. Can only be run from the Conductor node.</p>
</li>
<li>
<p><code>rama supervisor</code>: Launches a Supervisor.</p>
</li>
<li>
<p><code>rama taskGroupsStatus &lt;moduleName&gt; &lt;moduleInstanceId&gt; [--useInternalHostnames]</code>: Prints status of every <a href="terminology.html#_task_group_task_thread" class="page">task group</a> in a <a href="terminology.html#_module_instance" class="page">module instance</a>.</p>
</li>
<li>
<p><code>rama upsertLicense --licensePath &lt;path&gt;</code>: Adds a license to Conductor.</p>
</li>
<li>
<p><code>rama disallowLeaders &lt;supervisorId&gt;</code>: If possible, moves all leaders off of the given node. Only one node can be disallowed at a time. This is used for patch version upgrades of Rama clusters.</p>
</li>
<li>
<p><code>rama allowLeaders &lt;supervisorId&gt;</code>: Allows leaders again on the given supervisor.</p>
</li>
<li>
<p><code>rama supportBundle [--maxLogSizePerNode &lt;numGigabytes&gt;] [--useInternalHostnames]</code>: Produces a zipfile containing cluster logs and cluster metadata to help Red Planet Labs debug any issues.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The optional <code>--useInternalHostnames</code> flag on some of the commands causes the command to use <a href="#_internalexternal_hostname_configuration">internal hostnames</a> when connecting to the Conductor, Zookeeper, supervisors, or workers.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_accessing_depots_pstates_and_query_topologies_from_remote_java_clients"><a class="anchor" href="#_accessing_depots_pstates_and_query_topologies_from_remote_java_clients"></a>Accessing depots, PStates, and query topologies from remote Java clients</h2>
<div class="sectionbody">
<div class="paragraph">
<p>On the <a href="depots.html#_depot_client_api" class="page">depot</a>, <a href="pstates.html#_using_pstate_clients" class="page">PState</a>, and <a href="query.html#_query_topology_client" class="page">query topology</a> pages, you saw how to use Java-based depot, PState, and query topology clients to programatically interact with modules on a Rama cluster. Let’s now take a look at how to get ahold of those clients.</p>
</div>
<div class="paragraph">
<p>Depot, PState, and query topology clients are retrieved using <a href="https://redplanetlabs.com/javadoc/com/rpl/rama/RamaClusterManager.html">RamaClusterManager</a>. A <code>RamaClusterManager</code> instance is told how to connect to a Rama cluster and then has methods to create the desired clients.</p>
</div>
<div class="paragraph">
<p>To create a <code>RamaClusterManager</code>, use the static methods <code>open</code> or <code>openInternal</code>. Both are exactly the same, except the former uses external hostnames and the latter uses internal hostnames. If you aren’t configuring separate internal and external hostnames in your <code>rama.yaml</code> files, it doesn’t matter which one you use.</p>
</div>
<div class="paragraph">
<p>The minimal information <code>RamaClusterManager</code> needs to know is the host and port of the Conductor node managing the cluster. The zero-arity versions of <code>open</code> and <code>openInternal</code> retrieve that configuration from the <code>rama.yaml</code> file on the classpath of the client.</p>
</div>
<div class="paragraph">
<p>There’s also a one-arity version of those methods that allow you to pass in those configs manually. These versions of the methods will still read in the <code>rama.yaml</code> file on the classpath if it exists, but the manual config will take precedence. Here’s an example of usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Map config = <span class="hljs-keyword">new</span> HashMap();
config.put(<span class="hljs-string">"conductor.host"</span>, <span class="hljs-string">"1.2.3.4"</span>);
RamaClusterManager manager = RamaClusterManager.open(config);</code></pre>
<div class="source-toolbox"><span class="source-lang">java</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>If you’re using any <a href="serialization.html" class="page">custom serializations</a>, you would also configure those with the <code>"custom.serializations"</code> key. That’s described more <a href="serialization.html#_ramacustomserialization_interface" class="page">in this section</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_launching_modules"><a class="anchor" href="#_launching_modules"></a>Launching modules</h2>
<div class="sectionbody">
<div class="paragraph">
<p>New modules are launched using the Rama CLI’s <code>deploy</code> command. Here’s an example of usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">rama deploy \
--action launch \
--jar target/my-application.jar \
--module com.mycompany.MyModule \
--tasks 64 \
--threads 16 \
--workers 8 \
--replicationFactor 3</code></pre>
<div class="source-toolbox"><span class="source-lang">text</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p><code>--action launch</code> specifies this is a deploy of a new module as opposed to an update of an existing module. You’ll see the details of updating an existing module in the next section.</p>
</div>
<div class="paragraph">
<p>The <code>--tasks</code> flag specifies the number of <a href="terminology.html#_task" class="page">tasks</a> in the module. The number of tasks specified must be a power of two.</p>
</div>
<div class="paragraph">
<p><code>--threads</code> specifies the number of <a href="terminology.html#_task_group_task_thread" class="page">task threads</a> for the module, and <code>--workers</code> specifies the number of <a href="terminology.html#_worker" class="page">worker processes</a>. These can be any positive number and do not have to be a power of two. Rama will spread tasks as evenly as possible across task threads, and it will spread task threads as evenly as possible across workers. In this process it also balances the number of tasks per worker as best as possible. The number of tasks must be greater than or equal to the number of threads, and the number of threads must be greater than or equal to the number of workers.</p>
</div>
<div class="paragraph">
<p>If you specify <code>--threads</code> and <code>--workers</code> as a power of two, then load will be perfectly distributed across all your workers. If not, then some workers will have higher loads than others. For example if you have 64 tasks, nine threads, and nine workers, then eight workers will have seven tasks and one worker will have eight tasks. That one worker will process about 14% more load than the other workers. It’s inevitable to eventually have skewed load like this in a module deployment since you’re likely to only increase the number of resources by a small amount when you scale (e.g. 25%). Note that the more tasks you have in your module, the less the skew will be. However, there’s overhead per task so you don’t want too many tasks. We recommend starting off with no more than 32 tasks per thread.</p>
</div>
<div class="paragraph">
<p>Unlike <code>--tasks</code>, <code>--threads</code>, and <code>--workers</code>, <code>--replicationFactor</code> is not a required flag. The default <a href="terminology.html#_replication_factor" class="page">replication factor</a> is one, but we recommend using a higher replication factor for fault-tolerance. The number of JVM processes that will exist for a module deployment is the replication factor multiplied by the number of workers specified. Correspondingly, the number of threads that will exist is the replication factor multiplied by the number of threads specified. Each task thread is duplicated by the amount of the replication factor, and two task thread replicas will never exist on the same node. In this example there will be 24 JVM processes deployed across the cluster.</p>
</div>
<div class="paragraph">
<p>The <code>--jar</code> flag specifies where the module definition exists, and <code>--module</code> specifies the class implementing the module. A module’s class is the same as the module’s name by default, but if the module definition overrides <a href="https://redplanetlabs.com/javadoc/com/rpl/rama/RamaModule.html#getModuleName--">getModuleName</a> they will be different. Most other commands in the Rama CLI take in the module name as input, not the module class.</p>
</div>
<div class="paragraph">
<p>If using the <a href="clj-defining-modules.html" class="page">Clojure API</a>, <code>--module</code> should refer to the namespace-qualified var defining the module, like <code>com.mycompany/FooModule</code>.</p>
</div>
<div class="paragraph">
<p>The jar you submit must contain your module definition as well as all libraries you’re using that aren’t already provided by Rama. We’ll show one way to build such a jar in the next section.</p>
</div>
<div class="paragraph">
<p>A module deploy can also target supervisors with a particular label, which is useful if the module has particular resource requirements. See <a href="heterogenous-clusters.html" class="page">Heterogenous clusters</a> for more details.</p>
</div>
<div class="sect2">
<h3 id="_building_an_uberjar"><a class="anchor" href="#_building_an_uberjar"></a>Building an uberjar</h3>
<div class="paragraph">
<p>To submit a module to Rama for either launch or update, you’ll need to build an uberjar. This is also sometimes referred to as "jar with dependencies".</p>
</div>
<div class="paragraph">
<p>Many tools have the capability to build jars like this. One plugin you can use with Maven is called <code>maven-assembly-plugin</code>. Here’s an example <code>pom.xml</code> to build an uberjar including <code>rama-helpers</code> as a dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span>
         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mycompany<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>myapplication<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">repositories</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>nexus-releases<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://nexus.redplanetlabs.com/repository/maven-public-releases<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">repositories</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.rpl<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rama<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.22.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.rpl<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rama-helpers<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.10.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">finalName</span>&gt;</span>myapplication<span class="hljs-tag">&lt;/<span class="hljs-name">finalName</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">descriptorRefs</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">descriptorRef</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">descriptorRefs</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>make-assembly<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">phase</span>&gt;</span>package<span class="hljs-tag">&lt;/<span class="hljs-name">phase</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>single<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span></code></pre>
<div class="source-toolbox"><span class="source-lang">xml</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Then, to build an uberjar you simply run <code>mvn package</code>. The uberjar for this example will be located at <code>target/myapplication-jar-with-dependencies.jar</code>.</p>
</div>
<div class="paragraph">
<p>Critical to this configuration is setting the scope of the <code>rama</code> dependency to <code>provided</code>. This excludes Rama from being included in the uberjar, which could blow up the size of the uberjar by over 100x.</p>
</div>
<div class="paragraph">
<p>For details on accessing the Red Planet Labs Maven repository, see <a href="downloads-maven-local-dev.html" class="page">this page</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_worker_configurations_and_dynamic_options"><a class="anchor" href="#_worker_configurations_and_dynamic_options"></a>Worker configurations and dynamic options</h3>
<div class="paragraph">
<p>Rama exposes a number of knobs to tweak the behavior of workers. These are split into "configurations", which are values that can only be set on module launch or update, and "dynamic options", which are values that can be modified at any time and take effect nearly instantly. Dynamic options are usually modified through the <a href="#_cluster_ui">Cluster UI</a>.</p>
</div>
<div class="paragraph">
<p>The full list of worker configurations is listed <a href="all-configs.html" class="page">here</a>. The two worker configurations that are frequently relevant are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>worker.child.opts</code>: options string to JVM process for Worker processes for this module instance, commonly used to configure memory and GC. Defaults to <code>"-Xmx4096m"</code>.</p>
</li>
<li>
<p><code>custom.serializations</code>: list of <a href="serialization.html" class="page">custom serializations</a> to configure for this module.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Worker configurations are set as part of the <code>rama deploy</code> command with the flag <code>--configOverrides</code>. The flag accepts a path to a YAML file containing the configurations. For example, you could use the flag <code>--configOverrides overrides.yaml</code> and have a file in the same directory <code>overrides.yaml</code> with the following contents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">worker.child.opts: "-Xmx8192m"
custom.serializations:
  - "com.rpl.myapp.serialization.MySerialization"
  - "com.rpl.myapp.serialization.MyOtherSerialization"</code></pre>
<div class="source-toolbox"><span class="source-lang">text</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Worker configurations are set at the <a href="terminology.html#_module_instance" class="page">module instance</a> level. So if you want the same configurations to apply to future iterations of the module, you have to specify them with each module update. Module updates are described fully below.</p>
</div>
<div class="paragraph">
<p>Dynamic options, on the other hand, are set at the module level. So they apply to the current module instance as well as future instances. There are four categories of dynamic options: module, topology, depot, and PState. They are arranged in the following hierarchy:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/diagrams/operating-diagrams/dynamic-options.png" alt="dynamic options">
</div>
</div>
<div class="paragraph">
<p>Kind of like CSS, a dynamic option can be set at any level at or above its category. For example, a depot option can be set for a particular depot or for the module as a whole, but a module option can only be set at the module level. The dynamic option value used is the most specific one relevant towards a particular context. For example, a depot <code>"*myDepot"</code> looking for the value for the depot option <code>depot.max.fetch</code> would first see if that option is set for <code>"*myDepot"</code>. If not, it would check if that option is set for the module. If not, it uses the default value for the option.</p>
</div>
<div class="paragraph">
<p>Besides modifying dynamic options in the Cluster UI, dynamic options can also be set on launch with the flags <code>--moduleOptions</code>, <code>--topologyOptions</code>, <code>--depotOptions</code>, and <code>--pstateOptions</code>. The syntax for module options is <code>{dynamic option}={value};{dynamic option}={value};…​</code>, and the syntax for the other options is <code>{entity},{dynamic option}={value};{entity},{dynamic option}={value};…​</code>. For example, here’s a module launch command that sets some dynamic options for each level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">rama deploy \
--action launch \
--jar target/my-application.jar \
--module com.mycompany.MyModule \
--tasks 128 \
--threads 32 \
--workers 8 \
--replicationFactor 2 \
--moduleOptions 'replication.streaming.timeout.millis=20000;pstate.batch.buffer.limit=10' \
--topologyOptions 'myTopology,topology.combiner.limit=99' \
--depotOptions '*depot,depot.max.fetch=251' \
--pstateOptions '$$mb,pstate.reactivity.queue.limit=499;$$stream,pstate.reactivity.queue.limit=89'</code></pre>
<div class="source-toolbox"><span class="source-lang">text</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Setting dynamic options on launch like this has them take effect from the moment the worker processes start.</p>
</div>
</div>
<div class="sect2">
<h3 id="_isolation_scheduler"><a class="anchor" href="#_isolation_scheduler"></a>Isolation scheduler</h3>
<div class="paragraph">
<p>By default Rama spreads module workers evenly across the cluster. When it runs out of empty nodes, it will assign new workers to nodes alongside workers from other modules.</p>
</div>
<div class="paragraph">
<p>The internal routine for assigning workers to nodes is called a "scheduler", and the default one is called the "dev scheduler". The dev scheduler is convenient for development, but we don’t recommend using it for a production cluster. Modules being deployed to the same machines will compete for resources and make it hard to plan for how many resources are needed.</p>
</div>
<div class="paragraph">
<p>A Rama cluster can be configured with another scheduler called the "isolation scheduler". With this scheduler you configure how many nodes should be assigned to a module, and Rama will dedicate those nodes to that module. Modules are never deployed on the same nodes as any other module.</p>
</div>
<div class="paragraph">
<p>Unlike the other parallelism configurations for a module (tasks, threads, workers), the number of nodes for a module is configured in the Conductor’s <code>rama.yaml</code> file. Since a Rama cluster is a shared environment for running many independent applications, it’s important users consider carefully how many resources they need rather than just use all the resources available. Configuring the number of nodes for a module in the Conductor’s <code>rama.yaml</code> allows the operator of a cluster (the person or team responsible for the Conductor <code>rama.yaml</code>) to make sure the users of a cluster are efficient with resource usage.</p>
</div>
<div class="paragraph">
<p>Here’s an example of configuring the isolation scheduler:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"><span class="hljs-attr">conductor.assignment.mode:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">isolation</span>
  <span class="hljs-attr">modules:</span>
    <span class="hljs-attr">com.mycompany.Module1:</span> <span class="hljs-number">4</span>
    <span class="hljs-attr">com.mycompany.AnotherModule:</span> <span class="hljs-number">8</span>
    <span class="hljs-attr">com.mycompany.Module2:</span> <span class="hljs-number">54</span></code></pre>
<div class="source-toolbox"><span class="source-lang">yaml</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>The <code>type</code> key for <code>conductor.assignment.mode</code> can be <code>isolation</code> or <code>dev</code>. <code>modules</code> is specific to <code>isolation</code> and sets how many nodes to allocate to each of those module names. The Conductor must be restarted whenever these configurations are changed in order to pick up the changes (we have it on our roadmap to make this more dynamic).</p>
</div>
<div class="paragraph">
<p>When the isolation scheduler is configured, only modules listed under <code>modules</code> are allowed to be launched. Trying to deploy an unlisted module will get an exception. Likewise, if you try to deploy a listed module but the cluster doesn’t have enough free nodes for the isolation settings, the deploy will get an exception. On deploy of a configured module Rama will evenly spread out the workers/tasks/threads across its dedicated nodes.</p>
</div>
<div class="paragraph">
<p>A cluster currently configured with the dev scheduler can be transitioned to one using the isolation scheduler. When the Conductor’s <code>rama.yaml</code> is changed and the Conductor process restarted, no currently running modules will be affected. The isolation settings will apply to all future module launches and updates. So if a module is currently running on nodes shared with other modules, when you update that module it will be transferred to isolated nodes according to the configuration. The easiest way to transition modules in this scenario onto isolated nodes is to run a <a href="#_scaling_modules">scaling command</a> with no changes to threads/workers.</p>
</div>
<div class="paragraph">
<p>The isolation scheduler can also be used to target particular supervisor labels for modules. See <a href="heterogenous-clusters.html" class="page">Heterogenous clusters</a> for more details.</p>
</div>
<div class="paragraph">
<p>At a high level, we recommend having one cluster for development and one cluster for production. The development cluster should use the default dev scheduler, and the production cluster should use the isolation scheduler.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_updating_modules"><a class="anchor" href="#_updating_modules"></a>Updating modules</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A module currently running on a Rama cluster can be updated to a new version with the <code>rama deploy</code> command. Here’s an example of usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">rama deploy \
  --action update \
  --jar myapplication-1.2.1.jar \
  --module 'com.mycompany.MyModule' \
  --configOverrides overrides.yaml</code></pre>
<div class="source-toolbox"><span class="source-lang">text</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Whereas a module launch uses the <code>launch</code> action, a module update uses the <code>update</code> action. Like module launch, the <code>--jar</code> and <code>--module</code> flags specify the location of the module code and the module class to deploy. Parallelism settings (tasks, threads, workers) are not specified on module update since the new version of the module will use the same settings as the old module. However, any config overrides from a previous module deploy <strong>are not inherited</strong>. So those must be specified with each module update (e.g. custom serializations, worker JVM settings). The same also holds for a targeted <a href="heterogenous-clusters.html" class="page">supervisor label</a> if the module has one.</p>
</div>
<div class="paragraph">
<p>A module update can perform any change to a module: updating topology code, adding new topologies, removing topologies, adding new PStates/depots, or removing PStates/depots. Existing PStates can also be <a href="pstates.html#_migrations" class="page">migrated</a> to a new schema. The deploy will validate the changes you’re making are valid: for example, if you try to remove a PState or depot that’s currently depended on by another module, the update will not go through.</p>
</div>
<div class="paragraph">
<p>The naming of depots and PStates in a module definition determine what carries over to the new module instance. Any depot or PState defined in the old module that’s not defined in the new module is considered destroyed. There’s currently no way to rename a depot or PState in a module update.</p>
</div>
<div class="paragraph">
<p>Because removing a PState or depot is destructive – Rama will delete all partitions from the filesystems of worker nodes –&nbsp;Rama requires you to explicitly specify objects being deleted as part of an update command. Here’s an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">rama deploy \
  --action update \
  --jar myapplication-1.2.1.jar \
  --module 'com.mycompany.MyModule' \
  --configOverrides overrides.yaml \
  --objectsToDelete '$$p,*someDepot,$$anotherPState'</code></pre>
<div class="source-toolbox"><span class="source-lang">text</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>The specified <code>--objectsToDelete</code> must match exactly the objects being removed from the module or the update will throw an exception.</p>
</div>
<div class="paragraph">
<p>A module update is a highly coordinated operation to transition from one <a href="terminology.html#_module_instance" class="page">module instance</a> to the next. In general, it works by launching the worker processes for the updated module instance on the same machines as the old module instance. It then gracefully transitions data and read/write responsibilities between the two instances in order to minimize downtime.</p>
</div>
<div class="paragraph">
<p>PState clients have zero downtime during the transition and will automatically retarget queries to the new module instance when it’s ready. This includes regular queries as well as reactive queries. Existing reactive queries will automatically perform a resync to the new instance. Depot appends may have some downtime where appends are buffered clientside while waiting for the new instance to be ready to accept appends. Likewise, stream and microbatch processing may be offline for a brief time during the transition. The downtime depends on the number of PStates and size of the individual PStates that are being transitioned, and can be anywhere from two seconds to thirty seconds (we have it on our roadmap to implement zero-downtime module update for appends and processing as well).</p>
</div>
<div class="paragraph">
<p>The one case where module update doesn’t deploy the new worker processes on the same machines as the old module instance is when transitioning from the dev scheduler to the isolation scheduler. In this case, it may be forced to relocate workers in order to achieve isolation. There’s no difference in semantics and all data will be transitioned to the new machines.</p>
</div>
<div class="paragraph">
<p>During a module update, you’ll see a variety of statuses for the module in the Cluster UI. You’ll see states like <code>[:updating-next-assigned]</code>, <code>[:updating-prepare-handover]</code>, and many others. These are intermediate states as the Conductor shepherds along the update process to perform the graceful transition. When it finishes the old module instance will be destroyed and the module status will go back to <code>[:running]</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scaling_modules"><a class="anchor" href="#_scaling_modules"></a>Scaling modules</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Rama CLI provides the command <code>rama scaleExecutors</code> to change the number of workers, number of threads, or replication factor of a module. It can be used to increase or decrease any of these values.</p>
</div>
<div class="paragraph">
<p>Here’s an example of using this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">rama scaleExecutors \
--module com.mycompany.MyModule \
--threads 90 \
--workers 30 \
--replicationFactor 3</code></pre>
<div class="source-toolbox"><span class="source-lang">text</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Unlike the <code>rama deploy</code> command, <code>--module</code> refers to the module name and not the module class. The rest of the flags specify the new values for the number of threads, number of workers, and replication factor.</p>
</div>
<div class="paragraph">
<p><code>--threads</code>, <code>--workers</code>, and <code>--replicationFactor</code> are all optional. If unspecified, the value from the current module instance will be used. You can even run <code>rama scaleExecutors</code> without specifying any of these flags (called "no-op scaling") which is useful when transitioning a cluster from the dev scheduler to the isolation scheduler.</p>
</div>
<div class="paragraph">
<p>All other aspects about a module are preserved when scaling, particularly the module instance config. So whereas with a module update you must specify the module instance config each time, with scaling it carries over to the new module instance. This is because a module update could be changing or deleting configs, whereas a scaling operation doesn’t change the module itself.</p>
</div>
<div class="paragraph">
<p>Scaling takes longer to complete than module update because Rama needs to copy data around to move tasks to new nodes. The scaling operation will still colocate the new module instance as much as possible with the old module instance to minimize this copying, but some copying will be necessary.</p>
</div>
<div class="sect2">
<h3 id="_scaling_tips"><a class="anchor" href="#_scaling_tips"></a>Scaling tips</h3>
<div class="paragraph">
<p>A few of the metrics in the <a href="#_cluster_ui">Cluster UI</a> can help you determine when to scale. The first is the "Task groups load" metric, which tells you what percentage of time on each task thread is spent executing events versus waiting for events to arrive. Here’s an example:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/task-groups-load.png" alt="task groups load">
</div>
</div>
<div class="paragraph">
<p>As a rule of thumb, you want to keep task group load below 70% for all task threads in order to have room to handle variance in load. Additionally, task group load doesn’t tell the full picture since there are other threads that Rama runs that can be using up CPU resources. Other processes on the machine can also use up CPU. So if your task group load is 65%, it’s possible the other 35% of the load on that CPU is taken up by other threads/processes. In this case you would need to scale soon.</p>
</div>
<div class="paragraph">
<p>The microbatch and stream topology "progress" metric can also be an indicator you need to scale. For example:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/microbatch-progress.png" alt="microbatch progress">
</div>
</div>
<div class="paragraph">
<p>In this image the microbatch topology is keeping up so the "progress" and "size" lines are on top of one another. If those lines diverge, then you don’t have enough resources and need to scale.</p>
</div>
<div class="paragraph">
<p>The best way to know when you’ll need to scale is by testing your modules on a dev cluster. In this environment you can measure the exact relationship between max throughput and the number of nodes allocated to a module. When testing this way, you’ll also want to mimic the expected number of incoming PState queries and query topology invokes since those also use up resources.</p>
</div>
</div>
<div class="sect2">
<h3 id="_task_scaling"><a class="anchor" href="#_task_scaling"></a>Task scaling</h3>
<div class="paragraph">
<p>Currently Rama does not support changing the number of tasks for a module, though adding support for this is high priority for us. Since the number of threads must be less than or equal to the number of tasks, and the number of workers must be less than or equal to the number of threads, the number of tasks represents an upper limit to how high a module can be scaled.</p>
</div>
<div class="paragraph">
<p>When setting the number of tasks for a module, you should choose a number in anticipation of how much your application will grow in the next couple years. Note that there is some overhead per task, so you shouldn’t set the number of tasks too high. Having something like 16 tasks per thread is reasonable though.</p>
</div>
<div class="paragraph">
<p>Until first-class task scaling is implemented, there are ways to manually increase the number of tasks. One way is to launch a new module with the same code and more tasks that recomputes all PStates from scratch. This new module would set up a mirror to each depot and set up each topology to start processing each depot from the beginning. The processing would also make new depots that are a copy of the old depots. When the new module gets close to catching up, you would stop processing and all depot appends on the original module. Once it’s fully caught up, you would update the new module to remove the mirrors and source data from its own depots. Lastly, you would redirect clients to get depot and PState clients from the new module.</p>
</div>
<div class="paragraph">
<p>This approach only works if your processing is deterministic, which may not be the case if your processing makes use of any random numbers (such as UUIDs). An alternative approach is to repartition the PStates directly by making a special topology in the new module to iterate through the original PStates and repartition them to the new module’s PStates.</p>
</div>
<div class="paragraph">
<p>Of course, both these approaches require careful coding and significant downtime which is why implementing first-class task scaling is a high priority for us.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_activating_self_monitoring"><a class="anchor" href="#_activating_self_monitoring"></a>Activating self-monitoring</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Rama provides a special "monitoring module" that will automatically collect, analyze, index, and visualize detailed telemetry on all modules running on a cluster. This telemetry is displayed throughout dozens of charts on the <a href="#_cluster_ui">Cluster UI</a> and is invaluable for diagnosing and debugging issues.</p>
</div>
<div class="paragraph">
<p>To active self-monitoring, all you have to do is deploy the monitoring module using a command like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">rama deploy \
  --action launch \
  --systemModule monitoring \
  --tasks 32 \
  --threads 8 \
  --workers 4 \
  --replicationFactor 2</code></pre>
<div class="source-toolbox"><span class="source-lang">text</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>The only difference in the <code>rama deploy</code> command here as compared to deploying your own modules is the lack of a <code>--jar</code> flag and using <code>--systemModule</code> instead of <code>--module</code>. Otherwise, this module is deployed and operated just like any other module, and you should make sure to scale the module as appropriate as the number of modules on the cluster grows. As a rule of thumb, the monitoring module should have one worker per 70 workers from other modules.</p>
</div>
<div class="paragraph">
<p>If you’re using the isolation scheduler, you can reference the isolation module in the config as <code>monitoring</code>. For example, this could be the isolation config in the <code>rama.yaml</code> for the Conductor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"><span class="hljs-attr">conductor.assignment.mode:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">isolation</span>
  <span class="hljs-attr">modules:</span>
    <span class="hljs-attr">monitoring:</span> <span class="hljs-number">2</span>
    <span class="hljs-attr">com.mycompany.MyModule:</span> <span class="hljs-number">8</span>
    <span class="hljs-attr">com.mycompany.AnotherModule:</span> <span class="hljs-number">26</span></code></pre>
<div class="source-toolbox"><span class="source-lang">yaml</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>We highly recommend running the monitoring module on every cluster since it provides a huge amount of fine-grained, useful information and uses a relatively small amount of resources.</p>
</div>
<div class="sect2">
<h3 id="_configuring_telemetry_retention"><a class="anchor" href="#_configuring_telemetry_retention"></a>Configuring telemetry retention</h3>
<div class="paragraph">
<p>The PStates the monitoring module maintains accumulate a fair amount of disk space, especially for telemetry at the minute granularity. The monitoring module can be configured to delete old telemetry at any granularity in order to reduce disk space. This is done with the <code>rama monitoringConfig</code> command. To set the retention window to only keep thirty days of data at minute granularity, you would use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">rama monitoringConfig --setRetention 60,2592000</code></pre>
<div class="source-toolbox"><span class="source-lang">text</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Times are specified in seconds, so this says to keep 2592000 seconds of data (thirty days) at the 60 second granularity.</p>
</div>
<div class="paragraph">
<p>You can run <code>rama monitoringConfig help</code> to see the full set of options available for configuring retention.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cluster_ui"><a class="anchor" href="#_cluster_ui"></a>Cluster UI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Cluster UI is a web-based interface providing a wealth of information on a Rama cluster and modules running on that cluster. By default it runs on port 8888 on the Conductor, but the port can be changed in the Conductor’s <code>rama.yaml</code> via the <code>cluster.ui.port</code> config.</p>
</div>
<div class="paragraph">
<p>Let’s take a brief tour of the information available in the Cluster UI. We won’t look at every page, but we’ll look at enough to give a general idea of what’s available. Here’s the main page of the Cluster UI:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/cluster-ui-main.png" alt="cluster ui main">
</div>
</div>
<div class="paragraph">
<p>All deployed modules are listed along with their current state. The state refers to how the module is progressing through module operations such as launch, update, or scaling. When these operations have completed the module will be in the <code>[:running]</code> state. Sometimes you may see modules in the <code>[:leadership-balancing]</code> state. In this state Rama has found an imbalance of leaders across module workers and forces the minimal number of leader switches necessary in order to balance leadership. This is important since all work goes through leaders, so an imbalance would cause unnecessary skew of load for a module. Leaders can become imbalanced when a cluster has node outages.</p>
</div>
<div class="paragraph">
<p>The <code>Supervisors</code> tab lists all Supervisors for the cluster, and clicking on a Supervisor displays general information and telemetry for the node. The telemetry includes memory usage and garbage collection stats for the Supervisor and a graph of the system load average over time. The <code>Conductor</code> tab shows similar telemetry for the Conductor process and node.</p>
</div>
<div class="paragraph">
<p>On the top-right of the UI you can change the time window for charts, such as looking at the past hour of data or looking at the past year of data. The monitoring module computes and indexes every stat at multiple granularities to be able to support these large time windows efficiently. When the <code>autorefresh</code> button is on, all information on a page will refresh every ten seconds.</p>
</div>
<div class="paragraph">
<p>Clicking on a module brings up the module page. For example:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/cluster-ui-module.png" alt="cluster ui module">
</div>
</div>
<div class="paragraph">
<p>This page lists each <a href="terminology.html#_module_instance" class="page">module instance</a> for the module. You’ll only see one module instance here unless the module is undergoing a transition like module update or module scaling. The "read target" and "append target" refer to internal flags used to coordinate a module transition.</p>
</div>
<div class="paragraph">
<p>On this page you can also set module level dynamic options. The ⓘ symbols, when hovered over, display a short string describing the dynamic option. You can set topology, depot, and PState level dynamic options on the pages for those entities.</p>
</div>
<div class="paragraph">
<p>Clicking on the module instance brings up this page:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/cluster-ui-module-instance.png" alt="cluster ui module instance">
</div>
</div>
<div class="paragraph">
<p>On this page you can see all the depots, PStates, and topologies defined for this module instance. You’ll also see internal PStates used by Rama in its implementation in the PStates section. Some of these PStates are in-memory and unreplicated (e.g. buffers for two-phase aggregation), and some of them are durable and replicated (e.g. stream topology progress state).</p>
</div>
<div class="paragraph">
<p>Below those are many charts aggregating telemetry for the module instance across all workers. For example:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/cluster-ui-module-instance-telemetry1.png" alt="cluster ui module instance telemetry1">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/cluster-ui-module-instance-telemetry2.png" alt="cluster ui module instance telemetry2">
</div>
</div>
<div class="paragraph">
<p>"Task groups load" is one of the most important metrics. It represents the percentage of time a task thread spends executing events vs. sitting idle waiting for events to arrive. It can be a strong indicator for when a module needs to be scaled. On the module instance page, you can see the average task thread load across all task threads in the module as well as the maximum task thread load across all task threads.</p>
</div>
<div class="paragraph">
<p>The "System event throughput (sampled)" and "System event execution duration (sampled)" metrics provide extremely fine-grained information on what’s going on inside a module. A random sample of events in Rama is categorized and timed, and these charts allow you to explore the throughput and durations for all the categories. The sample rate can be adjusted with the dynamic option <code>worker.event.telemetry.sampling.rate</code>, but keep in mind that adjusting it too high will have a noticeable impact on module performance. The events displayed here include both the events executing module code as well as internal events supporting the execution of modules (e.g. replication, telemetry collection, cleanup events).</p>
</div>
<div class="paragraph">
<p>The event categories are organized into a hierarchy, and you can see the aggregated metrics for any node in that hierarchy by selecting that node in the drop-down on the top-right of the chart. For example, selecting in that dropdown <code>[:all :replication]</code> shows the combined stats for all replication related events. Selecting <code>[:all :replication :leader :forwarding]</code> shows stats only for replication events related to leaders forwarding replog entries to followers. Categories containing <code>:topology-event</code> are events that are executing module code (e.g. <code>[:all :microbatch :whoToFollow :topology-event]</code> is the category for events executing the topology named "whoToFollow").</p>
</div>
<div class="paragraph">
<p>These are only a few of the metrics available on this page. All the charts available via the Cluster UI are invaluable for diagnosing any issues that occur.</p>
</div>
<div class="paragraph">
<p>The <code>Workers</code> link lets you navigate to a page specific to each worker, where you’ll see the same telemetry as the module instance page except specific to that worker. If you had skew in the amount of data being processed by each worker, you’d be able to see that by comparing the worker pages.</p>
</div>
<div class="paragraph">
<p>Clicking on depots, PStates, or topologies navigates to pages specific to those entities. Those pages have their own telemetry specific to them. For example:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/cluster-ui-depot-telemetry.png" alt="cluster ui depot telemetry">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/cluster-ui-pstate-telemetry.png" alt="cluster ui pstate telemetry">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/cluster-ui-microbatch-telemetry.png" alt="cluster ui microbatch telemetry">
</div>
</div>
<div class="paragraph">
<p>On microbatch topology pages, you’ll also see a button you can use to "Pause" or "Resume" the topology. This is the only action available in the Cluster UI, as currently all other actions are performed through the Rama CLI.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_decommissioning_a_node"><a class="anchor" href="#_decommissioning_a_node"></a>Decommissioning a node</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Machines can fail for all sorts of reasons. The Rama CLI command for module update provides the option <code>--reassignSupervisors</code> to get workers currently assigned to a failed machine relocated to another node. Rama never reassigns workers automatically and will only assign workers in response to a module operation (module launch, module update, or module scaling).</p>
</div>
<div class="paragraph">
<p>The additional argument given to module update is used like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">./rama deploy \
   --action update \
   --reassignSupervisors 0a150494-7951-523f-f30a-8539e3b44892 \
   --jar test-0.0.1.jar \
   --module com.mycompany.MyModule \
   --configOverrides overrides.yaml</code></pre>
<div class="source-toolbox"><span class="source-lang">text</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Every Supervisor has a unique ID which you can look up on the Cluster UI. Running this command will relocate workers for the module running on that node to other nodes. The command respects the isolation scheduler, and it requires sufficient spare capacity be available for moving the workers. You can reassign multiple supervisors at once by passing a comma-separated list to <code>--reassignSupervisors</code>.</p>
</div>
<div class="paragraph">
<p>If you have multiple modules with workers assigned to that node, you’ll need to run a separate module update for each module.</p>
</div>
<div class="paragraph">
<p>The <code>reassignSupervisors</code> option has no reliance on communicating with workers on the target nodes or executing any computation on those nodes. It assumes the worst case that the processes are down, unresponsive, or faulty in some way. It’s recommended you kill the Supervisors and all worker processes on those nodes before running the update command to ensure other modules don’t get assigned to those nodes later.</p>
</div>
<div class="paragraph">
<p>The reassign command as shown also requires that workers on the target node not be the only members of the <a href="terminology.html#_isr" class="page">ISR</a> for any of their <a href="terminology.html#_task_group_task_thread" class="page">task groups</a>. This can happen if the replication factor is one or if all other replicas happen to be in the <a href="terminology.html#_osr" class="page">OSR</a>.</p>
</div>
<div class="paragraph">
<p>You can force the reassign to relocate all workers on a node regardless of ISR status with the flag <code>--forceReassign</code>. The reason this isn’t automatic is because reassigning a task group that’s the only member of its ISR means all data for PState and depot partitions on that task group is lost. Because Rama presumes the worst case of the node being inaccessible or broken in some way, it doesn’t try to transfer any data off of that node in this case. Keep in mind that with replication and a sensible <a href="terminology.html#_min_isr" class="page">Min-ISR setting</a>, this scenario is extremely unlikely. We recommend a replication factor of three and a min-ISR of two.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_upgrading_a_rama_cluster_to_a_new_version"><a class="anchor" href="#_upgrading_a_rama_cluster_to_a_new_version"></a>Upgrading a Rama cluster to a new version</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Rama has built-in mechanisms for upgrading a cluster to a new Rama version and transitioning all data between the old and new versions. There are two ways to upgrade a Rama cluster: "patch version upgrades" and "atomic version upgrades". During a patch version upgrade the Rama cluster and modules are fully operational, but it can only be done when only the patch version changes (e.g. 0.13.0 to 0.13.1). An atomic version upgrade can be done between any Rama versions and requires taking some downtime on the cluster. Though if you prepare, the whole process for an atomic version upgrade can be done in 5-10 minutes.</p>
</div>
<div class="sect2">
<h3 id="_patch_version_upgrade"><a class="anchor" href="#_patch_version_upgrade"></a>Patch version upgrade</h3>
<div class="paragraph">
<p>A patch version upgrade is a rolling upgrade procedure where one node is upgraded at a time. If you follow the procedure below and are running your modules with a replication factor of at least two, the cluster will remain fully operational through the whole process (no downtime on depot appends, queries, topology processing, or anything else).</p>
</div>
<div class="paragraph">
<p>The steps for a patch version upgrade are the following. If modules are running without replication, skip the steps for the <code>disallowLeaders</code> and <code>allowLeaders</code> commands.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>For each supervisor ID in the cluster (supervisor IDs for each node can be found in the "Supervisors" tab on the Cluster UI):</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Run the CLI command <code>./rama disallowLeaders &lt;supervisorId&gt;</code></p>
</li>
<li>
<p>Turn off process supervision for the supervisor (e.g. <code>systemd</code>).</p>
</li>
<li>
<p>Kill all supervisor and worker processes on that node using <code>kill -9</code>.</p>
</li>
<li>
<p>Upgrade the Rama release on the node, making sure the <code>rama.yaml</code> file points to the same <code>local.dir</code> as before.</p>
</li>
<li>
<p>Turn process supervision back on, and make sure the supervisor and all workers restart.</p>
</li>
<li>
<p>Run the CLI command <code>./rama allowLeaders &lt;supervisorId&gt;</code></p>
</li>
<li>
<p>Wait one minute to allow the cluster to rebalance leaders back onto this node.</p>
</li>
</ol>
</div>
</li>
<li>
<p>On the Conductor node:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Turn off process supervision for the conductor (e.g. <code>systemd</code>).</p>
</li>
<li>
<p>Kill the conductor process with <code>kill -9</code></p>
</li>
<li>
<p>Upgrade the Rama release on the node, making sure the <code>rama.yaml</code> file points to the same <code>local.dir</code> as before.</p>
</li>
<li>
<p>Turn process supervision back on, and make sure the conductor restarts.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Restart all clients with the Rama dependency updated to the new Rama version.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The upgrade of each supervisor node should take about 3-4 minutes. Most of that time is waiting for processes to launch. So for a 100 node cluster, this procedure should take about 5 to 7 hours.</p>
</div>
</div>
<div class="sect2">
<h3 id="_atomic_version_upgrade"><a class="anchor" href="#_atomic_version_upgrade"></a>Atomic version upgrade</h3>
<div class="paragraph">
<p>A module submitted to one Rama version isn’t compatible with a Rama version with a major or minor version difference, and part of the atomic upgrade process is resubmitting all modules with the new version. Likewise, clients are also only compatible with clusters at the same major and minor Rama version. So along with upgrading a cluster and all modules, all clients need to be upgraded as well.</p>
</div>
<div class="paragraph">
<p>The steps for upgrading a Rama cluster are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Shutdown the cluster using the <code>shutdownCluster</code> command from Rama CLI</p>
</li>
<li>
<p>Kill Conductor and Supervisor processes and process supervision</p>
</li>
<li>
<p>Unpack Rama release for the new version on all nodes</p>
</li>
<li>
<p>Configure <code>rama.yaml</code> in each Rama release with the same <code>local.dir</code> as the previous version</p>
</li>
<li>
<p>Start Conductor and Supervisor processes and process supervision for new version</p>
</li>
<li>
<p>Submit each module with the Rama CLI from the new version</p>
</li>
<li>
<p>Wait for the upgrade to complete</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let’s now expand on each of these steps.</p>
</div>
<div class="paragraph">
<p>The first step is shutting down the Rama cluster using the Rama CLI command <code>rama shutdownCluster</code>. For safety reasons, this command can only be run on the Conductor node. This command will gracefully bring down all worker processes, but it will not kill any Conductor or Supervisor processes. The shutdown process is complete when the Conductor page on the Cluster UI page says the Conductor state is <code>[:cluster-shutdown-complete]</code>. You must wait for the Conductor to reach this state before proceeding to the next step.</p>
</div>
<div class="paragraph">
<p>The next step is to shut down all Conductor and Supervisor processes. Since those should be run with a process supervision tool like <a href="https://en.wikipedia.org/wiki/Systemd">systemd</a>, Rama does not kill those processes itself. You should make sure to disable process supervision as well when bringing those processes down.</p>
</div>
<div class="paragraph">
<p>The next step is to unpack the new Rama release on all nodes. You should then configure its <code>rama.yaml</code> file and ensure the <code>local.dir</code> config specifies the same location as was used by the previous Rama version.</p>
</div>
<div class="paragraph">
<p>Next, start the Conductor and all Supervisor processes using your process supervision tool. These processes will go into "upgrade mode".</p>
</div>
<div class="paragraph">
<p>At this point, all modules need to be upgraded to the new version. The Cluster UI will display the list of modules that still need to be upgraded.</p>
</div>
<div class="paragraph">
<p>To upgrade a module, use the Rama CLI (from the new version) and run a command like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">rama deploy \
--action upgrade \
--jar target/my-application.jar \
--module com.mycompany.MyModule \
--configOverrides overrides.yaml</code></pre>
<div class="source-toolbox"><span class="source-lang">text</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>If there are any API changes with the new version, you’ll need to make those changes with the upgrade. And just like module update, the <code>--upgrade</code> command requires you to submit config overrides from scratch. Otherwise, things like custom serializations and worker child opts won’t be set properly on the upgraded module.</p>
</div>
<div class="paragraph">
<p>Upgraded modules must be identical to the prior module version in terms of PStates, depots, and topologies. The Conductor will reject an upgrade if there are any differences.</p>
</div>
<div class="paragraph">
<p>If you have the monitoring module deployed, that needs to be upgraded as well. The command for that is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">rama deploy --action upgrade --systemModule monitoring</code></pre>
<div class="source-toolbox"><span class="source-lang">text</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Once all modules have been upgraded, Rama will automatically perform any <a href="terminology.html#_metastore" class="page">metastore</a> or on-disk changes necessary. It will then launch workers for all the modules and resume normal operation.</p>
</div>
<div class="paragraph">
<p>Finally, be sure to upgrade all Rama clients to the new version as well so they can interact with the upgraded cluster.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary"><a class="anchor" href="#_summary"></a>Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Rama provides the tooling you need to operate clusters over long periods of time. Self-monitoring gives you insights to understand performance and diagnose issues. Module update and module scaling let you evolve running applications to incorporate new features, fix bugs, and handle increased load. Lastly, the <code>rama reassign</code> command lets you handle the need to decommission nodes when they go bad.</p>
</div>
<div class="paragraph">
<p>There’s a lot to learn about operating Rama clusters. The breadth of scope of what Rama does is far greater than most other software tools. But the alternative to using Rama is to use many different tools, sometimes dozens, each of which handles only a narrow function of building a backend. So although there may feel like a lot to learn to use Rama, it’s vastly simpler in the long run to operate one tool than many tools with inconsistent designs around how they work and how they’re operated.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
</footer>
<script type="text/javascript" src="../../_/js/main.js"></script>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async="" src="../../_/js/vendor/highlight.js"></script>
  

<table cellspacing="0" cellpadding="0" role="presentation" class="gstl_50 gssb_c" style="width: 217px; display: none; top: 50px; left: 1048px; position: absolute;"><tbody><tr><td class="gssb_f"></td><td class="gssb_e" style="width: 100%;"></td></tr></tbody></table></body></html>