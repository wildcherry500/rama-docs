<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Defining and using modules :: Red Planet Labs Documentation</title>
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
<!-- Google tag (gtag.js) -->
<script async="" src="//cse.google.com/adsense/search/async-ads.js"></script><script type="text/javascript" async="" src="https://www.googletagmanager.com/gtag/js?id=G-6FCG0W0TYJ&amp;l=dataLayer&amp;cx=c&amp;gtm=457e53h1za200&amp;tag_exp=102482433~102587591~102717422~102788824~102813109~102814060~102825837~102879719"></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-137231341-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6FCG0W0TYJ');
</script>
  <script src="https://www.google.com/cse/static/element/75c56d121cde450a/cse_element__en.js?usqp=CAM%3D" type="text/javascript"></script><link type="text/css" href="https://www.google.com/cse/static/element/75c56d121cde450a/default+en.css" rel="stylesheet"><link type="text/css" href="https://www.google.com/cse/static/style/look/v4/default.css" rel="stylesheet"><style type="text/css">.gsc-control-cse{font-family:arial, sans-serif}.gsc-control-cse .gsc-table-result{font-family:arial, sans-serif}.gsc-refinementsGradient{background:linear-gradient(to left,rgba(255,255,255,1),rgba(255,255,255,0))}.gsc-control-cse{border-color:#1a1a1a;background-color:#1a1a1a}input.gsc-input,.gsc-input-box,.gsc-input-box-hover,.gsc-input-box-focus{border-color:#DFE1E5}.gsc-search-button-v2,.gsc-search-button-v2:hover,.gsc-search-button-v2:focus{border-color:#3079ED;background-color:#4D90FE;background-image:none;filter:none}.gsc-search-button-v2 svg{fill:#FFFFFF}.gsc-tabHeader.gsc-tabhActive,.gsc-refinementHeader.gsc-refinementhActive{color:#1A73E8;border-color:#1A73E8;background-color:#FFFFFF}.gsc-tabHeader.gsc-tabhInactive,.gsc-refinementHeader.gsc-refinementhInactive{color:#666666;border-color:#666666;background-color:#FFFFFF}.gsc-webResult.gsc-result,.gsc-results .gsc-imageResult{border-color:#FFFFFF;background-color:#FFFFFF}.gsc-webResult.gsc-result:hover{border-color:#FFFFFF;background-color:#FFFFFF}.gs-webResult.gs-result a.gs-title:link,.gs-webResult.gs-result a.gs-title:link b,.gs-imageResult a.gs-title:link,.gs-imageResult a.gs-title:link b{color:#1155CC}.gs-webResult.gs-result a.gs-title:visited,.gs-webResult.gs-result a.gs-title:visited b,.gs-imageResult a.gs-title:visited,.gs-imageResult a.gs-title:visited b{color:#1155CC}.gs-webResult.gs-result a.gs-title:hover,.gs-webResult.gs-result a.gs-title:hover b,.gs-imageResult a.gs-title:hover,.gs-imageResult a.gs-title:hover b{color:#1155CC}.gs-webResult.gs-result a.gs-title:active,.gs-webResult.gs-result a.gs-title:active b,.gs-imageResult a.gs-title:active,.gs-imageResult a.gs-title:active b{color:#1155CC}.gsc-cursor-page{color:#1155CC}a.gsc-trailing-more-results:link{color:#1155CC}.gs-webResult:not(.gs-no-results-result):not(.gs-error-result) .gs-snippet,.gs-fileFormatType{color:#333333}.gs-webResult div.gs-visibleUrl{color:#009933}.gs-webResult div.gs-visibleUrl-short{color:#009933}.gs-webResult div.gs-visibleUrl-short{display:none}.gs-webResult div.gs-visibleUrl-long{display:none}.gs-webResult div.gs-visibleUrl-breadcrumb{display:block}.gs-promotion div.gs-visibleUrl-short{display:none}.gs-promotion div.gs-visibleUrl-long{display:block}.gs-promotion div.gs-visibleUrl-breadcrumb{display:none}.gsc-cursor-box{border-color:#FFFFFF}.gsc-results .gsc-cursor-box .gsc-cursor-page{border-color:#666666;background-color:#FFFFFF;color:#666666}.gsc-results .gsc-cursor-box .gsc-cursor-current-page{border-color:#1A73E8;background-color:#FFFFFF;color:#1A73E8}.gsc-webResult.gsc-result.gsc-promotion{border-color:#FFFFFF;background-color:#F6F6F6}.gsc-completion-title{color:#1155CC}.gsc-completion-snippet{color:#333333}.gs-promotion a.gs-title:link,.gs-promotion a.gs-title:link *,.gs-promotion .gs-snippet a:link{color:#1155CC}.gs-promotion a.gs-title:visited,.gs-promotion a.gs-title:visited *,.gs-promotion .gs-snippet a:visited{color:#1155CC}.gs-promotion a.gs-title:hover,.gs-promotion a.gs-title:hover *,.gs-promotion .gs-snippet a:hover{color:#1155CC}.gs-promotion a.gs-title:active,.gs-promotion a.gs-title:active *,.gs-promotion .gs-snippet a:active{color:#1155CC}.gs-promotion .gs-snippet,.gs-promotion .gs-title .gs-promotion-title-right,.gs-promotion .gs-title .gs-promotion-title-right *{color:#333333}.gs-promotion .gs-visibleUrl,.gs-promotion .gs-visibleUrl-short{color:#009933}.gcsc-find-more-on-google{color:#1155CC}.gcsc-find-more-on-google-magnifier{fill:#1155CC}</style><style type="text/css">.gscb_a{display:inline-block;font:27px/13px arial,sans-serif}.gsst_a .gscb_a{color:#a1b9ed;cursor:pointer}.gsst_a:hover .gscb_a,.gsst_a:focus .gscb_a{color:#36c}.gsst_a{display:inline-block}.gsst_a{cursor:pointer;padding:0 4px}.gsst_a:hover{text-decoration:none!important}.gsst_b{font-size:16px;padding:0 2px;position:relative;user-select:none;-webkit-user-select:none;white-space:nowrap}.gsst_e{vertical-align:middle;opacity:0.55;}.gsst_a:hover .gsst_e,.gsst_a:focus .gsst_e{opacity:0.72;}.gsst_a:active .gsst_e{opacity:1;}.gsst_f{background:white;text-align:left}.gsst_g{background-color:white;border:1px solid #ccc;border-top-color:#d9d9d9;box-shadow:0 2px 4px rgba(0,0,0,0.2);-webkit-box-shadow:0 2px 4px rgba(0,0,0,0.2);margin:-1px -3px;padding:0 6px}.gsst_h{background-color:white;height:1px;margin-bottom:-1px;position:relative;top:-1px}.gsib_a{width:100%;padding:4px 6px 0}.gsib_a,.gsib_b{vertical-align:top}.gssb_c{border:0;position:absolute;z-index:989}.gssb_e{border:1px solid #ccc;border-top-color:#d9d9d9;box-shadow:0 2px 4px rgba(0,0,0,0.2);-webkit-box-shadow:0 2px 4px rgba(0,0,0,0.2);cursor:default}.gssb_f{visibility:hidden;white-space:nowrap}.gssb_k{border:0;display:block;position:absolute;top:0;z-index:988}.gsdd_a{border:none!important}.gsq_a{padding:0}.gssb_a{padding:0 7px}.gssb_a,.gssb_a td{white-space:nowrap;overflow:hidden;line-height:22px}#gssb_b{font-size:11px;color:#36c;text-decoration:none}#gssb_b:hover{font-size:11px;color:#36c;text-decoration:underline}.gssb_g{text-align:center;padding:8px 0 7px;position:relative}.gssb_h{font-size:15px;height:28px;margin:0.2em;-webkit-appearance:button}.gssb_i{background:#eee}.gss_ifl{visibility:hidden;padding-left:5px}.gssb_i .gss_ifl{visibility:visible}a.gssb_j{font-size:13px;color:#36c;text-decoration:none;line-height:100%}a.gssb_j:hover{text-decoration:underline}.gssb_l{height:1px;background-color:#e5e5e5}.gssb_m{color:#000;background:#fff}.gssb_a{padding:0 9px}.gsib_a{padding:5px 9px 4px 9px}.gscb_a{line-height:27px}.gssb_e{border:0}.gssb_l{margin:5px 0}input.gsc-input::-webkit-input-placeholder{font-size:14px}input.gsc-input:-moz-placeholder{font-size:14px}input.gsc-input::-moz-placeholder{font-size:14px}input.gsc-input:-ms-input-placeholder{font-size:14px}input.gsc-input:focus::-webkit-input-placeholder{color:transparent}input.gsc-input:focus:-moz-placeholder{color:transparent}input.gsc-input:focus::-moz-placeholder{color:transparent}input.gsc-input:focus:-ms-input-placeholder{color:transparent}.gssb_c .gsc-completion-container{position:static}.gssb_c{z-index:5000}.gsc-completion-container table{background:transparent;font-size:inherit;font-family:inherit}.gssb_c > tbody > tr,.gssb_c > tbody > tr > td,.gssb_d,.gssb_d > tbody > tr,.gssb_d > tbody > tr > td,.gssb_e,.gssb_e > tbody > tr,.gssb_e > tbody > tr > td{padding:0;margin:0;border:0}.gssb_a table,.gssb_a table tr,.gssb_a table tr td{padding:0;margin:0;border:0}</style></head>
  <body class="article">
<style>
  p {
    hyphens: none;
  }
  td {
    hyphens: none;
  }

  p code {
    background: #eeeeee !important
  }

  .gsc-clear-button {
    display: none;
  }

  .gsc-control-cse {
    font-size: 10px !important
  }
</style>
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="/docs/~/index.html">Red Planet Labs Documentation</a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <script async="" src="https://cse.google.com/cse.js?cx=a198d0f9938004cd4">
          </script>
          <div id="___gcse_0"><div class="gsc-control-cse gsc-control-cse-en"><div class="gsc-control-wrapper-cse" dir="ltr"><form class="gsc-search-box gsc-search-box-tools" accept-charset="utf-8"><table cellspacing="0" cellpadding="0" role="presentation" class="gsc-search-box"><tbody><tr><td class="gsc-input"><div class="gsc-input-box" id="gsc-iw-id1"><table cellspacing="0" cellpadding="0" role="presentation" id="gs_id50" class="gstl_50 gsc-input" style="width: 100%; padding: 0px;"><tbody><tr><td id="gs_tti50" class="gsib_a"><input autocomplete="off" type="text" size="10" class="gsc-input" name="search" title="search" aria-label="search" id="gsc-i-id1" dir="ltr" spellcheck="false" style="width: 100%; padding: 0px; border: none; margin: 0px; height: auto; outline: none;"></td><td class="gsib_b"><div class="gsst_b" id="gs_st50" dir="ltr"><a class="gsst_a" href="javascript:void(0)" title="Clear search box" role="button" style="display: none;"><span class="gscb_a" id="gs_cb50" aria-hidden="true">×</span></a></div></td></tr></tbody></table></div></td><td class="gsc-search-button"><button class="gsc-search-button gsc-search-button-v2"><svg width="13" height="13" viewBox="0 0 13 13"><title>search</title><path d="m4.8495 7.8226c0.82666 0 1.5262-0.29146 2.0985-0.87438 0.57232-0.58292 0.86378-1.2877 0.87438-2.1144 0.010599-0.82666-0.28086-1.5262-0.87438-2.0985-0.59352-0.57232-1.293-0.86378-2.0985-0.87438-0.8055-0.010599-1.5103 0.28086-2.1144 0.87438-0.60414 0.59352-0.8956 1.293-0.87438 2.0985 0.021197 0.8055 0.31266 1.5103 0.87438 2.1144 0.56172 0.60414 1.2665 0.8956 2.1144 0.87438zm4.4695 0.2115 3.681 3.6819-1.259 1.284-3.6817-3.7 0.0019784-0.69479-0.090043-0.098846c-0.87973 0.76087-1.92 1.1413-3.1207 1.1413-1.3553 0-2.5025-0.46363-3.4417-1.3909s-1.4088-2.0686-1.4088-3.4239c0-1.3553 0.4696-2.4966 1.4088-3.4239 0.9392-0.92727 2.0864-1.3969 3.4417-1.4088 1.3553-0.011889 2.4906 0.45771 3.406 1.4088 0.9154 0.95107 1.379 2.0924 1.3909 3.4239 0 1.2126-0.38043 2.2588-1.1413 3.1385l0.098834 0.090049z"></path></svg></button></td><td class="gsc-clear-button"><div class="gsc-clear-button" title="clear results">&nbsp;</div></td></tr></tbody></table></form><div class="gsc-results-wrapper-overlay"><div class="gsc-results-close-btn" tabindex="0"></div><div class="gsc-positioningWrapper"><div class="gsc-tabsAreaInvisible"><div aria-label="refinement" role="tab" class="gsc-tabHeader gsc-inline-block gsc-tabhActive">Custom Search</div><span class="gs-spacer"> </span></div></div><div class="gsc-positioningWrapper"><div class="gsc-refinementsAreaInvisible"></div></div><div class="gsc-above-wrapper-area-invisible"><div class="gsc-above-wrapper-area-backfill-container"></div><table cellspacing="0" cellpadding="0" role="presentation" class="gsc-above-wrapper-area-container"><tbody><tr><td class="gsc-result-info-container"><div class="gsc-result-info-invisible"></div></td><td class="gsc-orderby-container"><div class="gsc-orderby-invisible"><div class="gsc-orderby-label gsc-inline-block">Sort by:</div><div class="gsc-option-menu-container gsc-inline-block"><div class="gsc-selected-option-container gsc-inline-block"><div class="gsc-selected-option">Relevance</div><div class="gsc-option-selector"></div></div><div class="gsc-option-menu-invisible"><div class="gsc-option-menu-item gsc-option-menu-item-highlighted"><div class="gsc-option">Relevance</div></div><div class="gsc-option-menu-item"><div class="gsc-option">Date</div></div></div></div></div></td></tr></tbody></table></div><div class="gsc-adBlockInvisible"></div><div class="gsc-wrapper"><div class="gsc-adBlockInvisible"></div><div class="gsc-resultsbox-invisible"><div class="gsc-resultsRoot gsc-tabData gsc-tabdActive"><div><div class="gsc-expansionArea"></div></div></div></div></div></div><div class="gsc-modal-background-image" tabindex="0"></div></div></div></div>
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="docs" data-version="~">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style=""></button>
    <h3 class="title"><a href="index.html">Documentation</a></h3>
<ul class="nav-list">
  <li class="nav-item is-active is-current-path" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="why-use-rama.html">Why use Rama?</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="tutorial1.html">Tutorial</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tutorial1.html">First module</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tutorial2.html">Depots, ETLs, and PStates</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tutorial3.html">Distributed programming</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tutorial4.html">Dataflow programming</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tutorial5.html">Types of ETLs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tutorial6.html">Tying it all together</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="downloads-maven-local-dev.html">Downloads, Maven, and local development</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="terminology.html">Terminology</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="paths.html">Paths</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="intermediate-dataflow.html">Intermediate dataflow programming</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="aggregators.html">Aggregators</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="stream.html">Stream topologies</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="microbatch.html">Microbatch topologies</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="query.html">Query topologies</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="depots.html">Depots</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="pstates.html">PStates</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="partitioners.html">Partitioners</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="serialization.html">Custom serialization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="module-dependencies.html">Dependencies between modules</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="operating-rama.html">Operating Rama clusters</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="heterogenous-clusters.html">Heterogenous clusters</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="replication.html">Replication</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="backups.html">Backups</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="acid.html">ACID semantics</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="rest.html">REST API</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="integrating.html">Integrating with other tools</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="all-configs.html">All configs</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing.html">Testing</a>
  </li>
  <li class="nav-item is-current-page is-active" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="clj-defining-modules.html">Clojure API</a>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="clj-defining-modules.html">Defining and using modules</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="clj-dataflow-lang.html">Dataflow language</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="clj-serialization.html">Custom serialization</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="clj-testing.html">Testing</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Documentation</span>
    <span class="version">~</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <div class="title"><a href="index.html">Documentation</a></div>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">~</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Documentation</a></li>
    <li><a href="clj-defining-modules.html">Clojure API</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"><h3>Contents</h3><ul><li data-level="1"><a href="#_defining_modules" class="">Defining modules</a></li><li data-level="1"><a href="#_declaring_depots" class="">Declaring depots</a></li><li data-level="1"><a href="#_declaring_tick_depots" class="">Declaring tick depots</a></li><li data-level="1"><a href="#_declaring_mirrors" class="">Declaring mirrors</a></li><li data-level="1"><a href="#_declaring_task_globals" class="">Declaring task globals</a></li><li data-level="1"><a href="#_declaring_etl_topologies" class="">Declaring ETL topologies</a></li><li data-level="1"><a href="#_declaring_pstates" class="">Declaring PStates</a></li><li data-level="2"><a href="#_pstate_migrations" class="">PState migrations</a></li><li data-level="1"><a href="#_depot_subscriptions_and_dataflow" class="">Depot subscriptions and dataflow</a></li><li data-level="1"><a href="#_declaring_query_topologies" class="is-active">Declaring query topologies</a></li><li data-level="1"><a href="#_foreign_module_clients">Foreign module clients</a></li><li data-level="2"><a href="#_foreign_depot_appends">Foreign depot appends</a></li><li data-level="2"><a href="#_foreign_depot_queries">Foreign depot queries</a></li><li data-level="2"><a href="#_foreign_pstate_queries">Foreign PState queries</a></li><li data-level="2"><a href="#_foreign_query_topology_invokes">Foreign query topology invokes</a></li><li data-level="1"><a href="#_summary">Summary</a></li></ul></div>
</aside>
<article class="doc">
<h1 class="page">Defining and using modules</h1>
<aside class="toc embedded"><div class="toc-menu"><h3>Contents</h3><ul><li data-level="1"><a href="#_defining_modules">Defining modules</a></li><li data-level="1"><a href="#_declaring_depots">Declaring depots</a></li><li data-level="1"><a href="#_declaring_tick_depots">Declaring tick depots</a></li><li data-level="1"><a href="#_declaring_mirrors">Declaring mirrors</a></li><li data-level="1"><a href="#_declaring_task_globals">Declaring task globals</a></li><li data-level="1"><a href="#_declaring_etl_topologies">Declaring ETL topologies</a></li><li data-level="1"><a href="#_declaring_pstates">Declaring PStates</a></li><li data-level="2"><a href="#_pstate_migrations">PState migrations</a></li><li data-level="1"><a href="#_depot_subscriptions_and_dataflow">Depot subscriptions and dataflow</a></li><li data-level="1"><a href="#_declaring_query_topologies">Declaring query topologies</a></li><li data-level="1"><a href="#_foreign_module_clients">Foreign module clients</a></li><li data-level="2"><a href="#_foreign_depot_appends">Foreign depot appends</a></li><li data-level="2"><a href="#_foreign_depot_queries">Foreign depot queries</a></li><li data-level="2"><a href="#_foreign_pstate_queries">Foreign PState queries</a></li><li data-level="2"><a href="#_foreign_query_topology_invokes">Foreign query topology invokes</a></li><li data-level="1"><a href="#_summary">Summary</a></li></ul></div></aside><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The pages in this section document Rama’s Clojure API. The Clojure API has identical functionality to the Java API, and for the most part there’s a 1:1 correspondence between them. These pages are mostly reference documentation on how to use all the features of Rama from Clojure. Conceptual documentation is documented elsewhere and will be linked to where appropriate.</p>
</div>
<div class="paragraph">
<p>For an introductory tutorial on using the Clojure API, we recommend starting with <a href="https://blog.redplanetlabs.com/2023/10/11/introducing-ramas-clojure-api/">the blog post</a> about it. We also recommend reading through the <a href="tutorial1.html" class="page">main tutorial</a> for a gentle introduction to all the concepts, even though it uses the Java API. Some other useful resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The API documentation is available <a href="https://redplanetlabs.com/clojuredoc/index.html">at this link</a>.</p>
</li>
<li>
<p>The <a href="terminology.html" class="page">Terminology page</a> is a handy reference for the terminology used by Rama.</p>
</li>
<li>
<p>The open-source <a href="https://github.com/redplanetlabs/rama-demo-gallery">rama-demo-gallery</a> project contains short, self-contained, thoroughly commented examples of applying the Clojure API towards a variety of use cases.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On this page you will learn:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Defining modules in Clojure</p>
</li>
<li>
<p>Configuring depot source options</p>
</li>
<li>
<p>Specifying PState schemas and options</p>
</li>
<li>
<p>Defining stream, microbatch, and query topologies</p>
</li>
<li>
<p>Declaring dependencies to other modules</p>
</li>
<li>
<p>Fetching and using depot, PState, and query clients</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_defining_modules"><a class="anchor" href="#_defining_modules"></a>Defining modules</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The main way to define a module is with <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-defmodule">defmodule</a>. <code>defmodule</code> defines a regular Clojure function with arguments <code>setup</code> and <code>topologies</code>, like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">defmodule</span> MyModule [setup topologies]
  (<span class="hljs-name">declare-depot</span> setup *my-depot <span class="hljs-symbol">:random</span>))</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p><code>setup</code> is used to declare depots and dependencies to depots, PStates, or query topologies in other modules. <code>topologies</code> is used to declare stream, microbatch, and query topologies.</p>
</div>
<div class="paragraph">
<p>A module is named according to the namespace in which it’s declared and the symbol used to define it. If <code>MyModule</code> above was defined in the namespace <code>com.mycompany</code>, the module name would be <code>"com.mycompany/MyModule"</code>. You can override the module name like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">defmodule</span> MyModule {<span class="hljs-symbol">:module-name</span> <span class="hljs-string">"OtherName"</span>} [setup topologies]
  (<span class="hljs-name">declare-depot</span> setup *my-depot <span class="hljs-symbol">:random</span>))</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>The owning namespace is always part of the module name and can’t be overridden. In this case the module name would be <code>"com.mycompany/OtherName"</code>.</p>
</div>
<div class="paragraph">
<p>In tests, a module’s name can be fetched with <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-get-module-name">get-module-name</a>.</p>
</div>
<div class="paragraph">
<p>You can also define an anonymous module with <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-module">module</a>. This can sometimes be useful when writing unit tests. Here’s an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">module</span> [setup topologies]
  (<span class="hljs-name">declare-depot</span> setup *my-depot <span class="hljs-symbol">:random</span>))</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>An anonymous module will have an auto-generated name, but you can override it with the same options map.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_declaring_depots"><a class="anchor" href="#_declaring_depots"></a>Declaring depots</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="depots.html" class="page">Depots</a> are distributed, durable, and replicated logs of data. They are sources for topologies and can be appended to either by clients outside a cluster or from within topologies.</p>
</div>
<div class="paragraph">
<p>Depots are declared with <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-declare-depot">declare-depot</a>. Here’s an example of a module with six depots:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">defdepotpartitioner</span> partition-by-value-in-data
  [data num-partitions]
  (<span class="hljs-name"><span class="hljs-builtin-name">mod</span></span> (<span class="hljs-symbol">:some-value</span> data) num-partitions))

(<span class="hljs-name">defmodule</span> Foo [setup topologies]
  (<span class="hljs-name">declare-depot</span> setup *depot1 <span class="hljs-symbol">:random</span>)
  (<span class="hljs-name">declare-depot</span> setup *depot2 (<span class="hljs-name">hash-by</span> first))
  (<span class="hljs-name">declare-depot</span> setup *depot3 (<span class="hljs-name">hash-by</span> <span class="hljs-symbol">:k</span>))
  (<span class="hljs-name">declare-depot</span> setup *depot4 <span class="hljs-symbol">:disallow</span>)
  (<span class="hljs-name">declare-depot</span> setup *depot5 partition-by-value-in-data)
  (<span class="hljs-name">declare-depot</span> setup *depot6 <span class="hljs-symbol">:random</span> {<span class="hljs-symbol">:global?</span> <span class="hljs-literal">true</span>}))</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Symbols beginning with <code>*</code> are variables in Rama dataflow code, and the <code>declare-depot</code> macro lets you declare a depot’s name as a symbol – just as it will be referred later in dataflow code.</p>
</div>
<div class="paragraph">
<p>The last argument to <code>declare-depot</code> is the depot partitioner. This determines on which partition data appended by a client goes. As described <a href="depots.html#_declaring_depots" class="page">in this section</a>, this enables you to maintain local ordering for entities.</p>
</div>
<div class="paragraph">
<p>The depot partitioners can be <code>:random</code>, <code>hash-by</code>, <code>:disallow</code>, or a custom partitioner. <code>:random</code> causes appended data to go to a random partition. <code>hash-by</code> chooses the target task based on the hash of the value extracted with the provided function. <code>:disallow</code> disables appends from clients and only allows data to be appended from within topologies. Custom partitioners are defined with <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-defdepotpartitioner">defdepotpartitioner</a> as an arbitrary Clojure function.</p>
</div>
<div class="paragraph">
<p>Note that the function reference in <code>hash-by</code> must specify either a keyword or a top-level var defined with <code>defn</code>.</p>
</div>
<div class="paragraph">
<p>The only option available to <code>declare-depot</code> is <code>:global?</code>, which specifies the depot should have only a single partition. When this option is set, the partitioning scheme is irrelevant.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_declaring_tick_depots"><a class="anchor" href="#_declaring_tick_depots"></a>Declaring tick depots</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Whereas depot allow a topology to process new data as it arrives, tick depots allow a topology to process based on the passage of time. A tick depot emits an event according to the desired frequency (in milliseconds). For example, here’s a tick depot that emits an event once a minute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">defmodule</span> Foo [setup topologies]
  (<span class="hljs-name">declare-tick-depot</span> setup *my-tick <span class="hljs-number">60000</span>))</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>See <a href="depots.html#_tick_depots" class="page">this section</a> for differences in how tick depots work in streaming versus microbatching.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_declaring_mirrors"><a class="anchor" href="#_declaring_mirrors"></a>Declaring mirrors</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Mirrors are references within a module to depots, PStates, or query topologies in other modules. See the page on <a href="module-dependencies.html" class="page">Module dependencies</a> for details on using mirrors and tradeoffs to consider.</p>
</div>
<div class="paragraph">
<p>Mirrors are declared in the Clojure API with <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-mirror-depot">mirror-depot</a>, <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-mirror-pstate">mirror-pstate</a>, and <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-mirror-query">mirror-query</a>. Here are some examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">defmodule</span> Foo [setup topologies]
  (<span class="hljs-name">mirror-depot</span> setup *other-depot <span class="hljs-string">"com.mycompany.OtherModule"</span> <span class="hljs-string">"*depot"</span>)
  (<span class="hljs-name">mirror-pstate</span> setup $$p <span class="hljs-string">"com.mycompany.OtherModule"</span> <span class="hljs-string">"$$p"</span>)
  (<span class="hljs-name">mirror-query</span> setup *mirror-query <span class="hljs-string">"com.mycompany.OtherModule2"</span> <span class="hljs-string">"some-query"</span>))</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>The mirror object is referenced in subsequent topology code with the variable specified in the second argument.</p>
</div>
<div class="paragraph">
<p>Both colocated and mirror query topologies can be invoked from a topology with <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-invoke-query">invoke-query</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_declaring_task_globals"><a class="anchor" href="#_declaring_task_globals"></a>Declaring task globals</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A <a href="https://redplanetlabs.com/docs/~/integrating.html#_task_globals">task global</a> allows global state to be available to all tasks of a module. Task globals live on each task and do not need to be transferred from task to task during processing. Task globals can be constant values, or each instance of a task global can specialize itself to each task. Task globals can be used for everything from distributing large constant data (like an ML model), in-memory caches specific to each partition, or integrating external services like databases, queues, or monitoring systems (where the task global opens up a client to the external service on each task).</p>
</div>
<div class="paragraph">
<p>A task global is declared with <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-declare-object">declare-object</a>. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">defmodule</span> Foo [setup topologies]
  (<span class="hljs-name">declare-object</span> setup *my-global <span class="hljs-string">"global-value"</span>))</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>If the provided object implements <a href="https://redplanetlabs.com/javadoc/com/rpl/rama/integration/TaskGlobalObject.html">TaskGlobalObject</a>, each instance will be specialized on each task. See <a href="https://redplanetlabs.com/docs/~/integrating.html#_task_globals">the full documentation on task globals</a> for more details.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_declaring_etl_topologies"><a class="anchor" href="#_declaring_etl_topologies"></a>Declaring ETL topologies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ETL ("Extract-Transform-Load") topologies process data from depots and can maintain any number of PStates along the way. They can be used for purposes other than materializing PStates, such as interacting with third-party APIs or other external systems. There are two types of ETLs, streaming and microbatching, with different performance and fault-tolerance characteristics. See the <a href="stream.html" class="page">Stream topologies</a> and <a href="microbatch.html" class="page">Microbatch topologies</a> pages for more information on them.</p>
</div>
<div class="paragraph">
<p>Stream and microbatch topologies are declared with <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-stream-topology">stream-topology</a> and <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-microbatch-topology">microbatch-topology</a>. With a topology object you can then declare PStates and define dataflow code to handle processing from one or more depots.</p>
</div>
<div class="paragraph">
<p>Here’s an example of a stream topology:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">defmodule</span> Foo [setup topologies]
  (<span class="hljs-name">declare-depot</span> setup *depot <span class="hljs-symbol">:random</span>)
  (<span class="hljs-name"><span class="hljs-builtin-name">let</span></span> [s (<span class="hljs-name">stream-topology</span> topologies <span class="hljs-string">"counts"</span>)]
    (<span class="hljs-name">declare-pstate</span> s $$counts {String Long})
    (<span class="hljs-name">&lt;&lt;sources</span> s
      (<span class="hljs-name">source&gt;</span> *depot <span class="hljs-symbol">:&gt;</span> *data)
      (|hash *data)
      (<span class="hljs-name">+compound</span> $$counts {*data (<span class="hljs-name">aggs/+count</span>)})
      )))</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p><a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-declare-pstate">declare-pstate</a> is used to declare PStates for a topology, and <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-.3C.3Csources">&lt;&lt;sources</a> defines dataflow code to subscribe and process data from depots. These will both be explained more in depth later on this page.</p>
</div>
<div class="paragraph">
<p>This module defines a topology that consumes a depot containing strings and materializes a PState <code>$$counts</code> containing the number of times each string appeared in the depot.</p>
</div>
<div class="paragraph">
<p>This code receives each piece of data from <code>*depot</code> and binds it to the variable <code>*data</code>. The <code>:&gt;</code> keyword separates the input from the output of the operation. It then uses the <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-.7Chash">|hash</a> partitioner to switch to the task storing counts for that string. Finally, it uses <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-.2Bcompound">+compound</a> to update the PState. <code>+compound</code> does <a href="clj-dataflow-lang.html#_aggregators" class="page">compound aggregation</a>, which expresses the update in the shape of what’s being written. At the leaf, it uses the <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.aggs.html#var-.2Bcount">+count</a> aggregator to specify the actual update. The package <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.aggs.html">com.rpl.rama.aggs</a> contains many built-in aggregators.</p>
</div>
<div class="paragraph">
<p>Here’s an example of a microbatch topology doing the same thing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">defmodule</span> Foo [setup topologies]
  (<span class="hljs-name">declare-depot</span> setup *depot <span class="hljs-symbol">:random</span>)
  (<span class="hljs-name"><span class="hljs-builtin-name">let</span></span> [mb (<span class="hljs-name">microbatch-topology</span> topologies <span class="hljs-string">"counts"</span>)]
    (<span class="hljs-name">declare-pstate</span> mb $$counts {String Long})
    (<span class="hljs-name">&lt;&lt;sources</span> mb
      (<span class="hljs-name">source&gt;</span> *depot <span class="hljs-symbol">:&gt;</span> %microbatch)
      (%microbatch <span class="hljs-symbol">:&gt;</span> *data)
      (|hash *data)
      (<span class="hljs-name">+compound</span> $$counts {*data (<span class="hljs-name">aggs/+count</span>)})
      )))</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Whereas streaming processes data as it arrives, microbatching processes data across every partition of a depot in a batch computation. Each microbatch iteration processes the data that accumulated in the last iteration. <code>source&gt;</code> in a stream topology emits data directly, while <code>source&gt;</code> in a microbatch topology emits an object representing the batch of data for the iteration.</p>
</div>
<div class="paragraph">
<p>Variables beginning with <code>%</code> are anonymous operations. Calling <code>%microbatch</code> causes all data for the iteration to be emitted across all partitions individually. So if the microbatch contains 500 pieces of data on each depot partition, <code>%microbatch</code> emits and binds the <code>*data</code> variable 500 times across every partition.</p>
</div>
<div class="paragraph">
<p><code>%microbatch</code> can be called multiple times in a microbatch iteration, or it can be called as part of a smaller subbatch. You’ll see examples <a href="clj-dataflow-lang.html#_batch_blocks" class="page">in this section</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_declaring_pstates"><a class="anchor" href="#_declaring_pstates"></a>Declaring PStates</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="pstates.html" class="page">PStates</a> are partitioned, durable, and replicated indexes that are declared with <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-declare-pstate">declare-pstate</a>. A PState is an arbitrary combination of arbitrary size data structures. Each PState is declared with a schema that determines what it stores and how.</p>
</div>
<div class="paragraph">
<p>A feature called <a href="pstates.html#_subindexing" class="page">"subindexing"</a> allows nested data structures to be of huge size, even more than the memory available. A schema defines the data structures used, as well as which ones are subindexed.</p>
</div>
<div class="paragraph">
<p>Here are some examples of schemas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">defmodule</span> Foo [setup topologies]
  (<span class="hljs-name"><span class="hljs-builtin-name">let</span></span> [s (<span class="hljs-name">stream-topology</span> topologies <span class="hljs-string">"s"</span>)]
    (<span class="hljs-name">declare-pstate</span> s $$p1 {String Long})
    (<span class="hljs-name">declare-pstate</span> s $$p2 {Long {clojure.lang.Keyword String}})
    (<span class="hljs-name">declare-pstate</span> s $$p3 {Long (<span class="hljs-name">set-schema</span> String {<span class="hljs-symbol">:subindex?</span> <span class="hljs-literal">true</span>})})
    (<span class="hljs-name">declare-pstate</span> s $$p4 Long)
    (<span class="hljs-name">declare-pstate</span> s $$p5 {Long (<span class="hljs-name">map-schema</span> Long
                             (<span class="hljs-name">set-schema</span> Long {<span class="hljs-symbol">:subindex?</span> <span class="hljs-literal">true</span>})
                             {<span class="hljs-symbol">:subindex?</span> <span class="hljs-literal">true</span>})})
    (<span class="hljs-name">declare-pstate</span> s $$p6 {Long (<span class="hljs-name">fixed-keys-schema</span>
                                   {<span class="hljs-symbol">:a</span> String
                                    <span class="hljs-symbol">:b</span> (<span class="hljs-name">set-schema</span> Long {<span class="hljs-symbol">:subindex?</span> <span class="hljs-literal">true</span>})})})
    ))</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>As you can see, you can have subindexed structures within subindexed structures, and the top-level schema doesn’t have to be a map. The <code>Long</code> schema specifies that each partition of the PState is a simple <code>Long</code> value. A PState like that is useful for ID generation, for example.</p>
</div>
<div class="paragraph">
<p>PState schemas can be specified as either data structure literals, or with explicit use of <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-map-schema">map-schema</a>, <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-set-schema">set-schema</a>, <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-vector-schema">vector-schema</a>, or <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-fixed-keys-schema">fixed-keys-schema</a>. The explicit forms allow subindexing options to be specified.</p>
</div>
<div class="paragraph">
<p>Subindex options can be specified with either the <code>:subindex?</code> or <code>:subindex-options</code> keywords. Only one of the two options may be specified. The <code>:subindex-options</code> variants allows subindexing to be specified with <a href="pstates.html#_size_tracking" class="page">size tracking</a> turned off, like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">declare-pstate</span> s $$p
                  {String (<span class="hljs-name">set-schema</span>
                            Long
                            {<span class="hljs-symbol">:subindex-options</span> {<span class="hljs-symbol">:track-size?</span> <span class="hljs-literal">false</span>}})})</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Size tracking is turned on by default and enables the size of subindexed structures to be fetched extremely quickly, even if the structure has huge numbers of elements. However, Rama’s internal maintenance of the size does require reads to be done when writing to a structure to see if a key is new or not. If you don’t need to ever query the size of a subindexed structure, you can turn it off to improve write performance.</p>
</div>
<div class="paragraph">
<p>PStates also accept four options when declaring them. Here are examples of using them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name"><span class="hljs-builtin-name">defn</span></span> my-partitioner [num-partitions key]
  (<span class="hljs-name"><span class="hljs-builtin-name">cond</span></span>
    (<span class="hljs-name"><span class="hljs-builtin-name">=</span></span> <span class="hljs-symbol">:a</span> key) <span class="hljs-number">0</span>
    (<span class="hljs-name"><span class="hljs-builtin-name">=</span></span> <span class="hljs-symbol">:b</span> key) <span class="hljs-number">1</span>
    <span class="hljs-symbol">:else</span> (<span class="hljs-name"><span class="hljs-builtin-name">mod</span></span> (<span class="hljs-name">hash</span> key) num-partitions)))

(<span class="hljs-name">defmodule</span> Foo [setup topologies]
  (<span class="hljs-name"><span class="hljs-builtin-name">let</span></span> [s (<span class="hljs-name">stream-topology</span> topologies <span class="hljs-string">"s"</span>)]
    (<span class="hljs-name">declare-pstate</span> s $$p1 Long {<span class="hljs-symbol">:global?</span> <span class="hljs-literal">true</span>
                                 <span class="hljs-symbol">:initial-value</span> <span class="hljs-number">100</span>})
    (<span class="hljs-name">declare-pstate</span> s $$p2 {String Long} {<span class="hljs-symbol">:private?</span> <span class="hljs-literal">true</span>})
    (<span class="hljs-name">declare-pstate</span> s $$p3 {String Long} {<span class="hljs-symbol">:key-partitioner</span> my-partitioner})
    ))</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p><code>:global?</code> specifies the PState to have only a single partition.</p>
</div>
<div class="paragraph">
<p><code>:initial-value</code> specifies the initial value of each PState partition. It should only be used with top-level value schemas (e.g. <code>Long</code> or <code>java.util.Map</code>).</p>
</div>
<div class="paragraph">
<p><code>:private?</code> specifies the PState should only be readable from topology code within the module definition and not from external clients. Trying to fetch a client for a private PState will throw an exception.</p>
</div>
<div class="paragraph">
<p>Finally, <code>:key-partitioner</code> affects how foreign PState queries function. The default key partitioner is a hash partitioner that chooses the target partition to query based on the hash of the key. This is one of the most common ways to partition a PState. You can customize how foreign PState queries are routed with <code>:key-partitioner</code>. <code>:key-partitioner</code> should be a reference to a top-level function of two arguments: the number of partitions of the PState, and the key. See <a href="pstates.html#_pstate_options" class="page">this section</a> for more information on how key partitioners work.</p>
</div>
<div class="sect2">
<h3 id="_pstate_migrations"><a class="anchor" href="#_pstate_migrations"></a>PState migrations</h3>
<div class="paragraph">
<p>A PState can be migrated to a new schema as part of a <a href="operating-rama.html#_updating_modules" class="page">module update</a>. A migration can include arbitrary user-specified transformation functions indicating how values should change. PState migrations take effect immediately, with all subsequent reads after the module update seeing migrated values. Rama accomplishes this by applying the migration function on read while it migrates the PState on disk in the background.</p>
</div>
<div class="paragraph">
<p>The full documentation on PState migrations is <a href="pstates.html#_migrations" class="page">in this section</a>. Though that section uses Java examples, the Clojure API for migrations is 1:1 with the Java API.</p>
</div>
<div class="paragraph">
<p>Here’s an example of declaring a migration with the Clojure API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">declare-pstate</span>
  $$p
  {Long (<span class="hljs-name">migrated</span> String <span class="hljs-string">"myMigrationId"</span> str)})</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>The entire migration API is the <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-migrated">migrated</a> function. It takes as input the new schema, the "migration ID", and the migration function. As explained in the full docs, the migration function must be idempotent.</p>
</div>
<div class="paragraph">
<p><code>migrated</code> also accepts an optional fourth argument containing a list of migration options. For example, here’s how to migrate a non-subindexed vector to a subindexed vector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">declare-pstate</span>
  $$p
  {Long (<span class="hljs-name">migrated</span> (<span class="hljs-name">vector-schema</span> String {<span class="hljs-symbol">:subindexed?</span> <span class="hljs-literal">true</span>})
                  <span class="hljs-string">"myMigrationId"</span>
                  identity
                  [(<span class="hljs-name">migrate-to-subindexed</span>)])})</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Here’s an example of updating a fixed keys schema to remove the key <code>:a</code>, add the key <code>:c</code> with a starting value of 10, and change the key <code>:b</code> to a string:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">declare-pstate</span>
  $$p
  {Long (<span class="hljs-name">migrated</span> (<span class="hljs-name">fixed-keys-schema</span>
                    {<span class="hljs-symbol">:b</span> String
                     <span class="hljs-symbol">:c</span> Long})
                  <span class="hljs-string">"myMigrationId"</span>
                  (<span class="hljs-name"><span class="hljs-builtin-name">fn</span></span> [m]
                    (<span class="hljs-name"><span class="hljs-builtin-name">-&gt;</span></span> m (<span class="hljs-name"><span class="hljs-builtin-name">dissoc</span></span> <span class="hljs-symbol">:a</span>)
                          (<span class="hljs-name"><span class="hljs-builtin-name">assoc</span></span> <span class="hljs-symbol">:c</span> <span class="hljs-number">10</span>)
                          (<span class="hljs-name">update</span> <span class="hljs-symbol">:b</span> str)))
                  [(<span class="hljs-name">fixed-key-additions</span> #{<span class="hljs-symbol">:c</span>})
                   (<span class="hljs-name">fixed-key-removals</span> #{<span class="hljs-symbol">:a</span>})])})</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>As mentioned, the complete semantics on what locations in a PState can be migrated, how migrations can be nested, implicit migrations, and more are explained <a href="pstates.html#_migrations" class="page">in this section</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_depot_subscriptions_and_dataflow"><a class="anchor" href="#_depot_subscriptions_and_dataflow"></a>Depot subscriptions and dataflow</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-.3C.3Csources">&lt;&lt;sources</a> macro defines ETL logic using Rama’s dataflow API.</p>
</div>
<div class="paragraph">
<p>A <code>&lt;&lt;sources</code> block has one or more depot subscriptions specified using <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-source.3E">source&gt;</a>. The code following a <code>source&gt;</code> call is the dataflow logic for processing data from that depot.</p>
</div>
<div class="paragraph">
<p>Each call to <code>source&gt;</code> can specify subscription options. There are two options available: <code>:start-from</code> and <code>:retry-mode</code>.</p>
</div>
<div class="paragraph">
<p><code>:start-from</code> determines where a topology starts processing on each partition the first time it ever runs. Note that <code>:start-from</code> options have no effect if the topology has run before, like on a <a href="operating-rama.html#_updating_modules" class="page">module update</a>. <code>:start-from</code> can be set to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>:end</code>: start from the end of the depot partition (default)</p>
</li>
<li>
<p><code>:beginning</code>: start from the first available record on the depot partition</p>
</li>
<li>
<p><a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-offset-ago">offset-ago</a>: start from a specified number of records or amount of time in the past</p>
</li>
<li>
<p><a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-offset-after-timestamp-millis">offset-after-timestamp-millis</a>: start from the first record recorded after a given timestamp</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">source&gt;</span> *depot {<span class="hljs-symbol">:start-from</span> <span class="hljs-symbol">:beginning</span>} <span class="hljs-symbol">:&gt;</span> *data)
(<span class="hljs-name">source&gt;</span> *depot {<span class="hljs-symbol">:start-from</span> (<span class="hljs-name">offset-ago</span> <span class="hljs-number">10</span> <span class="hljs-symbol">:records</span>)} <span class="hljs-symbol">:&gt;</span> *data)
(<span class="hljs-name">source&gt;</span> *depot {<span class="hljs-symbol">:start-from</span> (<span class="hljs-name">offset-ago</span> <span class="hljs-number">14</span> <span class="hljs-symbol">:days</span>)} <span class="hljs-symbol">:&gt;</span> *data)
(<span class="hljs-name">source&gt;</span> *depot {<span class="hljs-symbol">:start-from</span> (<span class="hljs-name">offset-ago</span> <span class="hljs-number">6</span> <span class="hljs-symbol">:months</span>)} <span class="hljs-symbol">:&gt;</span> *data)
(<span class="hljs-name">source&gt;</span> *depot {<span class="hljs-symbol">:start-from</span> (<span class="hljs-name">offset-after-timestamp-millis</span> <span class="hljs-number">12345678</span>)} <span class="hljs-symbol">:&gt;</span> *data)</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p><code>:retry-mode</code> only pertains to stream topologies since microbatching always has <a href="microbatch.html#_operation_and_fault_tolerance" class="page">strong exactly-once semantics</a>. <code>:retry-mode</code> can be set to <code>:individual</code>, <code>:all-after</code>, or <code>:none</code>, and it defaults to <code>:individual</code> if not set. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">source&gt;</span> *depot {<span class="hljs-symbol">:retry-mode</span> <span class="hljs-symbol">:all-after</span>} <span class="hljs-symbol">:&gt;</span> *data)</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>The semantics of these retry modes is <a href="stream.html#_fault_tolerance_and_retry_modes" class="page">documented in this section</a>.</p>
</div>
<div class="paragraph">
<p>All the code in a <code>&lt;&lt;sources</code> block utilizes Rama’s dataflow API. The dataflow API is different than regular Clojure programming. Whereas a Clojure function is based on "call and response" – you call a function and get a single result back –&nbsp;dataflow is "call and emit". That is, you call an operation and it emits values to downstream code. Operations can emit one time, many times, or even zero times. They can also emit multiple fields per emit or emit to independent output streams. Dataflow operations also don’t have to emit synchronously –&nbsp;they can emit asynchronously on a completely different partition on a different machine.</p>
</div>
<div class="paragraph">
<p>The dataflow API is documented fully <a href="clj-dataflow-lang.html" class="page">on the next page</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_declaring_query_topologies"><a class="anchor" href="#_declaring_query_topologies"></a>Declaring query topologies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A query topology is a predefined, on-demand, realtime, distributed computation that can operate over any or all of your PStates and any or all of the partitions of your PStates.</p>
</div>
<div class="paragraph">
<p>Here’s an example of declaring a module with a single query topology:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">defmodule</span> Foo [setup topologies]
 (<span class="hljs-name">&lt;&lt;query-topology</span> topologies <span class="hljs-string">"q1"</span>
   [*arg <span class="hljs-symbol">:&gt;</span> *res]
   (<span class="hljs-name"><span class="hljs-builtin-name">*</span></span> <span class="hljs-number">10</span> (<span class="hljs-name"><span class="hljs-builtin-name">inc</span></span> *arg) <span class="hljs-symbol">:&gt;</span> *res)
   (|origin)))</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Like ETLs, query topologies are defined using <code>topologies</code>. The definition takes in a query name, <code>"q1"</code> in this example, a vector of parameters, and then dataflow code defining the query.</p>
</div>
<div class="paragraph">
<p>This example takes in one argument named <code>*arg</code> and emits a result variable <code>*res</code>. The dataflow code must then define <code>*res</code>, and this value will be sent back to the caller of the query topology.</p>
</div>
<div class="paragraph">
<p>A query topology must use the <code>|origin</code> partitioner, and it must be the final partitioner used. <code>|origin</code> indicates to partition back to the task where the query topology started.</p>
</div>
<div class="paragraph">
<p>If the query topology definition starts with an appropriate partitioner, the "leading partitioner" optimization will kick in, and query invokes will be routed directly to the correct task. You can learn more about this optimization and other aspects of query topologies on <a href="query.html" class="page">the page</a> about query topologies.</p>
</div>
<div class="paragraph">
<p>Query topologies can be invoked from any topology, whether ETL or query, using <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-invoke-query">invoke-query</a>. <code>invoke-query</code> can invoke colocated or mirror query topologies, and query topologies can also invoke themselves recursively.</p>
</div>
<div class="paragraph">
<p>The next section will show how to invoke query topologies from clients outside a Rama cluster.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_foreign_module_clients"><a class="anchor" href="#_foreign_module_clients"></a>Foreign module clients</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The term "foreign" refers to work in Rama initiated outside the cluster, including depot appends, PState queries, and query topology invokes. Clients are fetched with a "cluster manager", which on a real cluster is created with <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-open-cluster-manager">open-cluster-manager</a> or <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-open-cluster-manager-internal">open-cluster-manager-internal</a>. When you use an in-process cluster in a test context via <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.test.html#var-create-ipc">create-ipc</a> (as is documented more on the <a href="clj-testing.html" class="page">Clojure API testing page</a>), the cluster object is also a cluster manager.</p>
</div>
<div class="paragraph">
<p>Here’s an example of using <code>open-cluster-manager</code> and fetching depot, PState, and query topology clients:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name"><span class="hljs-builtin-name">def</span></span> manager (<span class="hljs-name">open-cluster-manager</span> {<span class="hljs-string">"conductor.host"</span> <span class="hljs-string">"1.2.3.4"</span>}))
(<span class="hljs-name"><span class="hljs-builtin-name">def</span></span> depot (<span class="hljs-name">foreign-depot</span> manager <span class="hljs-string">"com.mycompany/MyModule"</span> <span class="hljs-string">"*depot"</span>))
(<span class="hljs-name"><span class="hljs-builtin-name">def</span></span> pstate (<span class="hljs-name">foreign-pstate</span> manager <span class="hljs-string">"com.mycompany/MyModule"</span> <span class="hljs-string">"$$p"</span>))
(<span class="hljs-name"><span class="hljs-builtin-name">def</span></span> query (<span class="hljs-name">foreign-query</span> manager <span class="hljs-string">"com.mycompany/MyModule"</span> <span class="hljs-string">"my-query"</span>))</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p><code>open-cluster-manager</code> can also be configured through a <code>rama.yaml</code> file on the classpath. <code>open-cluster-manager-internal</code> can be used if you configure separate external/internal hostnames for nodes on your cluster, like on AWS. See the <a href="operating-rama.html#_internalexternal_hostname_configuration" class="page">Operating Rama</a> page for more details.</p>
</div>
<div class="paragraph">
<p><a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-foreign-depot">foreign-depot</a>, <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-foreign-pstate">foreign-pstate</a>, and <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-foreign-query">foreign-query</a> each take in the module name and the name of the desired object as arguments. Note that the names are strings, not symbols.</p>
</div>
<div class="sect2">
<h3 id="_foreign_depot_appends"><a class="anchor" href="#_foreign_depot_appends"></a>Foreign depot appends</h3>
<div class="paragraph">
<p>The function <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-foreign-append.21">foreign-append!</a> appends new data to a depot. Here are some examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">foreign-append!</span> depot <span class="hljs-string">"some data"</span>)
(<span class="hljs-name">foreign-append!</span> depot <span class="hljs-string">"abc"</span> <span class="hljs-symbol">:append-ack</span>)
(<span class="hljs-name">foreign-append!</span> depot <span class="hljs-symbol">:other-data</span> <span class="hljs-literal">nil</span>)
(<span class="hljs-name">foreign-append!</span> depot {<span class="hljs-symbol">:name</span> <span class="hljs-string">"Jack"</span> <span class="hljs-symbol">:age</span> <span class="hljs-number">39</span>} <span class="hljs-symbol">:ack</span>)</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p><code>foreign-append!</code> accepts an optional "ack level", which can be <code>nil</code>, <code>:append-ack</code>, or <code>:ack</code>. If unspecified, it defaults to <code>:ack</code>. <code>nil</code> is "fire and forget" and provides no guarantees about whether the depot append succeeds. <code>:append-ack</code> blocks until the data has successfully been persisted to the depot and replicated. <code>:ack</code> blocks until all colocated stream topologies have also successfully finished processing the depot record. When you use <code>:ack</code>, you know that all colocated streaming PStates have been updated when it returns successfully.</p>
</div>
<div class="paragraph">
<p>You can also perform async appends using <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-foreign-append-async.21">foreign-append-async!</a>. This function returns a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html">CompletableFuture</a> that delivers when the desired ack level condition has been reached.</p>
</div>
<div class="paragraph">
<p>See the <a href="depots.html#_depot_client_api" class="page">Depots page</a> for more information about foreign appends.</p>
</div>
</div>
<div class="sect2">
<h3 id="_foreign_depot_queries"><a class="anchor" href="#_foreign_depot_queries"></a>Foreign depot queries</h3>
<div class="paragraph">
<p>Ranges of data can be read directly using depot clients.  A record in a depot partition is identified by a "partition index" and an "offset". A partition index identifies on which depot partition it lives. Offsets start from zero and increase by one for each depot record appended.</p>
</div>
<div class="paragraph">
<p>To determine how many partitions a depot has and what offsets are available on each partition, a few methods are provided to return metadata about the depot.</p>
</div>
<div class="paragraph">
<p><a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-foreign-object-info">foreign-object-info</a> returns general information about the object, including the number of partitions it has (also works on PStates). This returns a map containing <code>:name</code>, <code>:module-name</code>, and <code>:num-partitions</code>.  For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">foreign-object-info</span> depot)
<span class="hljs-comment">;; =&gt; {:module-name "com.mycompany/MyModule" :name "*depot" :num-partitions 32}</span></code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p><a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-foreign-depot-partition-info">foreign-depot-partition-info</a> returns the offsets available for a particular partition index. It returns a map containing <code>:start-offset</code> and <code>:end-offset</code>. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">foreign-depot-partition-info</span> depot)
<span class="hljs-comment">;; =&gt; {:start-offset 100 :end-offset 1973000}</span></code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Finally, <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-foreign-depot-read">foreign-depot-read</a> returns a range of data from a depot partition as a vector. It takes as input a partition index, a start offset, and an end offset. If invalid offsets are requested it will throw an exception. Here’s an example of usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">foreign-depot-read</span> depot <span class="hljs-number">3</span> <span class="hljs-number">100</span> <span class="hljs-number">105</span>)
<span class="hljs-comment">;; =&gt; ["record100" "record101" "record102" "record103" "record104"]</span></code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p><code>foreign-depot-partition-info</code> and <code>foreign-depot-read</code> are remote calls, so there are also async versions of them called <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-foreign-depot-partition-info-async">foreign-depot-partition-info-async</a> and <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-foreign-depot-read-async">foreign-depot-read-async</a>. These methods return a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html">CompletableFuture</a> object.</p>
</div>
</div>
<div class="sect2">
<h3 id="_foreign_pstate_queries"><a class="anchor" href="#_foreign_pstate_queries"></a>Foreign PState queries</h3>
<div class="paragraph">
<p>Foreign PState queries are done using <a href="https://github.com/redplanetlabs/specter">Specter paths</a>. Rama has an internal fork of Specter at the package <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.path.html">com.rpl.rama.path</a> that adds reactive capabilities (described more below). For the most part, Rama’s internal version of Specter and the open-source version are API-equivalent. The documentation for open-source Specter and <a href="paths.html" class="page">the page on paths</a> teach the concepts and usage of paths.</p>
</div>
<div class="paragraph">
<p>A foreign PState query uses a path to fetch information from one partition of one PState. They can fetch anything from a nested subvalue to a transformation of some data to an aggregation of many pieces of data on a partition. If your query needs to fetch and aggregate information from multiple partitions or from multiple PStates, you should consider using a query topology.</p>
</div>
<div class="paragraph">
<p>Non-reactive queries are done with <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-foreign-select">foreign-select</a> and <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-foreign-select-one">foreign-select-one</a>. The former returns a sequence of navigated values, while the latter returns a single value and requires the path to navigate to exactly one value. Here are some examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">foreign-select</span> [<span class="hljs-symbol">:a</span> <span class="hljs-symbol">:b</span> ALL even?] pstate)
(<span class="hljs-name">foreign-select</span> [<span class="hljs-symbol">:a</span> MAP-VALS <span class="hljs-symbol">:b</span>] pstate)
(<span class="hljs-name">foreign-select-one</span> [<span class="hljs-symbol">:k</span> (<span class="hljs-name">nthpath</span> <span class="hljs-number">3</span>)] pstate)</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Any function that also exists on the module’s classpath can be used within paths as predicates or view functions, including all of <a href="https://clojure.github.io/clojure/clojure.core-api.html">clojure.core</a>.</p>
</div>
<div class="paragraph">
<p>By default, foreign PState queries are routed using the first key in the path. You can override this by providing an explicit partitioning key as an additional option. Here’s an example of doing so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">foreign-select-one</span> (<span class="hljs-name">keypath</span> <span class="hljs-number">123</span>) posts-pstate {<span class="hljs-symbol">:pkey</span> <span class="hljs-symbol">:alice</span>})</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p><code>:pkey</code> is the only option available for <code>foreign-select</code> and <code>foreign-select-one</code>. For more information about partitioning keys and situations where you would use them, see <a href="pstates.html#_how_client_queries_are_routed" class="page">this section</a>.</p>
</div>
<div class="paragraph">
<p>There are also asynchronous versions of these query functions in <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-foreign-select-async">foreign-select-async</a> and <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-foreign-select-one-async">foreign-select-one-async</a> that return a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html">CompletableFuture</a>.</p>
</div>
<div class="sect3">
<h4 id="_range_queries"><a class="anchor" href="#_range_queries"></a>Range queries</h4>
<div class="paragraph">
<p>Rama has some additional navigators for doing range queries. These navigators are not in the open-source Specter. These can be used to do efficient range queries on durable structures containing huge numbers of elements, and they can also be used on regular data structures as well. When used on durable structures, whether top-level or subindexed, they make use of iterators on disk to maximize efficiency.</p>
</div>
<div class="paragraph">
<p>These range query navigators are <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.path.html#var-sorted-map-range">sorted-map-range</a>, <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.path.html#var-sorted-map-range-from">sorted-map-range-from</a>, <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.path.html#var-sorted-map-range-to">sorted-map-range-to</a>, <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.path.html#var-sorted-set-range">sorted-set-range</a>, <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.path.html#var-sorted-set-range-from">sorted-set-range-from</a>, and <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.path.html#var-sorted-set-range-to">sorted-set-range-to</a>. These navigators operate on sorted maps or sorted sets and return a sorted map or sorted set representing a partial range of the queried structure. All durable structures in PStates, both top-level and subindexed, are sorted, which is why these navigators are useful on them.</p>
</div>
<div class="paragraph">
<p>Here are some examples of usage of <code>sorted-map-range</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">foreign-select</span> [(<span class="hljs-name">sorted-map-range</span> <span class="hljs-symbol">:a</span> <span class="hljs-symbol">:b</span>) MAP-VALS] pstate)
(<span class="hljs-name">foreign-select-one</span> (<span class="hljs-name">sorted-map-range</span> <span class="hljs-symbol">:a</span> <span class="hljs-symbol">:b</span> {<span class="hljs-symbol">:inclusive-start?</span> <span class="hljs-literal">false</span>
                                             <span class="hljs-symbol">:inclusive-end?</span> <span class="hljs-literal">true</span>})
                    pstate)</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Here are some examples of usage of <code>sorted-map-range-from</code>, which selects a submap starting from a key up to a maximum number of elements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">foreign-select-one</span> (<span class="hljs-name">sorted-map-range-from</span> <span class="hljs-symbol">:k</span> <span class="hljs-number">10</span>) pstate)
(<span class="hljs-name">foreign-select-one</span> (<span class="hljs-name">sorted-map-range-from</span> <span class="hljs-symbol">:a</span> {<span class="hljs-symbol">:inclusive?</span> <span class="hljs-literal">false</span>
                                               <span class="hljs-symbol">:max-amt</span> <span class="hljs-number">100</span>})
                    pstate)</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Here are some examples of usage of <code>sorted-map-range-to</code>, which selects a submap up to a maximum number of elements by traversing the map from the given key in reverse:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">foreign-select-one</span> (<span class="hljs-name">sorted-map-range-to</span> <span class="hljs-symbol">:k</span> <span class="hljs-number">10</span>) pstate)
(<span class="hljs-name">foreign-select-one</span> [<span class="hljs-symbol">:k</span> (<span class="hljs-name">sorted-map-range-to</span> <span class="hljs-symbol">:k</span> {<span class="hljs-symbol">:inclusive?</span> <span class="hljs-literal">true</span>
                                                 <span class="hljs-symbol">:max-amt</span> <span class="hljs-number">100</span>})]
                    pstate)</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>For complete details on using these navigators, consult the API docs. <code>sorted-set-range</code>, <code>sorted-set-range-from</code>, and <code>sorted-set-range-to</code> work just like their map counterparts.</p>
</div>
</div>
<div class="sect3">
<h4 id="_reactive_queries"><a class="anchor" href="#_reactive_queries"></a>Reactive queries</h4>
<div class="paragraph">
<p>Rama’s PStates have powerful capabilities for reactive queries. Reactive queries on PStates are <em>fine-grained</em>.  When the state on a PState changes, instead of sending the full new value back to a subscriber, it instead sends back the minimal "diff" encapsulating the change. This diff is incrementally applied, and you can inspect and react to these diffs as well. For more information on how reactive queries work, consult <a href="pstates.html#_reactive_queries" class="page">this section</a>.</p>
</div>
<div class="paragraph">
<p>The Clojure API function for doing reactive queries is <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-foreign-proxy">foreign-proxy</a>. It works just like <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-foreign-select-one">foreign-select-one</a>, except instead of returning a value it returns a <a href="https://redplanetlabs.com/javadoc/com/rpl/rama/ProxyState.html">ProxyState</a> that represents the value.</p>
</div>
<div class="paragraph">
<p>You can call <a href="https://clojure.github.io/clojure/clojure.core-api.html#clojure.core/deref">deref</a> on a <code>ProxyState</code> to get the current value of the query at that point in time. <code>deref</code> on <code>ProxyState</code> does not do a remote query. Behind the scenes, the PState partition being queried pushes fine-grained diffs to the <code>ProxyState</code> that get applied incrementally. <code>deref</code> gets the current cached value.</p>
</div>
<div class="paragraph">
<p><code>foreign-proxy</code> also accepts an option <code>:callback-fn</code> that allows you to inspect and process the diffs being pushed by the server as they come in. Here’s an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name">foreign-proxy</span> [<span class="hljs-symbol">:a</span> <span class="hljs-symbol">:b</span>]
               pstate
               {<span class="hljs-symbol">:callback-fn</span> (<span class="hljs-name"><span class="hljs-builtin-name">fn</span></span> [newval diff oldval]
                               (<span class="hljs-name">println</span> <span class="hljs-string">"Callback:"</span> oldval <span class="hljs-string">"-&gt;"</span> newval <span class="hljs-string">"with diff"</span> diff))})</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>The callback function receives the new value of the query, the previous value of the query, and a fine-grained diff representing the change to that value. If you were querying a set, for example, that diff could tell you specifically what elements were removed and added. The diff objects are the same as provided to the Java API, and a full description of their hierarchy and tools available to process them is <a href="pstates.html#_diffs" class="page">in this section</a>.</p>
</div>
<div class="paragraph">
<p>The API docs on the navigators in <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.path.html">com.rpl.rama.path</a> detail what diffs are produced by each navigator in transforms.</p>
</div>
<div class="paragraph">
<p><code>foreign-proxy</code> also accepts the <code>:pkey</code> option to specify an explicit partitioning key, just like the non-reactive queries.</p>
</div>
<div class="paragraph">
<p>Finally, the non-blocking version of <code>foreign-proxy</code> is <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-foreign-proxy-async">foreign-proxy-async</a>. This returns a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html">CompletableFuture</a> of a <code>ProxyState</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_foreign_query_topology_invokes"><a class="anchor" href="#_foreign_query_topology_invokes"></a>Foreign query topology invokes</h3>
<div class="paragraph">
<p>A query topology client is invoked using <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-foreign-invoke-query">foreign-invoke-query</a>. It works just like a regular function by taking in a list of arguments and returning a result. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(<span class="hljs-name"><span class="hljs-builtin-name">def</span></span> query-result (<span class="hljs-name">foreign-invoke-query</span> my-query <span class="hljs-string">"arg1"</span> <span class="hljs-symbol">:arg2</span> <span class="hljs-number">3</span>))</code></pre>
<div class="source-toolbox"><span class="source-lang">clojure</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Unlike a regular function, this executes the query on a cluster across potentially many nodes.</p>
</div>
<div class="paragraph">
<p>There’s also a non-blocking version of <code>foreign-invoke-query</code> called <a href="https://redplanetlabs.com/clojuredoc/com.rpl.rama.html#var-foreign-invoke-query-async">foreign-invoke-query-async</a>. This returns a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html">CompletableFuture</a> that’s delivered the result.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary"><a class="anchor" href="#_summary"></a>Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section, you learned how to define and use modules, depots, topologies, and PStates. On <a href="clj-dataflow-lang.html" class="page">the next page</a>, you’ll learn all the details of using Rama’s dataflow API.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
</footer>
<script type="text/javascript" src="../../_/js/main.js"></script>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async="" src="../../_/js/vendor/highlight.js"></script>
  

<table cellspacing="0" cellpadding="0" role="presentation" class="gstl_50 gssb_c" style="width: 217px; display: none; top: 50px; left: 1048px; position: absolute;"><tbody><tr><td class="gssb_f"></td><td class="gssb_e" style="width: 100%;"></td></tr></tbody></table></body></html>