<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Testing :: Red Planet Labs Documentation</title>
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
<!-- Google tag (gtag.js) -->
<script async="" src="//cse.google.com/adsense/search/async-ads.js"></script><script type="text/javascript" async="" src="https://www.googletagmanager.com/gtag/js?id=G-6FCG0W0TYJ&amp;l=dataLayer&amp;cx=c&amp;gtm=457e53h1za200&amp;tag_exp=102482433~102587591~102717422~102788824~102813109~102814060~102825837~102879719"></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-137231341-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6FCG0W0TYJ');
</script>
  <script src="https://www.google.com/cse/static/element/75c56d121cde450a/cse_element__en.js?usqp=CAM%3D" type="text/javascript"></script><link type="text/css" href="https://www.google.com/cse/static/element/75c56d121cde450a/default+en.css" rel="stylesheet"><link type="text/css" href="https://www.google.com/cse/static/style/look/v4/default.css" rel="stylesheet"><style type="text/css">.gsc-control-cse{font-family:arial, sans-serif}.gsc-control-cse .gsc-table-result{font-family:arial, sans-serif}.gsc-refinementsGradient{background:linear-gradient(to left,rgba(255,255,255,1),rgba(255,255,255,0))}.gsc-control-cse{border-color:#1a1a1a;background-color:#1a1a1a}input.gsc-input,.gsc-input-box,.gsc-input-box-hover,.gsc-input-box-focus{border-color:#DFE1E5}.gsc-search-button-v2,.gsc-search-button-v2:hover,.gsc-search-button-v2:focus{border-color:#3079ED;background-color:#4D90FE;background-image:none;filter:none}.gsc-search-button-v2 svg{fill:#FFFFFF}.gsc-tabHeader.gsc-tabhActive,.gsc-refinementHeader.gsc-refinementhActive{color:#1A73E8;border-color:#1A73E8;background-color:#FFFFFF}.gsc-tabHeader.gsc-tabhInactive,.gsc-refinementHeader.gsc-refinementhInactive{color:#666666;border-color:#666666;background-color:#FFFFFF}.gsc-webResult.gsc-result,.gsc-results .gsc-imageResult{border-color:#FFFFFF;background-color:#FFFFFF}.gsc-webResult.gsc-result:hover{border-color:#FFFFFF;background-color:#FFFFFF}.gs-webResult.gs-result a.gs-title:link,.gs-webResult.gs-result a.gs-title:link b,.gs-imageResult a.gs-title:link,.gs-imageResult a.gs-title:link b{color:#1155CC}.gs-webResult.gs-result a.gs-title:visited,.gs-webResult.gs-result a.gs-title:visited b,.gs-imageResult a.gs-title:visited,.gs-imageResult a.gs-title:visited b{color:#1155CC}.gs-webResult.gs-result a.gs-title:hover,.gs-webResult.gs-result a.gs-title:hover b,.gs-imageResult a.gs-title:hover,.gs-imageResult a.gs-title:hover b{color:#1155CC}.gs-webResult.gs-result a.gs-title:active,.gs-webResult.gs-result a.gs-title:active b,.gs-imageResult a.gs-title:active,.gs-imageResult a.gs-title:active b{color:#1155CC}.gsc-cursor-page{color:#1155CC}a.gsc-trailing-more-results:link{color:#1155CC}.gs-webResult:not(.gs-no-results-result):not(.gs-error-result) .gs-snippet,.gs-fileFormatType{color:#333333}.gs-webResult div.gs-visibleUrl{color:#009933}.gs-webResult div.gs-visibleUrl-short{color:#009933}.gs-webResult div.gs-visibleUrl-short{display:none}.gs-webResult div.gs-visibleUrl-long{display:none}.gs-webResult div.gs-visibleUrl-breadcrumb{display:block}.gs-promotion div.gs-visibleUrl-short{display:none}.gs-promotion div.gs-visibleUrl-long{display:block}.gs-promotion div.gs-visibleUrl-breadcrumb{display:none}.gsc-cursor-box{border-color:#FFFFFF}.gsc-results .gsc-cursor-box .gsc-cursor-page{border-color:#666666;background-color:#FFFFFF;color:#666666}.gsc-results .gsc-cursor-box .gsc-cursor-current-page{border-color:#1A73E8;background-color:#FFFFFF;color:#1A73E8}.gsc-webResult.gsc-result.gsc-promotion{border-color:#FFFFFF;background-color:#F6F6F6}.gsc-completion-title{color:#1155CC}.gsc-completion-snippet{color:#333333}.gs-promotion a.gs-title:link,.gs-promotion a.gs-title:link *,.gs-promotion .gs-snippet a:link{color:#1155CC}.gs-promotion a.gs-title:visited,.gs-promotion a.gs-title:visited *,.gs-promotion .gs-snippet a:visited{color:#1155CC}.gs-promotion a.gs-title:hover,.gs-promotion a.gs-title:hover *,.gs-promotion .gs-snippet a:hover{color:#1155CC}.gs-promotion a.gs-title:active,.gs-promotion a.gs-title:active *,.gs-promotion .gs-snippet a:active{color:#1155CC}.gs-promotion .gs-snippet,.gs-promotion .gs-title .gs-promotion-title-right,.gs-promotion .gs-title .gs-promotion-title-right *{color:#333333}.gs-promotion .gs-visibleUrl,.gs-promotion .gs-visibleUrl-short{color:#009933}.gcsc-find-more-on-google{color:#1155CC}.gcsc-find-more-on-google-magnifier{fill:#1155CC}</style><style type="text/css">.gscb_a{display:inline-block;font:27px/13px arial,sans-serif}.gsst_a .gscb_a{color:#a1b9ed;cursor:pointer}.gsst_a:hover .gscb_a,.gsst_a:focus .gscb_a{color:#36c}.gsst_a{display:inline-block}.gsst_a{cursor:pointer;padding:0 4px}.gsst_a:hover{text-decoration:none!important}.gsst_b{font-size:16px;padding:0 2px;position:relative;user-select:none;-webkit-user-select:none;white-space:nowrap}.gsst_e{vertical-align:middle;opacity:0.55;}.gsst_a:hover .gsst_e,.gsst_a:focus .gsst_e{opacity:0.72;}.gsst_a:active .gsst_e{opacity:1;}.gsst_f{background:white;text-align:left}.gsst_g{background-color:white;border:1px solid #ccc;border-top-color:#d9d9d9;box-shadow:0 2px 4px rgba(0,0,0,0.2);-webkit-box-shadow:0 2px 4px rgba(0,0,0,0.2);margin:-1px -3px;padding:0 6px}.gsst_h{background-color:white;height:1px;margin-bottom:-1px;position:relative;top:-1px}.gsib_a{width:100%;padding:4px 6px 0}.gsib_a,.gsib_b{vertical-align:top}.gssb_c{border:0;position:absolute;z-index:989}.gssb_e{border:1px solid #ccc;border-top-color:#d9d9d9;box-shadow:0 2px 4px rgba(0,0,0,0.2);-webkit-box-shadow:0 2px 4px rgba(0,0,0,0.2);cursor:default}.gssb_f{visibility:hidden;white-space:nowrap}.gssb_k{border:0;display:block;position:absolute;top:0;z-index:988}.gsdd_a{border:none!important}.gsq_a{padding:0}.gssb_a{padding:0 7px}.gssb_a,.gssb_a td{white-space:nowrap;overflow:hidden;line-height:22px}#gssb_b{font-size:11px;color:#36c;text-decoration:none}#gssb_b:hover{font-size:11px;color:#36c;text-decoration:underline}.gssb_g{text-align:center;padding:8px 0 7px;position:relative}.gssb_h{font-size:15px;height:28px;margin:0.2em;-webkit-appearance:button}.gssb_i{background:#eee}.gss_ifl{visibility:hidden;padding-left:5px}.gssb_i .gss_ifl{visibility:visible}a.gssb_j{font-size:13px;color:#36c;text-decoration:none;line-height:100%}a.gssb_j:hover{text-decoration:underline}.gssb_l{height:1px;background-color:#e5e5e5}.gssb_m{color:#000;background:#fff}.gssb_a{padding:0 9px}.gsib_a{padding:5px 9px 4px 9px}.gscb_a{line-height:27px}.gssb_e{border:0}.gssb_l{margin:5px 0}input.gsc-input::-webkit-input-placeholder{font-size:14px}input.gsc-input:-moz-placeholder{font-size:14px}input.gsc-input::-moz-placeholder{font-size:14px}input.gsc-input:-ms-input-placeholder{font-size:14px}input.gsc-input:focus::-webkit-input-placeholder{color:transparent}input.gsc-input:focus:-moz-placeholder{color:transparent}input.gsc-input:focus::-moz-placeholder{color:transparent}input.gsc-input:focus:-ms-input-placeholder{color:transparent}.gssb_c .gsc-completion-container{position:static}.gssb_c{z-index:5000}.gsc-completion-container table{background:transparent;font-size:inherit;font-family:inherit}.gssb_c > tbody > tr,.gssb_c > tbody > tr > td,.gssb_d,.gssb_d > tbody > tr,.gssb_d > tbody > tr > td,.gssb_e,.gssb_e > tbody > tr,.gssb_e > tbody > tr > td{padding:0;margin:0;border:0}.gssb_a table,.gssb_a table tr,.gssb_a table tr td{padding:0;margin:0;border:0}</style></head>
  <body class="article">
<style>
  p {
    hyphens: none;
  }
  td {
    hyphens: none;
  }

  p code {
    background: #eeeeee !important
  }

  .gsc-clear-button {
    display: none;
  }

  .gsc-control-cse {
    font-size: 10px !important
  }
</style>
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="/docs/~/index.html">Red Planet Labs Documentation</a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <script async="" src="https://cse.google.com/cse.js?cx=a198d0f9938004cd4">
          </script>
          <div id="___gcse_0"><div class="gsc-control-cse gsc-control-cse-en"><div class="gsc-control-wrapper-cse" dir="ltr"><form class="gsc-search-box gsc-search-box-tools" accept-charset="utf-8"><table cellspacing="0" cellpadding="0" role="presentation" class="gsc-search-box"><tbody><tr><td class="gsc-input"><div class="gsc-input-box" id="gsc-iw-id1"><table cellspacing="0" cellpadding="0" role="presentation" id="gs_id50" class="gstl_50 gsc-input" style="width: 100%; padding: 0px;"><tbody><tr><td id="gs_tti50" class="gsib_a"><input autocomplete="off" type="text" size="10" class="gsc-input" name="search" title="search" aria-label="search" id="gsc-i-id1" dir="ltr" spellcheck="false" style="width: 100%; padding: 0px; border: none; margin: 0px; height: auto; outline: none;"></td><td class="gsib_b"><div class="gsst_b" id="gs_st50" dir="ltr"><a class="gsst_a" href="javascript:void(0)" title="Clear search box" role="button" style="display: none;"><span class="gscb_a" id="gs_cb50" aria-hidden="true">Ã—</span></a></div></td></tr></tbody></table></div></td><td class="gsc-search-button"><button class="gsc-search-button gsc-search-button-v2"><svg width="13" height="13" viewBox="0 0 13 13"><title>search</title><path d="m4.8495 7.8226c0.82666 0 1.5262-0.29146 2.0985-0.87438 0.57232-0.58292 0.86378-1.2877 0.87438-2.1144 0.010599-0.82666-0.28086-1.5262-0.87438-2.0985-0.59352-0.57232-1.293-0.86378-2.0985-0.87438-0.8055-0.010599-1.5103 0.28086-2.1144 0.87438-0.60414 0.59352-0.8956 1.293-0.87438 2.0985 0.021197 0.8055 0.31266 1.5103 0.87438 2.1144 0.56172 0.60414 1.2665 0.8956 2.1144 0.87438zm4.4695 0.2115 3.681 3.6819-1.259 1.284-3.6817-3.7 0.0019784-0.69479-0.090043-0.098846c-0.87973 0.76087-1.92 1.1413-3.1207 1.1413-1.3553 0-2.5025-0.46363-3.4417-1.3909s-1.4088-2.0686-1.4088-3.4239c0-1.3553 0.4696-2.4966 1.4088-3.4239 0.9392-0.92727 2.0864-1.3969 3.4417-1.4088 1.3553-0.011889 2.4906 0.45771 3.406 1.4088 0.9154 0.95107 1.379 2.0924 1.3909 3.4239 0 1.2126-0.38043 2.2588-1.1413 3.1385l0.098834 0.090049z"></path></svg></button></td><td class="gsc-clear-button"><div class="gsc-clear-button" title="clear results">&nbsp;</div></td></tr></tbody></table></form><div class="gsc-results-wrapper-overlay"><div class="gsc-results-close-btn" tabindex="0"></div><div class="gsc-positioningWrapper"><div class="gsc-tabsAreaInvisible"><div aria-label="refinement" role="tab" class="gsc-tabHeader gsc-inline-block gsc-tabhActive">Custom Search</div><span class="gs-spacer"> </span></div></div><div class="gsc-positioningWrapper"><div class="gsc-refinementsAreaInvisible"></div></div><div class="gsc-above-wrapper-area-invisible"><div class="gsc-above-wrapper-area-backfill-container"></div><table cellspacing="0" cellpadding="0" role="presentation" class="gsc-above-wrapper-area-container"><tbody><tr><td class="gsc-result-info-container"><div class="gsc-result-info-invisible"></div></td><td class="gsc-orderby-container"><div class="gsc-orderby-invisible"><div class="gsc-orderby-label gsc-inline-block">Sort by:</div><div class="gsc-option-menu-container gsc-inline-block"><div class="gsc-selected-option-container gsc-inline-block"><div class="gsc-selected-option">Relevance</div><div class="gsc-option-selector"></div></div><div class="gsc-option-menu-invisible"><div class="gsc-option-menu-item gsc-option-menu-item-highlighted"><div class="gsc-option">Relevance</div></div><div class="gsc-option-menu-item"><div class="gsc-option">Date</div></div></div></div></div></td></tr></tbody></table></div><div class="gsc-adBlockInvisible"></div><div class="gsc-wrapper"><div class="gsc-adBlockInvisible"></div><div class="gsc-resultsbox-invisible"><div class="gsc-resultsRoot gsc-tabData gsc-tabdActive"><div><div class="gsc-expansionArea"></div></div></div></div></div></div><div class="gsc-modal-background-image" tabindex="0"></div></div></div></div>
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="docs" data-version="~">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style=""></button>
    <h3 class="title"><a href="index.html">Documentation</a></h3>
<ul class="nav-list">
  <li class="nav-item is-active is-current-path" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="why-use-rama.html">Why use Rama?</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="tutorial1.html">Tutorial</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tutorial1.html">First module</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tutorial2.html">Depots, ETLs, and PStates</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tutorial3.html">Distributed programming</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tutorial4.html">Dataflow programming</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tutorial5.html">Types of ETLs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tutorial6.html">Tying it all together</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="downloads-maven-local-dev.html">Downloads, Maven, and local development</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="terminology.html">Terminology</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="paths.html">Paths</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="intermediate-dataflow.html">Intermediate dataflow programming</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="aggregators.html">Aggregators</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="stream.html">Stream topologies</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="microbatch.html">Microbatch topologies</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="query.html">Query topologies</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="depots.html">Depots</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="pstates.html">PStates</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="partitioners.html">Partitioners</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="serialization.html">Custom serialization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="module-dependencies.html">Dependencies between modules</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="operating-rama.html">Operating Rama clusters</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="heterogenous-clusters.html">Heterogenous clusters</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="replication.html">Replication</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="backups.html">Backups</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="acid.html">ACID semantics</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="rest.html">REST API</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="integrating.html">Integrating with other tools</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="all-configs.html">All configs</a>
  </li>
  <li class="nav-item is-current-page is-active" data-depth="1">
    <a class="nav-link" href="testing.html">Testing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="clj-defining-modules.html">Clojure API</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="clj-defining-modules.html">Defining and using modules</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="clj-dataflow-lang.html">Dataflow language</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="clj-serialization.html">Custom serialization</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="clj-testing.html">Testing</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Documentation</span>
    <span class="version">~</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <div class="title"><a href="index.html">Documentation</a></div>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">~</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Documentation</a></li>
    <li><a href="testing.html">Testing</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"><h3>Contents</h3><ul><li data-level="1"><a href="#_using_inprocesscluster" class="">Using InProcessCluster</a></li><li data-level="2"><a href="#_testing_microbatch_topologies" class="">Testing microbatch topologies</a></li><li data-level="2"><a href="#_testing_stream_topologies_that_are_using_mirror_depots" class="">Testing stream topologies that are using mirror depots</a></li><li data-level="2"><a href="#_module_update" class="is-active">Module update</a></li><li data-level="2"><a href="#_module_destroy">Module destroy</a></li><li data-level="1"><a href="#_testing_modules_with_circular_dependencies">Testing modules with circular dependencies</a></li><li data-level="1"><a href="#_unit_testing_a_custom_ramaoperation_with_mockoutputcollector">Unit testing a custom RamaOperation with MockOutputCollector</a></li><li data-level="1"><a href="#_testpstate">TestPState</a></li><li data-level="1"><a href="#_summary">Summary</a></li></ul></div>
</aside>
<article class="doc">
<h1 class="page">Testing</h1>
<aside class="toc embedded"><div class="toc-menu"><h3>Contents</h3><ul><li data-level="1"><a href="#_using_inprocesscluster">Using InProcessCluster</a></li><li data-level="2"><a href="#_testing_microbatch_topologies">Testing microbatch topologies</a></li><li data-level="2"><a href="#_testing_stream_topologies_that_are_using_mirror_depots">Testing stream topologies that are using mirror depots</a></li><li data-level="2"><a href="#_module_update">Module update</a></li><li data-level="2"><a href="#_module_destroy">Module destroy</a></li><li data-level="1"><a href="#_testing_modules_with_circular_dependencies">Testing modules with circular dependencies</a></li><li data-level="1"><a href="#_unit_testing_a_custom_ramaoperation_with_mockoutputcollector">Unit testing a custom RamaOperation with MockOutputCollector</a></li><li data-level="1"><a href="#_testpstate">TestPState</a></li><li data-level="1"><a href="#_summary">Summary</a></li></ul></div></aside><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Ramaâ€™s integrated approach pays huge dividends when it comes to testing. Instead of needing to juggle complex set ups, teardowns, and mocks of disparate databases, data processors, and other tools, full Rama clusters and modules can be simulated in a single process with very little code using <a href="https://redplanetlabs.com/javadoc/com/rpl/rama/test/InProcessCluster.html">InProcessCluster</a>. This lets you test every aspect of your modules end-to-end.</p>
</div>
<div class="paragraph">
<p>On this page, youâ€™ll learn:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using <code>InProcessCluster</code></p>
</li>
<li>
<p>Testing stream topologies that are using mirror depots</p>
</li>
<li>
<p>Testing modules with circular dependencies</p>
</li>
<li>
<p><code>MockOutputCollector</code> for unit testing custom operations</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All examples on this page can be found in the <a href="https://github.com/redplanetlabs/rama-examples">rama-examples</a> project.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_inprocesscluster"><a class="anchor" href="#_using_inprocesscluster"></a>Using InProcessCluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With <code>InProcessCluster</code> you can launch, update, and destroy modules just like you can on a real cluster. There are no differences in module capabilities or execution semantics between an <code>InProcessCluster</code> and a real cluster.</p>
</div>
<div class="paragraph">
<p>Hereâ€™s an example of using <code>InProcessCluster</code> along with JUnit to test a simple module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SimpleInProcessClusterExample</span> </span>{
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SimpleModule</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RamaModule</span> </span>{
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">define</span><span class="hljs-params">(Setup setup, Topologies topologies)</span> </span>{
      setup.declareDepot(<span class="hljs-string">"*depot"</span>, Depot.hashBy(Ops.IDENTITY));

      StreamTopology s = topologies.stream(<span class="hljs-string">"counter"</span>);
      s.pstate(<span class="hljs-string">"$$counts"</span>, PState.mapSchema(String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Long</span>.<span class="hljs-title">class</span>))</span>;
      s.source(<span class="hljs-string">"*depot"</span>).out(<span class="hljs-string">"*k"</span>)
       .compoundAgg(<span class="hljs-string">"$$counts"</span>, CompoundAgg.map(<span class="hljs-string">"*k"</span>, Agg.count()));
    }
  }

  <span class="hljs-meta">@Test</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">simpleTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    <span class="hljs-keyword">try</span>(InProcessCluster cluster = InProcessCluster.create()) {
      cluster.launchModule(<span class="hljs-keyword">new</span> SimpleModule(), <span class="hljs-keyword">new</span> LaunchConfig(<span class="hljs-number">4</span>, <span class="hljs-number">2</span>));

      String moduleName = SimpleModule<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>()</span>;
      Depot depot = cluster.clusterDepot(moduleName, <span class="hljs-string">"*depot"</span>);
      PState counts = cluster.clusterPState(moduleName, <span class="hljs-string">"$$counts"</span>);

      depot.append(<span class="hljs-string">"cagney"</span>);
      depot.append(<span class="hljs-string">"davis"</span>);
      depot.append(<span class="hljs-string">"cagney"</span>);

      assertEquals(<span class="hljs-number">2</span>, (Long) counts.selectOne(Path.key(<span class="hljs-string">"cagney"</span>)));
      assertEquals(<span class="hljs-number">1</span>, (Long) counts.selectOne(Path.key(<span class="hljs-string">"davis"</span>)));
      assertNull(counts.selectOne(Path.key(<span class="hljs-string">"garbo"</span>)));
    }
  }
}</code></pre>
<div class="source-toolbox"><span class="source-lang">java</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>An <code>InProcessCluster</code> launches many threads for a <a href="terminology.html#_conductor" class="page">Conductor</a>, a <a href="terminology.html#_supervisor" class="page">Supervisor</a>, the <a href="terminology.html#_metastore" class="page">Metastore</a>, and any workers launched by the module. So itâ€™s important to call <code>close</code> on an <code>InProcessCluster</code> when the test finishes to clean up those resources. Generally itâ€™s easiest to use a <code>try</code> block as demonstrated in this example to handle calling <code>close</code> for you.</p>
</div>
<div class="paragraph">
<p>An <code>InProcessCluster</code> is created using <code>InProcessCluster.create()</code>. Thereâ€™s another version of that method for registering custom serializations which is explained more on <a href="serialization.html" class="page">this page</a>.</p>
</div>
<div class="paragraph">
<p>A module is launched on an <code>InProcessCluster</code> using the method <code>launchModule</code>. It takes as input an instance of a module and a <code>LaunchConfig</code> to specify the parallelism. This example specifies four tasks and two task threads. The replication factor cannot be configured for a module on an <code>InProcessCluster</code> since it doesnâ€™t change the semantics of the module. So all modules on an <code>InProcessCluster</code> run with a replication factor of one.</p>
</div>
<div class="paragraph">
<p>You can also specify multiple workers using the <code>numWorkers</code> method on <code>LaunchConfig</code>, like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">cluster.launchModule(<span class="hljs-keyword">new</span> SimpleModule(), <span class="hljs-keyword">new</span> LaunchConfig(<span class="hljs-number">4</span>, <span class="hljs-number">2</span>).numWorkers(<span class="hljs-number">2</span>));</code></pre>
<div class="source-toolbox"><span class="source-lang">java</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>This would run two workers each with one task thread and two tasks. Running more workers doesnâ€™t change the semantics of a module, but it does enable the module to exercise any custom serializations you have registered. Within a module Rama only performs serialization of data between workers and doesnâ€™t serialize data going to a task thread located within the same worker.</p>
</div>
<div class="paragraph">
<p>The general flow of testing with <code>InProcessCluster</code> is to perform depot appends and then assert on the expected changes to downstream PStates. With a stream topology, like in this example, depot appends using <a href="depots.html#_depot_client_api" class="page">AckLevel.ACK</a> donâ€™t return until all downstream processing has finished. So the assertions can be made immediately on the PStates after the depot appends complete.</p>
</div>
<div class="sect2">
<h3 id="_testing_microbatch_topologies"><a class="anchor" href="#_testing_microbatch_topologies"></a>Testing microbatch topologies</h3>
<div class="paragraph">
<p>With a microbatch topology, processing is asynchronous to depot appends even with <code>AckLevel.ACK</code>. So <code>InProcessCluster</code> provides the helper method <code>waitForMicrobatchProcessedCount</code> to ease testing. Hereâ€™s an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MicrobatchTestingExample</span> </span>{
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MicrobatchModule</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RamaModule</span> </span>{
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">define</span><span class="hljs-params">(Setup setup, Topologies topologies)</span> </span>{
      setup.declareDepot(<span class="hljs-string">"*depot"</span>, Depot.hashBy(Ops.IDENTITY));

      MicrobatchTopology mb = topologies.microbatch(<span class="hljs-string">"counter"</span>);
      mb.pstate(<span class="hljs-string">"$$counts"</span>, PState.mapSchema(String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Long</span>.<span class="hljs-title">class</span>))</span>;
      mb.source(<span class="hljs-string">"*depot"</span>).out(<span class="hljs-string">"*mb"</span>)
        .explodeMicrobatch(<span class="hljs-string">"*mb"</span>).out(<span class="hljs-string">"*k"</span>)
        .compoundAgg(<span class="hljs-string">"$$counts"</span>, CompoundAgg.map(<span class="hljs-string">"*k"</span>, Agg.count()));
    }
  }

  <span class="hljs-meta">@Test</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">microbatchTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    <span class="hljs-keyword">try</span>(InProcessCluster cluster = InProcessCluster.create()) {
      cluster.launchModule(<span class="hljs-keyword">new</span> MicrobatchModule(), <span class="hljs-keyword">new</span> LaunchConfig(<span class="hljs-number">4</span>, <span class="hljs-number">2</span>));

      String moduleName = MicrobatchModule<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>()</span>;
      Depot depot = cluster.clusterDepot(moduleName, <span class="hljs-string">"*depot"</span>);
      PState counts = cluster.clusterPState(moduleName, <span class="hljs-string">"$$counts"</span>);

      depot.append(<span class="hljs-string">"cagney"</span>);
      depot.append(<span class="hljs-string">"davis"</span>);
      depot.append(<span class="hljs-string">"cagney"</span>);

      cluster.waitForMicrobatchProcessedCount(moduleName, <span class="hljs-string">"counter"</span>, <span class="hljs-number">3</span>);
      assertEquals(<span class="hljs-number">2</span>, (Long) counts.selectOne(Path.key(<span class="hljs-string">"cagney"</span>)));
      assertEquals(<span class="hljs-number">1</span>, (Long) counts.selectOne(Path.key(<span class="hljs-string">"davis"</span>)));
      assertNull(counts.selectOne(Path.key(<span class="hljs-string">"garbo"</span>)));

      depot.append(<span class="hljs-string">"cagney"</span>);

      cluster.waitForMicrobatchProcessedCount(moduleName, <span class="hljs-string">"counter"</span>, <span class="hljs-number">4</span>);
      assertEquals(<span class="hljs-number">3</span>, (Long) counts.selectOne(Path.key(<span class="hljs-string">"cagney"</span>)));
    }
  }
}</code></pre>
<div class="source-toolbox"><span class="source-lang">java</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>This example uses <code>waitForMicrobatchProcessedCount</code> to ensure the PStates reflect the processing of the appended depot records. <code>waitForMicrobatchProcessedCount</code> takes in as input a module name, topology name, and a total number of depot records. Critically, the number of depot records specified represents the total amount of records ever processed by the topology, not the number of depot records since the last time it was called. This is why the example first waits for three records and then waits for four records after appending one more record.</p>
</div>
<div class="paragraph">
<p><code>InProcessCluster</code> also exposes facilities to pause and resume microbatch topologies. Since microbatching is always running asynchronously, you canâ€™t control which depot records comprise an individual microbatch attempt. If you perform three depot appends, those could be processed in three separate microbatches, in two separate microbatches, or in one microbatch. If you care about the composition of a microbatch for the purposes of testing, like to test the behavior of <a href="intermediate-dataflow.html#_batch_blocks" class="page">batch blocks</a>, you can use <code>pauseMicrobatchTopology</code> and <code>resumeMicrobatchTopology</code>. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">cluster.pauseMicrobatchTopology(moduleName, <span class="hljs-string">"counter"</span>);
depot.append(<span class="hljs-string">"a"</span>);
depot.append(<span class="hljs-string">"b"</span>);
depot.append(<span class="hljs-string">"c"</span>);
depot.append(<span class="hljs-string">"a"</span>);
cluster.resumeMicrobatchTopology(moduleName, <span class="hljs-string">"counter"</span>);</code></pre>
<div class="source-toolbox"><span class="source-lang">java</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p><code>pauseMicrobatchTopology</code> waits for the currently in-flight microbatch to complete before returning. Since a microbatch processes up to 1000 unprocessed records from each depot partition (by default), this code guarantees the next microbatch will contain those four records.</p>
</div>
</div>
<div class="sect2">
<h3 id="_testing_stream_topologies_that_are_using_mirror_depots"><a class="anchor" href="#_testing_stream_topologies_that_are_using_mirror_depots"></a>Testing stream topologies that are using mirror depots</h3>
<div class="paragraph">
<p>Depot appends using <code>AckLevel.ACK</code> donâ€™t wait for stream topologies from other modules to finish processing them. So whereas with colocated stream topologies you can assert on PStates immediately after a depot append finishes, stream topologies consuming mirror depots may still be processing that depot record after the append finishes.</p>
</div>
<div class="paragraph">
<p>The technique to use in this case is to repeatedly poll the desired PState condition up to a timeout. Hereâ€™s an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StreamTopologyWithMirrorTestingExample</span> </span>{
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DepotModule</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RamaModule</span> </span>{
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">define</span><span class="hljs-params">(Setup setup, Topologies topologies)</span> </span>{
      setup.declareDepot(<span class="hljs-string">"*depot"</span>, Depot.hashBy(Ops.IDENTITY));
    }
  }

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CounterModule</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RamaModule</span> </span>{
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">define</span><span class="hljs-params">(Setup setup, Topologies topologies)</span> </span>{
      setup.clusterDepot(<span class="hljs-string">"*mirror"</span>, DepotModule<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>(), "*<span class="hljs-title">depot</span>")</span>;

      StreamTopology s = topologies.stream(<span class="hljs-string">"counter"</span>);
      s.pstate(<span class="hljs-string">"$$counts"</span>, PState.mapSchema(String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Long</span>.<span class="hljs-title">class</span>))</span>;
      s.source(<span class="hljs-string">"*mirror"</span>).out(<span class="hljs-string">"*k"</span>)
       .hashPartition(<span class="hljs-string">"*k"</span>)
       .compoundAgg(<span class="hljs-string">"$$counts"</span>, CompoundAgg.map(<span class="hljs-string">"*k"</span>, Agg.count()));
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">assertValueAttained</span><span class="hljs-params">(Object expected, RamaFunction0 f)</span> <span class="hljs-keyword">throws</span> Exception </span>{
    <span class="hljs-keyword">long</span> nanos = System.nanoTime();
    <span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>) {
      Object val = f.invoke();
      <span class="hljs-keyword">if</span>(expected.equals(val)) <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(System.nanoTime() - nanos &gt; <span class="hljs-number">1000000000L</span> * <span class="hljs-number">30</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"Condition failed to attain "</span> + expected + <span class="hljs-string">" != "</span> + val);
      }
      Thread.sleep(<span class="hljs-number">50</span>);
    }
  }

  <span class="hljs-meta">@Test</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">streamTopologyWithMirrorTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    <span class="hljs-keyword">try</span>(InProcessCluster cluster = InProcessCluster.create()) {
      cluster.launchModule(<span class="hljs-keyword">new</span> DepotModule(), <span class="hljs-keyword">new</span> LaunchConfig(<span class="hljs-number">8</span>, <span class="hljs-number">2</span>));
      cluster.launchModule(<span class="hljs-keyword">new</span> CounterModule(), <span class="hljs-keyword">new</span> LaunchConfig(<span class="hljs-number">4</span>, <span class="hljs-number">2</span>));

      Depot depot = cluster.clusterDepot(DepotModule<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>(), "*<span class="hljs-title">depot</span>")</span>;
      PState counts = cluster.clusterPState(CounterModule<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>(), "$$<span class="hljs-title">counts</span>")</span>;

      depot.append(<span class="hljs-string">"cagney"</span>);
      depot.append(<span class="hljs-string">"davis"</span>);
      depot.append(<span class="hljs-string">"cagney"</span>);

      assertValueAttained(<span class="hljs-number">2L</span>, () -&gt; counts.selectOne(Path.key(<span class="hljs-string">"cagney"</span>)));
      assertValueAttained(<span class="hljs-number">1L</span>, () -&gt; counts.selectOne(Path.key(<span class="hljs-string">"davis"</span>)));
    }
  }
}</code></pre>
<div class="source-toolbox"><span class="source-lang">java</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Like the other examples, this code creates a PState that counts the depot records. The difference is the depot is kept in a separate module as the stream topology computing the counts.</p>
</div>
<div class="paragraph">
<p>To perform the assertions, this class defines a helper <code>assertValueAttained</code> that polls the provided function for up to 30 seconds until it equals the expected value. Itâ€™s important to use a generous timeout since garbage collection can easily cause a condition like this to fail incorrectly if the timeout is low.</p>
</div>
</div>
<div class="sect2">
<h3 id="_module_update"><a class="anchor" href="#_module_update"></a>Module update</h3>
<div class="paragraph">
<p>You can also perform module updates with <code>InProcessCluster</code>. To perform module updates the two module instances you deploy need to have the same module name, so youâ€™ll need to override the <code>getModuleName</code> method of <code>RamaModule</code> to achieve this. Hereâ€™s an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UpdateExample</span> </span>{
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CounterModule_v1</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RamaModule</span> </span>{
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">define</span><span class="hljs-params">(Setup setup, Topologies topologies)</span> </span>{
      setup.declareDepot(<span class="hljs-string">"*depot"</span>, Depot.hashBy(Ops.IDENTITY));

      StreamTopology s = topologies.stream(<span class="hljs-string">"counter"</span>);
      s.pstate(<span class="hljs-string">"$$counts"</span>, PState.mapSchema(String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Long</span>.<span class="hljs-title">class</span>))</span>;
      s.source(<span class="hljs-string">"*depot"</span>).out(<span class="hljs-string">"*k"</span>)
       .compoundAgg(<span class="hljs-string">"$$counts"</span>, CompoundAgg.map(<span class="hljs-string">"*k"</span>, Agg.sum(<span class="hljs-number">2</span>)));
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getModuleName</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-string">"CounterModule"</span>;
    }
  }

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CounterModule_v2</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RamaModule</span> </span>{
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">define</span><span class="hljs-params">(Setup setup, Topologies topologies)</span> </span>{
      setup.declareDepot(<span class="hljs-string">"*depot"</span>, Depot.hashBy(Ops.IDENTITY));

      StreamTopology s = topologies.stream(<span class="hljs-string">"counter"</span>);
      s.pstate(<span class="hljs-string">"$$counts"</span>, PState.mapSchema(String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Long</span>.<span class="hljs-title">class</span>))</span>;
      s.source(<span class="hljs-string">"*depot"</span>).out(<span class="hljs-string">"*k"</span>)
       .compoundAgg(<span class="hljs-string">"$$counts"</span>, CompoundAgg.map(<span class="hljs-string">"*k"</span>, Agg.count()));
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getModuleName</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-string">"CounterModule"</span>;
    }
  }

  <span class="hljs-meta">@Test</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">updateTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    <span class="hljs-keyword">try</span>(InProcessCluster cluster = InProcessCluster.create()) {
      cluster.launchModule(<span class="hljs-keyword">new</span> CounterModule_v1(), <span class="hljs-keyword">new</span> LaunchConfig(<span class="hljs-number">4</span>, <span class="hljs-number">2</span>));
      Depot depot = cluster.clusterDepot(<span class="hljs-string">"CounterModule"</span>, <span class="hljs-string">"*depot"</span>);
      PState counts = cluster.clusterPState(<span class="hljs-string">"CounterModule"</span>, <span class="hljs-string">"$$counts"</span>);

      depot.append(<span class="hljs-string">"cagney"</span>);
      assertEquals(<span class="hljs-number">2</span>, (Long) counts.selectOne(Path.key(<span class="hljs-string">"cagney"</span>)));

      cluster.updateModule(<span class="hljs-keyword">new</span> CounterModule_v2());

      depot.append(<span class="hljs-string">"cagney"</span>);
      assertEquals(<span class="hljs-number">3</span>, (Long) counts.selectOne(Path.key(<span class="hljs-string">"cagney"</span>)));
    }
  }
}</code></pre>
<div class="source-toolbox"><span class="source-lang">java</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>This example simulates fixing a bug in a running module. The first version of "CounterModule" increments by two instead of by one, and the second version fixes that. In the test code, you can see that <code>depot</code> and <code>counts</code> can be used after the module update, just like with clients for real clusters. Internally those clients automatically redirect their appends/queries to the updated module instance.</p>
</div>
<div class="paragraph">
<p>The <code>updateModule</code> call shown in this example can only be used when no PStates or depots are being removed from the existing module instance. Just like <a href="operating-rama.html#_updating_modules" class="page">with real clusters</a>, since removing PStates and depots is destructive Rama requires you to be explicit about their removals. With real clusters this is specified with an additional flag on the Rama CLI, but with <code>InProcessCluster</code> this is specified with an additional argument to <code>updateModule</code>. For example, if the new version of your module removes <code>"*depot"</code> and <code>"$$p"</code>, the update code would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">cluster.updateModule(<span class="hljs-keyword">new</span> MyModule_v2(), UpdateOptions.objectsToDelete(<span class="hljs-string">"*depot"</span>, <span class="hljs-string">"$$p"</span>));</code></pre>
<div class="source-toolbox"><span class="source-lang">java</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>The deleted objects must be specified exactly or the update will not go through and youâ€™ll get an exception.</p>
</div>
</div>
<div class="sect2">
<h3 id="_module_destroy"><a class="anchor" href="#_module_destroy"></a>Module destroy</h3>
<div class="paragraph">
<p>You can also destroy modules using <code>InProcessCluster</code>. Hereâ€™s an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">cluster.destroyModule(<span class="hljs-string">"com.mycompany.MyModule"</span>);</code></pre>
<div class="source-toolbox"><span class="source-lang">java</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p>Just like a real cluster, this requires no other modules to have a dependency on the module being destroyed.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing_modules_with_circular_dependencies"><a class="anchor" href="#_testing_modules_with_circular_dependencies"></a>Testing modules with circular dependencies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Through module updates, you can deploy modules with mutual dependencies on each other. See <a href="module-dependencies.html#_circular_dependencies" class="page">this section</a> for details on how this works and how to create circular dependencies with an <code>InProcessCluster</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_unit_testing_a_custom_ramaoperation_with_mockoutputcollector"><a class="anchor" href="#_unit_testing_a_custom_ramaoperation_with_mockoutputcollector"></a>Unit testing a custom RamaOperation with MockOutputCollector</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You may want to unit test a <code>RamaOperation</code> implementation outside the context of a module. Rama provides <a href="https://redplanetlabs.com/javadoc/com/rpl/rama/test/MockOutputCollector.html">MockOutputCollector</a> for this purpose.</p>
</div>
<div class="paragraph">
<p>Hereâ€™s an example of usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockOutputCollectorExample</span> </span>{
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyOperation</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RamaOperation1</span>&lt;<span class="hljs-title">Integer</span>&gt; </span>{
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invoke</span><span class="hljs-params">(Integer n, OutputCollector collector)</span> </span>{
      collector.emitStream(<span class="hljs-string">"somestream"</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i &lt; n; i++) collector.emit(i);
      collector.emitStream(<span class="hljs-string">"somestream"</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>);
    }
  }

  <span class="hljs-meta">@Test</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">mockOutputCollectorTest</span><span class="hljs-params">()</span> </span>{
    MockOutputCollector collector = <span class="hljs-keyword">new</span> MockOutputCollector();
    <span class="hljs-keyword">new</span> MyOperation().invoke(<span class="hljs-number">2</span>, collector);

    List&lt;CapturedEmit&gt; emits = collector.getEmits();
    assertEquals(<span class="hljs-number">4</span>, emits.size());

    assertEquals(<span class="hljs-string">"somestream"</span>, emits.get(<span class="hljs-number">0</span>).getStreamName());
    assertEquals(Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>), emits.get(<span class="hljs-number">0</span>).getValues());

    assertNull(emits.get(<span class="hljs-number">1</span>).getStreamName());
    assertEquals(Arrays.asList(<span class="hljs-number">0</span>), emits.get(<span class="hljs-number">1</span>).getValues());

    assertNull(emits.get(<span class="hljs-number">2</span>).getStreamName());
    assertEquals(Arrays.asList(<span class="hljs-number">1</span>), emits.get(<span class="hljs-number">2</span>).getValues());

    assertEquals(<span class="hljs-string">"somestream"</span>, emits.get(<span class="hljs-number">3</span>).getStreamName());
    assertEquals(Arrays.asList(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>), emits.get(<span class="hljs-number">3</span>).getValues());

    Map expected = <span class="hljs-keyword">new</span> HashMap();
    expected.put(<span class="hljs-keyword">null</span>, Arrays.asList(Arrays.asList(<span class="hljs-number">0</span>), Arrays.asList(<span class="hljs-number">1</span>)));
    expected.put(<span class="hljs-string">"somestream"</span>, Arrays.asList(Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>), Arrays.asList(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>)));
    assertEquals(expected, collector.getEmitsByStream());
  }
}</code></pre>
<div class="source-toolbox"><span class="source-lang">java</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
<div class="paragraph">
<p><code>MockOutputCollector</code> captures emits and lets you assert on them afterwards. It provides two ways to look at those emits: <code>getEmits</code>, which returns all emits in the order in which they happened, and <code>getEmitsByStream</code> which returns a map from stream name to emitted values.</p>
</div>
<div class="paragraph">
<p>This example demonstrates both <code>getEmits</code> and <code>getEmitsByStream</code>. This is redundant in this case and only done for illustration. In a real unit test you would only use one of the two methods. When you care about the order of emits across stream names, you should use <code>getEmits</code>. Otherwise, using <code>getEmitsByStream</code> is probably slightly less code.</p>
</div>
<div class="paragraph">
<p>When <code>emit</code> is used within the <code>RamaOperation</code>, the captured stream name will be <code>null</code>. Since <code>emit</code> or <code>emitStream</code> can emit any number of values, emitted values are always captured as a list.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testpstate"><a class="anchor" href="#_testpstate"></a>TestPState</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Rama provides the class <a href="https://redplanetlabs.com/javadoc/com/rpl/rama/test/TestPState.html">TestPState</a> that can be used to write tests using PStates outside the context of modules. A <code>TestPState</code> can be used with <a href="https://redplanetlabs.com/javadoc/com/rpl/rama/Block.html#localTransform-java.lang.String-com.rpl.rama.Path-">localTransform</a> and <a href="https://redplanetlabs.com/javadoc/com/rpl/rama/Block.html#localSelect-java.lang.String-com.rpl.rama.Path-">localSelect</a> in dataflow code, and they can also be manipulated directly using the <code>select</code> and <code>transform</code> methods directly on the object. The latter methods are also a great way to experiment with the capabilities of paths.</p>
</div>
<div class="paragraph">
<p>Hereâ€™s an example of using <code>TestPState</code> to unit test a <a href="intermediate-dataflow.html#_macros" class="page">macro</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Block <span class="hljs-title">fooMacro</span><span class="hljs-params">(String pstateVar)</span> </span>{
  <span class="hljs-keyword">return</span> Block.localTransform(pstateVar, Path.key(<span class="hljs-string">"a"</span>).term(Ops.INC));
}

<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testPStateExampleTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
  <span class="hljs-keyword">try</span>(TestPState tp = TestPState.create(PState.mapSchema(String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Integer</span>.<span class="hljs-title">class</span>))) </span>{
    tp.transform(Path.key(<span class="hljs-string">"a"</span>).termVal(<span class="hljs-number">10</span>));
    assertEquals(<span class="hljs-number">10</span>, (<span class="hljs-keyword">int</span>) tp.selectOne(Path.key(<span class="hljs-string">"a"</span>)));

    Block.each(Ops.IDENTITY, tp).out(<span class="hljs-string">"$$p"</span>)
         .macro(fooMacro(<span class="hljs-string">"$$p"</span>))
         .execute();
    assertEquals(<span class="hljs-number">11</span>, (<span class="hljs-keyword">int</span>) tp.selectOne(Path.key(<span class="hljs-string">"a"</span>)));
  }
}</code></pre>
<div class="source-toolbox"><span class="source-lang">java</span><button class="copy-button" title="Copy to clipboard"><img src="../../_/img/octicons-16.svg#view-clippy" alt="copy icon" class="copy-icon"><span class="copy-toast">Copied!</span></button></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary"><a class="anchor" href="#_summary"></a>Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unit testing is one of the pillars upon which you build robust applications. This is why the Rama team has spent so much time making the testing of Rama applications as seamless as possible.</p>
</div>
<div class="paragraph">
<p>While this page covered unit testing, thatâ€™s not the end of the story when it comes to testing. Itâ€™s also important to run modules on a development cluster to do performance analysis to determine how many resources they will need. Performance tests can leverage Ramaâ€™s <a href="operating-rama.html#_activating_self_monitoring" class="page">self-monitoring</a> to determine max throughput and verify modules balance computation evenly across all workers. Profilers can also be useful for identifying micro-optimizations in module code to improve performance.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
</footer>
<script type="text/javascript" src="../../_/js/main.js"></script>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async="" src="../../_/js/vendor/highlight.js"></script>
  

<table cellspacing="0" cellpadding="0" role="presentation" class="gstl_50 gssb_c" style="width: 217px; display: none; top: 50px; left: 1048px; position: absolute;"><tbody><tr><td class="gssb_f"></td><td class="gssb_e" style="width: 100%;"></td></tr></tbody></table></body></html>